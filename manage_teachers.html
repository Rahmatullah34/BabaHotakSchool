<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† - Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© Ù„ÛŒØ³Ù‡</title>
    <!-- Ø¯ ÙÙˆÙ†Ù¼ÙˆÙ†Ùˆ Ø¯ Ú†Ù¼Ú© ÚšÙˆØ¯Ù„Ùˆ Ù„Ù¾Ø§Ø±Ù‡ Ø¨Ø¯Ù„ÙˆÙ† -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4A90E2; 
            --success: #2ecc71; 
            --danger: #e74c3c; 
            --dark: #2c3e50;
            --bg: #f4f7f6; 
        }
        
        body { 
            font-family: 'Noto Sans Arabic', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 10px; 
            direction: rtl; 
        }

        .container { 
            max-width: 1000px; 
            margin: auto; 
            background: white; 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.1); 
        }
        
        .photo-area { text-align: center; margin-bottom: 20px; grid-column: 1 / -1; }
        #preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 10px; background: #eee; }
        .file-btn { background: #34495e; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; display: inline-block; font-size: 13px; }

        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 12px; 
            background: #fdfdfd; 
            padding: 15px; 
            border-radius: 15px; 
            border: 1px solid #eee; 
        }

        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; padding: 10px; }
            .container { padding: 12px; }
            .filter-section { flex-direction: column; }
            
            table thead { display: none; }
            table, table tbody, table tr, table td { display: block; width: 100%; }
            table tr { margin-bottom: 12px; border: 1px solid #eee; border-radius: 12px; padding: 10px; background: #fff; }
            table td { text-align: right; padding: 6px 0; border: none; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #f0f0f0; }
            table td::before { content: attr(data-label); font-weight: bold; color: #666; font-size: 11px; }
            .t-img { width: 50px; height: 50px; }
        }

        label { font-size: 12px; color: #555; font-weight: bold; margin-bottom: 4px; display: block; }
        input, select { padding: 9px; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; text-align: center; outline: none; transition: 0.3s; font-family: inherit; font-size: 13px; }
        input:focus { border-color: var(--primary); }

        .btn-save { grid-column: 1 / -1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 5px; font-family: inherit; }

        .filter-section { margin-top: 25px; display: flex; gap: 8px; background: #eee; padding: 12px; border-radius: 12px; }
        .search-input { flex: 2; font-family: inherit; }

        .table-responsive { width: 100%; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; }
        th { background: #34495e; color: white; padding: 10px; font-size: 13px; text-align: center; }
        td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; font-size: 13px; }
        .t-img { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; }
        
        .status-active { color: var(--success); font-weight: bold; }
        .status-inactive { color: var(--danger); font-weight: bold; }
        
        .action-btns button { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; margin: 2px; font-size: 14px; }
        .view-btn { background: #3498db; color: white; }
        .del-btn { background: #e74c3c; color: white; }

        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; justify-content: center; 
            align-items: center; z-index: 9999; padding: 20px;
        }
        .profile-card { 
            background: white; width: 100%; max-width: 350px; border-radius: 20px; 
            overflow: hidden; position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .card-header { background: var(--primary); height: 90px; position: relative; }
        .card-close { position: absolute; left: 15px; top: 15px; color: white; font-size: 26px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.1); border-radius: 50%; }
        .card-photo-container { margin-top: -55px; text-align: center; position: relative; }
        .card-photo { width: 110px; height: 110px; border-radius: 50%; border: 4px solid white; object-fit: cover; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card-body { padding: 15px 20px 25px 20px; text-align: center; }
        .card-name { font-size: 20px; margin: 8px 0 4px 0; color: var(--dark); font-weight: bold; }
        .card-tag { display: inline-block; padding: 4px 14px; background: #e3f2fd; color: var(--primary); border-radius: 12px; font-size: 12px; font-weight: bold; margin-bottom: 18px; }
        .card-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-box { background: #fafafa; padding: 10px; border-radius: 12px; border: 1px solid #f0f0f0; }
        .info-label { display: block; font-size: 10px; color: #999; margin-bottom: 2px; }
        .info-value { display: block; font-size: 12px; color: #333; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="color:var(--primary); margin:0;">ğŸ‘¥ Ø¯ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†Ùˆ Ø§Ùˆ ÚšÙˆÙˆÙ†Ú©Ùˆ Ø«Ø¨Øª</h2>
        <button onclick="location.href='admin_dashboard.html'" style="padding:6px 15px; border-radius:8px; cursor:pointer; border:1px solid #ddd; background:white; font-family:inherit;">â¬…ï¸ Ø´Ø§ØªÙ‡</button>
    </div>

    <div class="form-grid">
        <div class="photo-area">
            <img id="preview" src="https://via.placeholder.com/100" alt="Ù¾Ø±ÙˆÙØ§ÛŒÙ„"> <br>
            <label class="file-btn">
                ğŸ“¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³
                <input type="file" id="tPhotoFile" accept="image/*" style="display:none" onchange="convertImage(this)">
            </label>
            <input type="hidden" id="tPhotoBase64">
        </div>

        <div><label>Ø¨Ø´Ù¾Ú“ Ù†ÙˆÙ…</label><input type="text" id="tName"></div>
        <div><label>ØªØ®Ù„Øµ</label><input type="text" id="tLname"></div>
        <div><label>Ø¯ Ù¾Ù„Ø§Ø± Ù†ÙˆÙ…</label><input type="text" id="tFname"></div>
        <div><label>ØªØ®ØµØµ</label><input type="text" id="tSubject"></div>

        <div>
            <label>Ø²Ø¯Ù‡ Ú©Ú“Û</label>
            <select id="tEdu">
                <option value="Ø¨Ú©Ù„ÙˆØ±ÛŒØ§">Ø¨Ú©Ù„ÙˆØ±ÛŒØ§</option>
                <option value="Û±Û´ Ù¾Ø§Ø³">Û±Û´ Ù¾Ø§Ø³</option>
                <option value="Ù„ÛŒØ³Ø§Ù†Ø³">Ù„ÛŒØ³Ø§Ù†Ø³</option>
                <option value="Ù…Ø§Ø³ØªØ±">Ù…Ø§Ø³ØªØ±</option>
            </select>
        </div>

        <div><label>Ø¯ ØªÙ‚Ø±Ø± Ù†ÛÙ¼Ù‡</label><input type="date" id="tJoinDate"></div>
        <div><label>Ù…Ú©ØªÙˆØ¨ Ù†Ù…Ø¨Ø±</label><input type="text" id="tOrderNo"></div>

        <div>
            <label>Ø±ÙˆÙ„ (Role)</label>
            <select id="tRole">
                <option value="ÚšÙˆÙˆÙ†Ú©ÛŒ">ÚšÙˆÙˆÙ†Ú©ÛŒ</option>
                <option value="Ù…Ø¯ÛŒØ±">Ù…Ø¯ÛŒØ±</option>
                <option value="Ø³Ø±Ù…Ø¹Ù„Ù…">Ø³Ø±Ù…Ø¹Ù„Ù…</option>
                <option value="Ø§Ø¯Ø§Ø±ÙŠ">Ø§Ø¯Ø§Ø±ÙŠ</option>
            </select>
        </div>

        <div>
            <label>Ù…Ø³Ø¤Ù„ Ù¼ÙˆÙ„Ú«ÛŒ (Grade)</label>
            <select id="tGrade">
                <option value="Ù†Ø´ØªÙ‡">Ù†Ø´ØªÙ‡</option>
                <option value="1">Ø§ÙˆÙ„</option><option value="2">Ø¯ÙˆÙ‡Ù…</option><option value="3">Ø¯Ø±ÛŒÙ…</option>
                <option value="4">Ú…Ù„ÙˆØ±Ù…</option><option value="5">Ù¾Ù†ÚÙ…</option><option value="6">Ø´Ù¾Ú–Ù…</option>
                <option value="7">Ø§ÙˆÙˆÙ…</option><option value="8">Ø§ØªÙ…</option><option value="9">Ù†Ù‡Ù…</option>
                <option value="10">Ù„Ø³Ù…</option><option value="11">ÛŒÙˆÙˆÙ„Ø³Ù…</option><option value="12">Ø¯ÙˆÙ„Ø³Ù…</option>
            </select>
        </div>

        <div>
            <label>Ú©Ù¼Ú«ÙˆØ±ÙŠ (Section)</label>
            <select id="tSection">
                <option value="Ù†Ø´ØªÙ‡">Ù†Ø´ØªÙ‡</option>
                <option value="A">Ø§Ù„Ù (A)</option>
                <option value="B">Ø¨ (B)</option>
                <option value="C">Ø¬ (C)</option>
                <option value="D">Ø¯ (D)</option>
            </select>
        </div>

        <div><label>ÛŒÙˆØ²Ø± Ù†ÛŒÙ… (Username)</label><input type="text" id="tUser"></div>
        <div><label>Ù¾Ù¼ Ù†ÙˆÙ… (Password)</label><input type="text" id="tPass"></div>
        <div><label>Ù…ÙˆØ¨Ø§ÛŒÙ„</label><input type="text" id="tPhone"></div>
        <div><label>Ù…Ø¹Ø§Ø´</label><input type="number" id="tSalary"></div>
        <div>
            <label>Ø­Ø§Ù„Øª</label>
            <select id="tStatus">
                <option value="Active">ÙØ¹Ø§Ù„</option>
                <option value="Inactive">ØºÛŒØ±ÙØ¹Ø§Ù„</option>
            </select>
        </div>

        <button class="btn-save" onclick="saveToFirebase()">ğŸ’¾ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®ÙˆÙ†Ø¯ÙŠ Ú©Ú“Ù‡</button>
    </div>

    <div class="filter-section">
        <input type="text" id="searchName" class="search-input" placeholder="ğŸ” Ù„Ù¼ÙˆÙ†..." oninput="filterTable()">
        <select id="filterRole" onchange="filterTable()" style="flex:1; font-family: inherit;">
            <option value="">Ù¼ÙˆÙ„ Ø±ÙˆÙ„ÙˆÙ†Ù‡</option>
            <option value="ÚšÙˆÙˆÙ†Ú©ÛŒ">ÚšÙˆÙˆÙ†Ú©ÛŒ</option>
            <option value="Ù…Ø¯ÛŒØ±">Ù…Ø¯ÛŒØ±</option>
        </select>
    </div>

    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Ø¹Ú©Ø³</th>
                    <th>Ù†ÙˆÙ… Ø§Ùˆ Ù¾Ù„Ø§Ø±</th>
                    <th>Ù…Ú©ØªÙˆØ¨ / Ø±ÙˆÙ„</th>
                    <th>Ø­Ø§Ù„Øª</th>
                    <th>Ø¹Ù…Ù„</th>
                </tr>
            </thead>
            <tbody id="teacherTableBody"></tbody>
        </table>
    </div>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="event.target == this ? closeProfile() : null">
    <div class="profile-card">
        <div class="card-header"><span class="card-close" onclick="closeProfile()">Ã—</span></div>
        <div class="card-photo-container"><img id="cardPhoto" src="" class="card-photo"></div>
        <div class="card-body">
            <div id="cardName" class="card-name"></div>
            <div id="cardTag" class="card-tag"></div>
            <div class="card-info" id="cardInfoContent"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-save" style="background:#34495e; font-size:13px; flex:1;" onclick="window.print()">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
                <button class="btn-save" style="background:var(--danger); font-size:13px; flex:1;" onclick="closeProfile()">Ø¨Ù†Ø¯ÙˆÙ„</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
        authDomain: "babahotakschool.firebaseapp.com",
        projectId: "babahotakschool",
        storageBucket: "babahotakschool.firebasestorage.app",
        messagingSenderId: "12958892996",
        appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let staffData = [];

    // Ø¯ Ø¹Ú©Ø³ Ø¯ Ø­Ø¬Ù… Ú©Ù…ÙˆÙ„Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´ÙˆÛ ÙÙ†Ú©Ø´Ù†
    function convertImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // Ú©ÙˆÚ†Ù†ÛŒ Ø³Ø§ÛŒØ² (Û±Û¸Û° Ù¾ÛŒÚ©Ø³Ù„) Ø¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¯ Ø³Ø±Ø¹Øª Ù„Ù¾Ø§Ø±Ù‡
                    const size = 180;
                    canvas.width = size; canvas.height = size;
                    ctx.drawImage(img, 0, 0, size, size);
                    // Ú©ÛŒÙÛŒØª Û°.Û¶ ØªÙ‡ Ø±Ø§ÚšÚ©ØªÙ‡ Ú©ÙˆÙ„ ØªØ±Ú…Ùˆ Ø­Ø¬Ù… Ø®ÙˆØ±Ø§ Ú©Ù… Ø´ÙŠ
                    const base64 = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('preview').src = base64;
                    document.getElementById('tPhotoBase64').value = base64;
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveToFirebase() {
        const btn = document.querySelector('.btn-save');
        const data = {
            photo: document.getElementById('tPhotoBase64').value || "",
            name: document.getElementById('tName').value,
            lname: document.getElementById('tLname').value,
            fname: document.getElementById('tFname').value,
            subject: document.getElementById('tSubject').value,
            edu: document.getElementById('tEdu').value,
            joinDate: document.getElementById('tJoinDate').value,
            orderNo: document.getElementById('tOrderNo').value,
            role: document.getElementById('tRole').value,
            grade: document.getElementById('tGrade').value,
            section: document.getElementById('tSection').value,
            username: document.getElementById('tUser').value,
            password: document.getElementById('tPass').value,
            phone: document.getElementById('tPhone').value,
            salary: document.getElementById('tSalary').value,
            status: document.getElementById('tStatus').value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if(!data.name || !data.username || !data.password) return alert("Ù†ÙˆÙ…ØŒ ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ø§Ùˆ Ù¾Ø§Ø³ÙˆØ±Ú‰ Ø§Ú“ÛŒÙ† Ø¯ÙŠ!");
        
        btn.disabled = true;
        btn.innerText = "ØµØ¨Ø± ÙˆÚ©Ú“Ø¦...";

        try {
            await db.collection("babaTeachers").add(data);
            alert("âœ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®ÙˆÙ†Ø¯ÙŠ Ø´ÙˆÙ„!");
            location.reload();
        } catch (e) { 
            alert("Ø®Ø·Ø§: " + e.message); 
            btn.disabled = false;
        }
    }

    function filterTable() {
        const nameVal = document.getElementById('searchName').value.toLowerCase();
        const roleVal = document.getElementById('filterRole').value;
        renderTable(staffData.filter(t => 
            (t.name.toLowerCase().includes(nameVal) || (t.orderNo && t.orderNo.toLowerCase().includes(nameVal))) &&
            (roleVal === "" || t.role === roleVal)
        ));
    }

    function renderTable(data) {
        const tbody = document.getElementById('teacherTableBody');
        tbody.innerHTML = data.map(t => {
            const statusClass = t.status === 'Active' ? 'status-active' : 'status-inactive';
            return `
                <tr>
                    <td data-label="Ø¹Ú©Ø³"><img src="${t.photo || 'https://via.placeholder.com/45'}" class="t-img"></td>
                    <td data-label="Ù†ÙˆÙ… Ø§Ùˆ Ù¾Ù„Ø§Ø±"><b>${t.name} ${t.lname || ''}</b><br><small>${t.fname}</small></td>
                    <td data-label="Ù…Ú©ØªÙˆØ¨ / Ø±ÙˆÙ„">${t.orderNo || '---'}<br><small>${t.role} (${t.grade}-${t.section})</small></td>
                    <td data-label="Ø­Ø§Ù„Øª" class="${statusClass}">${t.status == 'Active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}</td>
                    <td data-label="Ø¹Ù…Ù„" class="action-btns">
                        <button class="view-btn" onclick="showProfile('${t.id}')">ğŸ‘ï¸</button>
                        <button class="del-btn" onclick="deleteT('${t.id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
        }).join('');
    }

    db.collection("babaTeachers").orderBy("createdAt", "desc").onSnapshot(snap => {
        staffData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTable(staffData);
    });

    function showProfile(id) {
        const t = staffData.find(x => x.id === id);
        document.getElementById('cardPhoto').src = t.photo || 'https://via.placeholder.com/100';
        document.getElementById('cardName').innerText = t.name + " " + (t.lname || "");
        document.getElementById('cardTag').innerText = t.role + " - Ù¼ÙˆÙ„Ú«ÛŒ (" + t.grade + t.section + ")";
        
        const infoFields = [
            { label: "Ø¯ Ù¾Ù„Ø§Ø± Ù†ÙˆÙ…", value: t.fname },
            { label: "Ù…ÙˆØ¨Ø§ÛŒÙ„", value: t.phone },
            { label: "ÛŒÙˆØ²Ø±Ù†ÛŒÙ…", value: t.username },
            { label: "Ù¾Ø§Ø³ÙˆØ±Ú‰", value: t.password },
            { label: "Ù…Ø¹Ø§Ø´", value: t.salary + " AFN" },
            { label: "Ù…Ú©ØªÙˆØ¨ Ù†Ù…Ø¨Ø±", value: t.orderNo }
        ];

        document.getElementById('cardInfoContent').innerHTML = infoFields.map(f => `
            <div class="info-box"><span class="info-label">${f.label}</span><span class="info-value">${f.value || '---'}</span></div>
        `).join('');
        document.getElementById('modalOverlay').style.display = 'flex';
    }

    function closeProfile() { document.getElementById('modalOverlay').style.display = 'none'; }
    async function deleteT(id) { if(confirm("Ø§ÛŒØ§ Ø¯Ø§ Ú©Ø§Ø±Ù…Ù†Ø¯ Ø­Ø°Ù Ø´ÙŠØŸ")) await db.collection("babaTeachers").doc(id).delete(); }
</script>

</body>
</html>

