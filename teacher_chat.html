<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ú†Ù¼ - Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© Ù„ÛŒØ³Ù‡</title>
  <style>
    :root {
      --primary: #3498db;
      --teacher: #e74c3c;
      --admin: #2ecc71;
      --bg: #f5f7fa;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; 
      padding: 0; 
      direction: rtl; 
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .chat-container {
      width: 95%;
      max-width: 500px;
      height: 90vh;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
    }
    
    /* Ø³Ø±Ø¨Ø±Ø®Ù‡ */
    .chat-header {
      background: linear-gradient(135deg, var(--primary) 0%, #2980b9 100%);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    .back-btn {
      position: absolute;
      right: 15px;
      top: 15px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    /* Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø³ÛŒÙ…Ù‡ */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    /* Ù¾ÛŒØºØ§Ù… Ø³Ù¼Ø§ÛŒÙ„ÙˆÙ†Ù‡ */
    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      line-height: 1.5;
      word-wrap: break-word;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .msg-me {
      align-self: flex-end;
      background: var(--teacher);
      color: white;
      border-bottom-right-radius: 5px;
      box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
    }
    
    .msg-admin {
      align-self: flex-start;
      background: var(--admin);
      color: white;
      border-bottom-left-radius: 5px;
      box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
    }
    
    .msg-group {
      align-self: center;
      background: #f1c40f;
      color: #333;
      max-width: 90%;
      font-size: 13px;
      padding: 10px 15px;
      border-radius: 12px;
      text-align: center;
    }
    
    /* Ø¯ Ø§Ø³ØªÙˆÙ„Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
    .sender-name {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    
    .msg-time {
      font-size: 10px;
      color: rgba(255,255,255,0.7);
      display: block;
      text-align: left;
      margin-top: 5px;
    }
    
    /* Ø¯ Ø§Ù†Ù¾Ù¼ Ø³ÛŒÙ…Ù‡ */
    .input-area {
      padding: 15px;
      background: white;
      display: flex;
      gap: 10px;
      border-top: 1px solid #e1e8ed;
      align-items: center;
    }
    
    input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #e1e8ed;
      border-radius: 12px;
      outline: none;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    input[type="text"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Ø¯ ÙØ§ÛŒÙ„ Ø§ÛŒÚ©ÙˆÙ† */
    .file-btn {
      background: #9b59b6;
      padding: 12px;
      border-radius: 12px;
    }
    
    /* Ø¯ Ú†Ù¼ Ù¼Ø§ÛŒÙ¾ Ø³Ù„ÛŒÚ©Ù¼Ø± */
    .chat-type-selector {
      display: flex;
      background: #ecf0f1;
      border-radius: 12px;
      padding: 5px;
      margin: 0 20px 15px 20px;
    }
    
    .chat-type-btn {
      flex: 1;
      padding: 10px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .chat-type-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Ø®Ø§Ù„ÙŠ Ø­Ø§Ù„Øª */
    .empty-state {
      text-align: center;
      color: #95a5a6;
      padding: 40px 20px;
    }
    
    .empty-state-icon {
      font-size: 60px;
      margin-bottom: 15px;
      display: block;
    }
    
    /* Ø¯ ÙØ§ÛŒÙ„ Ù„Ù†Ú‰ÛŒØ² */
    .file-summary {
      background: rgba(255,255,255,0.2);
      padding: 8px 12px;
      border-radius: 8px;
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>

<div class="chat-container">
  <!-- Ø³Ø±Ø¨Ø±Ø®Ù‡ -->
  <div class="chat-header">
    <button class="back-btn" onclick="goBack()">â¬…ï¸ Ø´Ø§ØªÙ‡</button>
    <h3 style="margin:0; font-size: 18px;">ğŸ’¬ Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ú†Ù¼</h3>
    <p style="margin:5px 0 0; font-size: 12px; opacity: 0.9;" id="teacherName">Ø§Ø³ØªØ§Ø¯: ...</p>
  </div>
  
  <!-- Ø¯ Ú†Ù¼ Ú‰ÙˆÙ„ Ù¼Ø§Ú©ÙˆÙ†Ú©ÛŒ -->
  <div class="chat-type-selector">
    <div class="chat-type-btn active" id="groupChatBtn" onclick="switchChatType('group')">
      ğŸ“¢ Ø¹Ù…ÙˆÙ…ÙŠ
    </div>
    <div class="chat-type-btn" id="privateChatBtn" onclick="switchChatType('private')">
      ğŸ‘¤ Ù…Ø¯ÛŒØ± Ø³Ø±Ù‡
    </div>
  </div>
  
  <!-- Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø³ÛŒÙ…Ù‡ -->
  <div class="messages-area" id="chatBox">
    <div class="empty-state">
      <span class="empty-state-icon">ğŸ’¬</span>
      <p>Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡ Ø±Ø§ÙˆØ³ØªÙ„ Ú©ÛÚ–ÙŠ...</p>
    </div>
  </div>
  
  <!-- Ø¯ Ø§Ù†Ù¾Ù¼ Ø³ÛŒÙ…Ù‡ -->
  <div class="input-area">
    <input type="text" id="msgInput" placeholder="Ù¾ÛŒØºØ§Ù… ÙˆÙ„ÛŒÚ©Ø¦..." onkeypress="handleEnter(event)">
    <label for="teacherFileInput" style="cursor:pointer;">
      <button class="file-btn">ğŸ“</button>
    </label>
    <input type="file" id="teacherFileInput" style="display:none" onchange="sendFile(event)">
    <button id="sendTeacherBtn" onclick="sendTeacherMessage()">ğŸ“¤</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
    authDomain: "babahotakschool.firebaseapp.com",
    projectId: "babahotakschool",
    storageBucket: "babahotakschool.firebasestorage.app",
    messagingSenderId: "12958892996",
    appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  let currentChatType = 'group'; // 'group' ÛŒØ§ 'private'
  let teacherId = null;
  let teacherName = "ÚšÙˆÙˆÙ†Ú©ÛŒ";
  
  // ==================== Ù¾ÛŒÙ„ Ú©ÙˆÙ„ ====================
  window.onload = function() {
    // Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ±Ù„Ø§Ø³Ù‡ Ú©ÙˆÙ„
    teacherId = localStorage.getItem('userId');
    teacherName = localStorage.getItem('userName') || "ÚšÙˆÙˆÙ†Ú©ÛŒ";
    
    if (!teacherId) {
      alert("ØªØ§Ø³Ùˆ Ù†Ù†ÙˆØªÙ„ Ù†Ù‡ ÛŒØ§Ø³Øª!");
      window.location.href = "login.html";
      return;
    }
    
    // Ø¯ Ù†ÙˆÙ… ØªØ§Ø²Ù‡ Ú©ÙˆÙ„
    document.getElementById('teacherName').innerText = `Ø§Ø³ØªØ§Ø¯: ${teacherName}`;
    
    // Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø±Ø§ÙˆØ³ØªÙ„
    loadTeacherChat();
    
    // Ø¯ Ù†ÙˆÙˆ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ú…Ø§Ø±Ù†Ù‡
    checkForNewMessages();
  };
  
  // ==================== Ø¯ Ú†Ù¼ Ú‰ÙˆÙ„ Ø¨Ø¯Ù„ÙˆÙ„ ====================
  function switchChatType(type) {
    currentChatType = type;
    
    // Ø¯ Ø¨Ù¼Ù†ÙˆÙ†Ùˆ ÙØ¹Ø§Ù„ Ø­Ø§Ù„Øª
    document.getElementById('groupChatBtn').classList.toggle('active', type === 'group');
    document.getElementById('privateChatBtn').classList.toggle('active', type === 'private');
    
    // Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø¨ÛŒØ§ Ø±Ø§ÙˆØ³ØªÙ„
    loadTeacherChat();
  }
  
  // ==================== Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø±Ø§ÙˆØ³ØªÙ„ ====================
  function loadTeacherChat() {
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '<div class="empty-state"><span class="empty-state-icon">â³</span><p>Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡ Ø±Ø§ÙˆØ³ØªÙ„ Ú©ÛÚ–ÙŠ...</p></div>';
    
    let query;
    
    if (currentChatType === 'group') {
      // Ø¯ Ú«Ø±ÙˆÙ¾ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡
      query = db.collection("schoolChat")
        .where("receiverId", "==", "admin-group")
        .orderBy("timestamp", "asc");
    } else {
      // Ø¯ Ø®ØµÙˆØµÙŠ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡
      query = db.collection("schoolChat")
        .where(function() {
          return firebase.firestore.FieldPath.documentId() in [
            ["senderId", "==", teacherId],
            ["receiverId", "==", teacherId]
          ];
        })
        .orderBy("timestamp", "asc");
    }
    
    query.onSnapshot(snapshot => {
      chatBox.innerHTML = "";
      
      if (snapshot.empty) {
        chatBox.innerHTML = `
          <div class="empty-state">
            <span class="empty-state-icon">ğŸ’¬</span>
            <p>Ù„Ø§ ØªØ± Ø§ÙˆØ³Ù‡ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡ Ù†Ø´ØªÙ‡.</p>
            <p style="font-size:12px;">Ù„ÙˆÙ…Ú“ÛŒ Ù¾ÛŒØºØ§Ù… ÙˆÙ„ÛŒÚ©Ø¦!</p>
          </div>
        `;
        return;
      }
      
      snapshot.forEach(doc => {
        const msg = doc.data();
        displayTeacherMessage(msg);
      });
      
      chatBox.scrollTop = chatBox.scrollHeight;
      
      // Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø¯ Ù„ÛŒØ¯Ù„Ùˆ Ù†ÚšÙ‡ Ú©ÙˆÙ„
      markTeacherMessagesAsRead();
    }, error => {
      console.error("Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø±Ø§ÙˆØ³ØªÙ„Ùˆ Ø³ØªÙˆÙ†Ø²Ù‡:", error);
      chatBox.innerHTML = `
        <div class="empty-state">
          <span class="empty-state-icon">âŒ</span>
          <p>Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ù¾Ù‡ Ø±Ø§ÙˆØ³ØªÙ„Ùˆ Ú©Û Ø³ØªÙˆÙ†Ø²Ù‡ Ø±Ø§ØºÙ„Ù‡.</p>
          <button onclick="loadTeacherChat()" style="margin-top:10px; padding:8px 15px;">Ø¨ÛŒØ§ Ù‡Ú…Ù‡ ÙˆÚ©Ú“Ø¦</button>
        </div>
      `;
    });
  }
  
  // ==================== Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù¾ÛŒØºØ§Ù… ÚšÙˆØ¯Ù„ ====================
  function displayTeacherMessage(msg) {
    const chatBox = document.getElementById('chatBox');
    const isMyMessage = msg.senderId === teacherId;
    const isGroupMessage = msg.receiverId === "admin-group";
    
    const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ps-AF', {
      hour: '2-digit',
      minute: '2-digit'
    }) : "Ù†ÙˆÙŠ";
    
    let messageClass = '';
    let senderName = '';
    
    if (isGroupMessage && currentChatType === 'group') {
      messageClass = 'msg-group';
      senderName = msg.senderName || (isMyMessage ? 'ØªØ§Ø³Ùˆ' : 'Ù…Ø¯ÛŒØ±');
    } else if (isMyMessage) {
      messageClass = 'msg-me';
      senderName = 'ØªØ§Ø³Ùˆ';
    } else {
      messageClass = 'msg-admin';
      senderName = msg.senderName || 'Ù…Ø¯ÛŒØ±';
    }
    
    let messageContent = '';
    
    if (msg.text) {
      messageContent = msg.text;
    } else if (msg.fileUrl) {
      messageContent = `
        <div>ğŸ“ ÙØ§ÛŒÙ„</div>
        <div class="file-summary">
          <span>${msg.fileName || 'ÙØ§ÛŒÙ„'}</span>
          <a href="${msg.fileUrl}" target="_blank" style="color:inherit; text-decoration:underline;">
            Ù„ÛŒØ¯Ù„
          </a>
        </div>
      `;
    }
    
    // Ú©Ù‡ ÚÙˆØ§Ø¨ ÙˆÙŠ
    let replySection = '';
    if (msg.replyText) {
      replySection = `
        <div style="background:rgba(255,255,255,0.2); padding:5px 10px; border-radius:8px; margin-bottom:5px; font-size:12px;">
          â†ªï¸ ${msg.replyText.substring(0, 50)}${msg.replyText.length > 50 ? '...' : ''}
        </div>
      `;
    }
    
    const messageHTML = `
      <div class="msg ${messageClass}">
        <span class="sender-name">${senderName}</span>
        ${replySection}
        ${messageContent}
        <span class="msg-time">${time}</span>
      </div>
    `;
    
    chatBox.innerHTML += messageHTML;
  }
  
  // ==================== Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù¾ÛŒØºØ§Ù… Ø§Ø³ØªÙˆÙ„ ====================
  async function sendTeacherMessage() {
    const text = document.getElementById('msgInput').value.trim();
    const fileInput = document.getElementById('teacherFileInput');
    
    if (!text && fileInput.files.length === 0) {
      alert("Ù…Ù‡Ø±Ø¨Ø§Ù†ÙŠ ÙˆÚ©Ú“Ø¦ Ù¾ÛŒØºØ§Ù… ÛŒØ§ ÙØ§ÛŒÙ„ Ø¯Ø§Ø®Ù„ Ú©Ú“Ø¦!");
      return;
    }
    
    const sendBtn = document.getElementById('sendTeacherBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = "â³";
    
    try {
      let fileUrl = '';
      let fileName = '';
      
      // Ú©Ù‡ ÙØ§ÛŒÙ„ ÙˆÙŠ
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const storageRef = storage.ref(`teacher-files/${teacherId}/${Date.now()}_${file.name}`);
        const uploadTask = await storageRef.put(file);
        fileUrl = await uploadTask.ref.getDownloadURL();
        fileName = file.name;
        fileInput.value = '';
      }
      
      const messageData = {
        senderId: teacherId,
        senderName: teacherName,
        text: text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        readBy: [teacherId],
        chatType: currentChatType,
        teacherId: teacherId
      };
      
      if (currentChatType === 'group') {
        messageData.receiverId = "admin-group";
        messageData.deliveredTo = ["admin", teacherId];
      } else {
        messageData.receiverId = "admin";
        messageData.deliveredTo = ["admin"];
      }
      
      if (fileUrl) {
        messageData.fileUrl = fileUrl;
        messageData.fileName = fileName;
      }
      
      await db.collection("schoolChat").add(messageData);
      
      // Ø¯ Ø§Ù†Ù¾Ù¼ Ù¾Ø§Ú©ÙˆÙ„
      document.getElementById('msgInput').value = '';
      
    } catch (error) {
      console.error("Ø¯ Ù¾ÛŒØºØ§Ù… Ø³ØªÙˆÙ†Ø²Ù‡:", error);
      alert("Ù¾ÛŒØºØ§Ù… ÙˆÙ†Ù‡ Ø§Ø³ØªÙˆÙ„ Ø´Ùˆ: " + error.message);
    } finally {
      sendBtn.disabled = false;
      sendBtn.innerHTML = "ğŸ“¤";
    }
  }
  
  // ==================== Ø¯ ÙØ§ÛŒÙ„ Ø§Ø³ØªÙˆÙ„ ====================
  async function sendFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const sendBtn = document.getElementById('sendTeacherBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = "ğŸ“";
    
    try {
      await sendTeacherMessage();
    } finally {
      sendBtn.disabled = false;
      sendBtn.innerHTML = "ğŸ“¤";
    }
  }
  
  // ==================== Ø¯ Enter Ú©Ù„ÛŒØ¯ Ù…Ù„Ø§ØªÚ“ ====================
  function handleEnter(event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      sendTeacherMessage();
    }
  }
  
  // ==================== Ø¯ Ù†ÙˆÛŒÙˆ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ú…Ø§Ø±Ù†Ù‡ ====================
  function checkForNewMessages() {
    // Ù¾Ù‡ Ù¾Ø³Û Ú©Û Ø¯ Ù†ÙˆÙ¼ÛŒÙÛŒÚ©ÛŒØ´Ù† Ù„Ù¾Ø§Ø±Ù‡ Ú©Ø§Ø±ÙˆÙ„ Ú©ÛÚ–ÙŠ
  }
  
  // ==================== Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø¯ Ù„ÛŒØ¯Ù„Ùˆ Ù†ÚšÙ‡ Ú©ÙˆÙ„ ====================
  async function markTeacherMessagesAsRead() {
    if (!teacherId) return;
    
    try {
      const snapshot = await db.collection("schoolChat")
        .where("receiverId", "==", teacherId)
        .where("readBy", "not-in", [[teacherId]])
        .get();
      
      const batch = db.batch();
      snapshot.forEach(doc => {
        const readBy = doc.data().readBy || [];
        if (!readBy.includes(teacherId)) {
          readBy.push(teacherId);
          batch.update(doc.ref, { readBy: readBy });
        }
      });
      
      if (snapshot.size > 0) {
        await batch.commit();
      }
    } catch (error) {
      console.error("Ø¯ Ù„ÛŒØ¯Ù„Ùˆ Ù†ÚšÛ Ø³ØªÙˆÙ†Ø²Ù‡:", error);
    }
  }
  
  // ==================== Ø¯ Ø´Ø§ØªÙ‡ ØªÚ« ====================
  function goBack() {
    window.location.href = "teacher_dashboard.html";
  }
</script>

</body>
</html>