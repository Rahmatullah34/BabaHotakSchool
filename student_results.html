<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø²Ù…Ø§ Ù†Ù…Ø±Û - Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© Ù„ÛŒØ³Ù‡</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Tahoma', sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; direction: rtl; }
        .result-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 600px; margin: auto; border-top: 5px solid #27ae60; }
        
        /* Ø¯ Ø®Ø¨Ø±ØªÛŒØ§ Ø³Ù¼Ø§ÛŒÙ„ */
        #notice-box { display: none; background: #fff9c4; padding: 15px; border-right: 5px solid #fbc02d; border-radius: 10px; max-width: 600px; margin: 0 auto 15px auto; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .st-bio { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #27ae60; color: white; }
        .summary-box { background: #e8f5e9; padding: 15px; border-radius: 10px; font-weight: bold; border-right: 5px solid #27ae60; }
        .loading { text-align: center; font-weight: bold; color: #666; padding: 50px; font-size: 18px; }
        .fail { color: red; }
        .pass { color: green; }
        .lock-text { color: #e74c3c; font-size: 11px; font-weight: normal; }
    </style>
</head>
<body>

<div id="notice-box">
    <strong>ğŸ“¢ Ø®Ø¨Ø±ØªÛŒØ§:</strong> <span id="notice-msg"></span>
    <div style="font-size: 10px; color: #888; margin-top: 5px;" id="notice-date"></div>
</div>

<div id="loading" class="loading">Ø³ØªØ§Ø³Ùˆ Ù†Ù…Ø±Û Ù„Ù‡ Ø³ÛŒØ³Ù¼Ù… Ú…Ø®Ù‡ Ø±Ø§ÙˆÚ“Ù„ Ú©ÛÚ–ÙŠ...</div>

<div class="result-card" id="main-card" style="display:none;">
    <div class="header">
        <h3 style="margin:0; color:#2c3e50;">Ú«Ø±Ø§Ù†Ù‡ Ø²Ø¯Ù‡ Ú©ÙˆÙˆÙ†Ú©ÛŒÙ‡ Ø³ØªØ§Ø³Ùˆ Ø¯ (Û±Û´Û°Û´) Ú©Ø§Ù„ Ù†Ù…Ø±Û Ø¯ÙŠ.</h3>
        <p style="margin:5px 0; color:#27ae60; font-weight: bold;">Ø¨Ø§Ø¨Ø§Ù‡ÙˆØªÚ© Ø¯ÙˆÛŒÙ… Ù†Ù…Ø¨Ø± Ø¹Ø§Ù„ÙŠ Ù„ÛŒØ³Ù‡</p>
    </div>

    <div class="st-bio">
        <div><strong>Ù†ÙˆÙ…:</strong> <span id="v-name"></span></div>
        <div><strong>Ù¾Ù„Ø§Ø± Ù†ÙˆÙ…:</strong> <span id="v-father"></span></div>
        <div><strong>Ø§Ø³Ø§Ø³ Ù†Ù…Ø¨Ø±:</strong> <span id="v-id" style="color:red; font-weight: bold;"></span></div>
        <div><strong>Ù†ÛŒÚ©Ù‡ Ù†ÙˆÙ…:</strong> <span id="v-grand"></span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ù…Ø¶Ù…ÙˆÙ†</th>
                <th>Û´.Ûµ Ù…ÛŒØ§Ø´ØªÙ†Û</th>
                <th>Ú©Ù„Ù†Û Ù†Ù…Ø±Û</th>
                <th>Ù…Ø¬Ù…ÙˆØ¹Ù‡</th>
            </tr>
        </thead>
        <tbody id="v-marks-body"></tbody>
    </table>

    <div class="summary-box">
        <div id="v-result-text">Ù¾Ø§ÛŒÙ„Ù‡: <span id="v-result">---</span></div>
        <div>Ø¹Ù…ÙˆÙ…ÙŠ Ø¯Ø±Ø¬Ù‡: <span id="v-grade">---</span></div>
        <div>Ø¯ Ø­Ø§Ø¶Ø±Û Ø³ÙˆØ¨: <span id="v-att">0</span> ÙˆØ±ÚÛ</div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
        projectId: "babahotakschool",
        appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
    };
    firebase.initializeApp(firebaseConfig);
    const fs = firebase.firestore();

    const studentId = localStorage.getItem('userId');

    // Û±. Ø¯ Ø®Ø¨Ø±ØªÛŒØ§ Ø±Ø§ÙˆÚ“Ù„
    async function loadNotice() {
        const snap = await fs.collection("systemSettings").doc("schoolNotice").get();
        if(snap.exists) {
            document.getElementById('notice-msg').innerText = snap.data().message;
            document.getElementById('notice-date').innerText = "Ù†ÛÙ¼Ù‡: " + snap.data().date;
            document.getElementById('notice-box').style.display = 'block';
        }
    }

    // Û². Ø¯ Ù†Ù…Ø±Ùˆ Ø±Ø§ÙˆÚ“Ù„
    async function loadMyResults() {
        if (!studentId) {
            document.getElementById('loading').innerHTML = "âš ï¸ ØªØ§Ø³Ùˆ Ù„Ø§Ú« Ø§Ù† Ù†Ù‡ ÛŒØ§Ø³Øª.";
            return;
        }

        try {
            // Ú†Ú© Ú©ÙˆÙ„ Ú†Û Ø§ÛŒØ§ Ù†ØªØ§ÛŒØ¬ Ø®Ù„Ø§Øµ Ø¯ÙŠ Ú©Ù‡ Ù¾Ù¼ØŸ
            const settingsSnap = await fs.collection("systemSettings").doc("resultsConfig").get();
            const showFinal = settingsSnap.exists ? settingsSnap.data().showFinalResults : false;

            const docRef = fs.collection("studentMarks").doc(studentId);
            const docSnap = await docRef.get();

            if (docSnap.exists) {
                const data = docSnap.data();

                document.getElementById('v-name').innerText = data.info.name;
                document.getElementById('v-father').innerText = data.info.father;
                document.getElementById('v-id').innerText = data.info.id;
                document.getElementById('v-grand').innerText = data.info.grand || '---';

                const tbody = document.getElementById('v-marks-body');
                tbody.innerHTML = "";
                
                for (let sub in data.marks) {
                    let m = data.marks[sub];
                    let finalMark = showFinal ? m.mAn : '<span class="lock-text">ğŸ”’ Ù¾Ù¼</span>';
                    let totalMark = showFinal ? m.total : '---';

                    tbody.innerHTML += `
                        <tr>
                            <td style="text-align:right; font-weight:bold;">${sub}</td>
                            <td>${m.m45}</td>
                            <td>${finalMark}</td>
                            <td style="font-weight:bold; color:#1565c0;">${totalMark}</td>
                        </tr>
                    `;
                }

                if (showFinal) {
                    const res = data.summary.final_status || "---";
                    document.getElementById('v-result').innerText = res;
                    document.getElementById('v-grade').innerText = data.summary.fin_grade || "---";
                    document.getElementById('v-att').innerText = data.attendance.pTotal || 0;
                    document.getElementById('v-result').className = (res.includes("ØªÚ©Ø±Ø§Ø±") || res.includes("Ù†Ø§Ú©Ø§Ù…")) ? "fail" : "pass";
                } else {
                    document.getElementById('v-result').innerText = "ÛŒÙˆØ§Ø²Û Û´.Ûµ Ù…ÛŒØ§Ø´ØªÙ†Û Ø§Ø¹Ù„Ø§Ù† Ø´ÙˆÛ";
                    document.getElementById('v-grade').innerText = data.summary.mid_grade || "---";
                    document.getElementById('v-att').innerText = data.attendance.p45 || 0;
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-card').style.display = 'block';

            } else {
                document.getElementById('loading').innerHTML = "ğŸ” Ù†Ù…Ø±Û Ù„Ø§ Ù†Ù‡ Ø¯ÙŠ Ø«Ø¨Øª Ø´ÙˆÛ.";
            }
        } catch (error) {
            document.getElementById('loading').innerHTML = "âŒ ØªØ®Ù†ÛŒÚ©ÙŠ ØªÛØ±ÙˆØªÙ†Ù‡.";
        }
    }

    window.onload = () => {
        loadMyResults();
        loadNotice();
    };
</script>

</body>
</html>
