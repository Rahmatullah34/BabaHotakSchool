<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ Ø²Ø¯Ù‡â€ŒÚ©ÙˆÙˆÙ†Ú©Ùˆ Ø¨Ø´Ù¾Ú“ Ù…Ø¯ÛŒØ±ÛŒØª - Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© Ù„ÛŒØ³Ù‡</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Ù¾ÚšØªÙˆ ØªÙ‡ Ø¯ ÙÙˆÙ†Ù¼ÙˆÙ†Ùˆ Ø¨Ø¯Ù„ÙˆÙ„ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap');
        
        body { 
            font-family: 'Noto Sans Arabic', 'Segoe UI', Tahoma, sans-serif; 
            background-color: #f4f7f6; 
            margin: 0; 
            padding: 0; 
        }

        .dashboard-container { max-width: 1000px; margin: auto; padding-bottom: 30px; }

        /* Ø§Ø­ØµØ§ÛŒÙ‡ */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px; }
        .stat-card { padding: 15px; border-radius: 15px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .blue-grad { background: linear-gradient(135deg, #3498db, #2980b9); }
        .white-card { background: white; color: #2c3e50; border: 1px solid #ddd; }
        .red-grad { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stat-num { display: block; font-size: 22px; font-weight: bold; }
        .stat-label { font-size: 12px; }

        /* Ø¹Ù…Ù„ÛŒÛ Ø§Ùˆ Ù„Ù…Ø³ (Touch Targets) */
        .action-btn { 
            border: none; 
            width: 40px; 
            height: 40px; 
            border-radius: 10px; 
            cursor: pointer; 
            margin: 1px; 
            transition: 0.3s; 
            color: white; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            font-size: 16px;
        }
        .action-btn:active { transform: scale(0.9); }
        .view-btn { background-color: #3498db; }
        .edit-btn { background-color: #2ecc71; }
        .delete-btn { background-color: #e74c3c; }

        /* Ø¬Ø¯ÙˆÙ„ Ø§ØµÙ„Ø§Ø­Ø§Øª */
        .table-container { margin: 20px; background: white; border-radius: 15px; overflow-x: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        table th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; border-bottom: 2px solid #dee2e6; padding: 15px 10px; color: #444; font-size: 14px; }
        table td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px; }
        
        /* Ø¯ Ø¹Ù…Ù„ÛŒÙˆ ÚØ§ÛŒ Ù†Ú–Ø¯Û Ú©ÙˆÙ„ */
        .actions-cell { white-space: nowrap; text-align: center; }

        .edit-input { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; outline: none; font-family: inherit; font-size: 15px; }
        .edit-input:focus { border-color: #3498db; }

        .import-section { background: white; padding: 25px; border-radius: 15px; margin: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .admission-form-container { display: none; background: #fff; padding: 25px; border-radius: 20px; margin: 20px; border: 1px solid #eee; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        
        .photo-upload-label { display: block; margin-top: 10px; padding: 12px; border: 2px dashed #3498db; border-radius: 10px; text-align: center; cursor: pointer; color: #3498db; font-weight: bold; }
        #photoPreview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; display: none; margin: 10px auto; border: 3px solid #2ecc71; }
        
        .login-id-box { background: #f0f9ff; color: #0369a1; padding: 4px 12px; border-radius: 20px; font-weight: bold; border: 1px solid #bae6fd; font-size: 13px; }
        
        .main-action-btn { background: #2ecc71; color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; font-family: inherit; }

        /* Ù…ÙˆÚ‰Ø§Ù„ Ú‰ÛŒØ²Ø§ÛŒÙ† */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(3px); }
        .profile-modal-content { background:white; padding:25px; border-radius:20px; width:380px; position:relative; max-height: 90vh; overflow-y: auto; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close-modal { position:absolute; left:15px; top:15px; cursor:pointer; font-size:24px; color: #666; }

        .cat-badge { background:#eef2ff; color:#4338ca; padding:3px 10px; border-radius:5px; font-weight: bold; border: 1px solid #c7d2fe; font-size: 12px; }
    </style>
</head>

<body>

    <!-- Ø¯ Ø§Ú©Ø³Ù„ Ø¨Ø±Ø®Û -->
    <div class="import-section">
        <h3 style="color: #2563eb; margin-bottom: 20px;"><i class="fas fa-file-excel"></i> Ø¯ Ø§Ú©Ø³Ù„ Ù„Ù‡ Ù„Ø§Ø±Û Ø§Ø¶Ø§ÙÙ‡ Ú©ÙˆÙ„</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <select id="importGrade" class="edit-input">
                <option value="">Ù¼ÙˆÙ„Ú«ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ú“Ø¦</option>
                <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option><option value="Ø¯ÙˆÙ‡Ù…">Ø¯ÙˆÙ‡Ù…</option><option value="Ø¯Ø±ÛŒÙ…">Ø¯Ø±ÛŒÙ…</option>
                <option value="Ú…Ù„ÙˆØ±Ù…">Ú…Ù„ÙˆØ±Ù…</option><option value="Ù¾Ù†ÚÙ…">Ù¾Ù†ÚÙ…</option><option value="Ø´Ù¾Ú–Ù…">Ø´Ù¾Ú–Ù…</option>
                <option value="Ø§ÙˆÙˆÙ…">Ø§ÙˆÙˆÙ…</option><option value="Ø§ØªÙ…">Ø§ØªÙ…</option><option value="Ù†Ù‡Ù…">Ù†Ù‡Ù…</option>
                <option value="Ù„Ø³Ù…">Ù„Ø³Ù…</option><option value="ÛŒÙˆÙˆÙ„Ø³Ù…">ÛŒÙˆÙˆÙ„Ø³Ù…</option><option value="Ø¯ÙˆÙ„Ø³Ù…">Ø¯ÙˆÙ„Ø³Ù…</option>
            </select>
            <select id="importSection" class="edit-input">
                <option value="Ø§Ù„Ù">Ú…Ø§Ù†Ú«Ù‡ Ø§Ù„Ù</option>
                <option value="Ø¨">Ú…Ø§Ù†Ú«Ù‡ Ø¨</option>
                <option value="Ø¬">Ú…Ø§Ù†Ú«Ù‡ Ø¬</option>
                <option value="Ø¯">Ú…Ø§Ù†Ú«Ù‡ Ø¯</option>
            </select>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px dashed #cbd5e1; margin-bottom: 15px;">
            <input type="file" id="excelUpload" accept=".xlsx, .xls">
        </div>
        <button onclick="importStudents()" class="main-action-btn" style="background: #3498db; width: 100%;">Ú‰ÛŒÙ¼Ø§Ø¨ÛŒØ³ ØªÙ‡ Ù„ÛÚ–Ù„ ğŸš€</button>
    </div>

    <div class="dashboard-container">
        <!-- Ø§Ø­ØµØ§ÛŒÙ‡ -->
        <div class="stats-grid">
            <div class="stat-card blue-grad"><span id="totalStdCount" class="stat-num">0</span><span class="stat-label">Ù¼ÙˆÙ„ Ø²Ø¯Ù‡â€ŒÚ©ÙˆÙˆÙ†Ú©ÙŠ</span></div>
            <div class="stat-card white-card"><span id="activeStdCount" class="stat-num">0</span><span class="stat-label">Ø¨Ø±Ø­Ø§Ù„Ù‡</span></div>
            <div class="stat-card red-grad"><span id="inactiveCount" class="stat-num">0</span><span class="stat-label">ØºÛŒØ± ÙØ¹Ø§Ù„</span></div>
        </div>

        <div style="display: flex; gap: 10px; padding: 0 20px; flex-wrap: wrap; margin-bottom: 20px;">
            <input type="text" id="searchBar" onkeyup="filterStudents()" placeholder="ğŸ” Ù„Ù¼ÙˆÙ† (Ù†ÙˆÙ… ÛŒØ§ Ø§Ø³Ø§Ø³)..." style="flex: 2; padding: 12px; border-radius: 10px; border: 1px solid #ddd; min-width: 200px; font-family: inherit;">
            <select id="filterGradeSelect" onchange="filterStudents()" class="edit-input" style="flex: 1; margin: 0; min-width: 150px;">
                <option value="">Ù¼ÙˆÙ„ Ù¼ÙˆÙ„Ú«ÙŠ</option>
                <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option><option value="Ø¯ÙˆÙ‡Ù…">Ø¯ÙˆÙ‡Ù…</option><option value="Ø¯Ø±ÛŒÙ…">Ø¯Ø±ÛŒÙ…</option>
                <option value="Ú…Ù„ÙˆØ±Ù…">Ú…Ù„ÙˆØ±Ù…</option><option value="Ù¾Ù†ÚÙ…">Ù¾Ù†ÚÙ…</option><option value="Ø´Ù¾Ú–Ù…">Ø´Ù¾Ú–Ù…</option>
                <option value="Ø§ÙˆÙˆÙ…">Ø§ÙˆÙˆÙ…</option><option value="Ø§ØªÙ…">Ø§ØªÙ…</option><option value="Ù†Ù‡Ù…">Ù†Ù‡Ù…</option>
                <option value="Ù„Ø³Ù…">Ù„Ø³Ù…</option><option value="ÛŒÙˆÙˆÙ„Ø³Ù…">ÛŒÙˆÙˆÙ„Ø³Ù…</option><option value="Ø¯ÙˆÙ„Ø³Ù…">Ø¯ÙˆÙ„Ø³Ù…</option>
            </select>
            <button onclick="toggleForm()" class="main-action-btn">+ Ù†ÙˆÛŒ Ù„Ø§Ø³ÙŠ Ø«Ø¨Øª</button>
        </div>

        <!-- ÙØ§Ø±Ù… -->
        <div id="admissionForm" class="admission-form-container">
            <h3 id="formTitle" style="text-align: center; color: #2ecc71; margin-bottom: 20px;">Ø¯ Ø²Ø¯Ù‡â€ŒÚ©ÙˆÙˆÙ†Ú©ÙŠ Ù„Ø§Ø³ÙŠ Ø«Ø¨ØªÙˆÙ„</h3>
            <input type="hidden" id="editDocId">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input type="text" id="stdName" placeholder="Ù†ÙˆÙ…" class="edit-input">
                <input type="text" id="stdFather" placeholder="Ù¾Ù„Ø§Ø± Ù†ÙˆÙ…" class="edit-input">
                <input type="text" id="stdGFather" placeholder="Ù†ÛŒÚ©Ù‡ Ù†ÙˆÙ…" class="edit-input">
                <input type="text" id="stdAsas" placeholder="Ø§Ø³Ø§Ø³ Ù†Ù…Ø¨Ø±" class="edit-input">
                
                <select id="stdGrade" class="edit-input">
                    <option value="">Ù¼ÙˆÙ„Ú«ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ú“Ø¦</option>
                    <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option><option value="Ø¯ÙˆÙ‡Ù…">Ø¯ÙˆÙ‡Ù…</option><option value="Ø¯Ø±ÛŒÙ…">Ø¯Ø±ÛŒÙ…</option>
                    <option value="Ú…Ù„ÙˆØ±Ù…">Ú…Ù„ÙˆØ±Ù…</option><option value="Ù¾Ù†ÚÙ…">Ù¾Ù†ÚÙ…</option><option value="Ø´Ù¾Ú–Ù…">Ø´Ù¾Ú–Ù…</option>
                    <option value="Ø§ÙˆÙˆÙ…">Ø§ÙˆÙˆÙ…</option><option value="Ø§ØªÙ…">Ø§ØªÙ…</option><option value="Ù†Ù‡Ù…">Ù†Ù‡Ù…</option>
                    <option value="Ù„Ø³Ù…">Ù„Ø³Ù…</option><option value="ÛŒÙˆÙˆÙ„Ø³Ù…">ÛŒÙˆÙˆÙ„Ø³Ù…</option><option value="Ø¯ÙˆÙ„Ø³Ù…">Ø¯ÙˆÙ„Ø³Ù…</option>
                </select>
                
                <select id="stdSection" class="edit-input">
                    <option value="Ø§Ù„Ù">Ú…Ø§Ù†Ú«Ù‡ Ø§Ù„Ù</option><option value="Ø¨">Ú…Ø§Ù†Ú«Ù‡ Ø¨</option><option value="Ø¬">Ú…Ø§Ù†Ú«Ù‡ Ø¬</option><option value="Ø¯">Ú…Ø§Ù†Ú«Ù‡ Ø¯</option>
                </select>
                
                <input type="tel" id="stdPhone" placeholder="Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø´Ù…ÛŒØ±Ù‡" class="edit-input" style="grid-column: span 2;">

                <div style="grid-column: span 2; border-top: 1px solid #eee; padding-top: 10px; text-align: center;">
                    <img id="photoPreview" src="">
                    <label for="stdPhoto" class="photo-upload-label" id="uploadStatus">ğŸ“¸ Ø¯ Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨</label>
                    <input type="file" id="stdPhoto" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveManualStudent()" id="saveBtn" class="main-action-btn" style="flex: 1;">Ø®ÙˆÙ†Ø¯ÙŠ Ú©ÙˆÙ„ ğŸ’¾</button>
                <button onclick="toggleForm()" class="main-action-btn" style="background: #95a5a6;">Ø¨Ù†Ø¯ÙˆÙ„</button>
            </div>
        </div>

        <!-- Ø¯ Ø²Ø¯Ù‡ Ú©ÙˆÙˆÙ†Ú©Ùˆ Ø¬Ø¯ÙˆÙ„ -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;">Ú«Ú¼Ù‡</th>
                        <th style="width: 70px;">Ø§Ø³Ø§Ø³</th>
                        <th>Ù†ÙˆÙ… Ø§Ùˆ Ù¾Ù„Ø§Ø±</th>
                        <th style="width: 80px;">Ù¼ÙˆÙ„Ú«ÛŒ</th>
                        <th style="width: 70px;">Ú…Ø§Ù†Ú«Ù‡</th>
                        <th style="width: 140px;">Ø¹Ù…Ù„ÛŒÛ</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…ÙˆÚ‰Ø§Ù„ -->
    <div id="profileModal" class="modal-overlay">
        <div class="profile-modal-content">
            <span class="close-modal" onclick="closeModal('profileModal')">Ã—</span>
            <img id="viewPhoto" src="" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid #f0f0f0; margin-bottom: 15px; object-fit: cover;" alt="Ø¹Ú©Ø³ Ù†Ø´ØªÙ‡">
            <h2 id="viewName" style="margin: 0; color: #2c3e50;"></h2>
            <p id="viewID" class="login-id-box"></p>
            <div style="text-align: right; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px;"><span id="valFather"></span><span style="color: #777; font-weight: bold;">Ù¾Ù„Ø§Ø± Ù†ÙˆÙ…:</span></div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px;"><span id="valGFather"></span><span style="color: #777; font-weight: bold;">Ù†ÛŒÚ©Ù‡ Ù†ÙˆÙ…:</span></div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px;"><span id="valAsas"></span><span style="color: #777; font-weight: bold;">Ø§Ø³Ø§Ø³ Ù†Ù…Ø¨Ø±:</span></div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px;"><span id="valGrade"></span><span style="color: #777; font-weight: bold;">Ù¼ÙˆÙ„Ú«ÛŒ:</span></div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px;"><span id="valSection" class="cat-badge"></span><span style="color: #777; font-weight: bold;">Ú…Ø§Ù†Ú«Ù‡:</span></div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px;"><span id="valPhone"></span><span style="color: #777; font-weight: bold;">Ù…ÙˆØ¨Ø§ÛŒÙ„:</span></div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px;"><span id="valStatus" style="color: green; font-weight: bold;">Ø¨Ø±Ø­Ø§Ù„Ù‡</span><span style="color: #777; font-weight: bold;">Ø­Ø§Ù„Øª:</span></div>
            </div>
            <button onclick="window.print()" class="main-action-btn" style="width: 100%; margin-top: 20px; background: #34495e;">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
            authDomain: "babahotakschool.firebaseapp.com",
            projectId: "babahotakschool",
            storageBucket: "babahotakschool.firebasestorage.app",
            messagingSenderId: "12958892996",
            appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allStudents = [];

        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const statusLabel = document.getElementById('uploadStatus');
            statusLabel.innerText = "â³ Ù¾Ø±ÙˆØ³Ø³...";
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    const max_size = 400; 
                    if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } }
                    else { if (height > max_size) { width *= max_size / height; height = max_size; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    const prev = document.getElementById('photoPreview');
                    prev.src = compressedDataUrl; prev.style.display = 'block';
                    statusLabel.innerText = "âœ… Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ùˆ";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function importStudents() {
            const fileInput = document.getElementById('excelUpload');
            const grade = document.getElementById('importGrade').value;
            const section = document.getElementById('importSection').value;
            if (!fileInput.files[0] || !grade) return alert("Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ØŒ Ù¼ÙˆÙ„Ú«ÛŒ Ø§Ùˆ Ú…Ø§Ù†Ú«Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ú“Ø¦!");

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    alert("Ú‰ÛŒÙ¼Ø§ Ù„ÛÚ–Ù„ Ù¾ÛŒÙ„ Ø´ÙˆÙ„...");
                    for (const row of jsonData) {
                        const name = row['Ù†ÙˆÙ…'] || row['Name'];
                        const father = row['Ø¯ Ù¾Ù„Ø§Ø± Ù†ÙˆÙ…'] || row['Father Name'];
                        const gfather = row['Ø¯ Ù†ÛŒÚ©Ù‡ Ù†ÙˆÙ…'] || row['Grandfather Name'];
                        const asas = row['Ø¯ Ø§Ø³Ø§Ø³ Ú«Ú¼Ù‡'] || row['Asas Number'];
                        if (name && asas) {
                            const studentId = "BH-2026-" + asas;
                            await db.collection("babaStudents").doc(studentId).set({
                                studentId, name, father: father || "", gFather: gfather || "",
                                asas: asas.toString(), grade, section, status: 'Ø¨Ø±Ø­Ø§Ù„Ù‡', photo: "",
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                        }
                    }
                    alert("âœ… Ú‰ÛŒÙ¼Ø§ Ù¾Ù‡ Ø¨Ø±ÛŒØ§Ù„ÛŒØªÙˆØ¨ Ø³Ø±Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆÙ‡!");
                } catch (error) { alert("ØªÛØ±ÙˆØªÙ†Ù‡ ÙˆØ´ÙˆÙ‡!"); }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        }

        function loadStudents() {
            db.collection("babaStudents").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                allStudents = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderTable(allStudents);
                document.getElementById('totalStdCount').innerText = allStudents.length;
                document.getElementById('activeStdCount').innerText = allStudents.filter(s => s.status === 'Ø¨Ø±Ø­Ø§Ù„Ù‡').length;
                document.getElementById('inactiveCount').innerText = allStudents.filter(s => s.status !== 'Ø¨Ø±Ø­Ø§Ù„Ù‡').length;
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = "";
            data.forEach((std, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="login-id-box">${index + 1}</span></td>
                    <td style="font-weight:bold;">${std.asas}</td>
                    <td style="text-align:right;"><b>${std.name}</b><br><small style="color:#777;">Ø¯ ${std.father} Ø²ÙˆÛŒ</small></td>
                    <td><span style="color:#2980b9; font-weight:bold;">${std.grade}</span></td>
                    <td><span class="cat-badge">${std.section || 'Ø§Ù„Ù'}</span></td>
                    <td class="actions-cell">
                        <button class="action-btn view-btn" title="Ø¬Ø²ÛŒØ§Øª Ù„ÛŒØ¯Ù„" onclick="viewProfile('${std.id}')"><i class="fas fa-eye"></i></button>
                        <button class="action-btn edit-btn" title="Ø§ÛŒÚ‰ÛŒÙ¼" onclick="editStudent('${std.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" title="Ø­Ø°Ù" onclick="deleteStudent('${std.id}')"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleForm() {
            const f = document.getElementById('admissionForm');
            if(f.style.display === 'block') { f.style.display = 'none'; }
            else {
                document.getElementById('editDocId').value = "";
                document.getElementById('stdName').value = "";
                document.getElementById('stdFather').value = "";
                document.getElementById('stdGFather').value = "";
                document.getElementById('stdPhone').value = "";
                document.getElementById('stdAsas').value = "";
                document.getElementById('photoPreview').style.display = 'none';
                document.getElementById('uploadStatus').innerText = "ğŸ“¸ Ø¯ Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨";
                f.style.display = 'block';
            }
        }

        function editStudent(id) {
            const std = allStudents.find(s => s.id === id);
            if(std) {
                toggleForm();
                document.getElementById('editDocId').value = id;
                document.getElementById('stdName').value = std.name;
                document.getElementById('stdFather').value = std.father;
                document.getElementById('stdGFather').value = std.gFather || "";
                document.getElementById('stdPhone').value = std.phone || "";
                document.getElementById('stdAsas').value = std.asas;
                document.getElementById('stdGrade').value = std.grade;
                document.getElementById('stdSection').value = std.section || "Ø§Ù„Ù";
                if(std.photo) {
                    document.getElementById('photoPreview').src = std.photo;
                    document.getElementById('photoPreview').style.display = 'block';
                }
            }
        }

        async function saveManualStudent() {
            const id = document.getElementById('editDocId').value;
            const name = document.getElementById('stdName').value.trim();
            const asas = document.getElementById('stdAsas').value.trim();
            const grade = document.getElementById('stdGrade').value;
            const section = document.getElementById('stdSection').value;
            const photo = document.getElementById('photoPreview').src;

            if(!name || !asas || !grade) return alert("Ù„Ø·ÙØ§Ù‹ Ù†ÙˆÙ…ØŒ Ø§Ø³Ø§Ø³ Ø§Ùˆ Ù¼ÙˆÙ„Ú«ÛŒ Ú‰Ú© Ú©Ú“Ø¦!");

            const studentId = id || "BH-2026-" + asas;
            const data = {
                studentId, name, asas, grade, photo, section,
                father: document.getElementById('stdFather').value,
                gFather: document.getElementById('stdGFather').value,
                phone: document.getElementById('stdPhone').value,
                status: 'Ø¨Ø±Ø­Ø§Ù„Ù‡',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection("babaStudents").doc(studentId).set(data, { merge: true });
                alert("Ø®ÙˆÙ†Ø¯ÙŠ Ø´Ùˆ âœ…");
                toggleForm();
            } catch (e) { alert("ØªÛØ±ÙˆØªÙ†Ù‡ ÙˆØ´ÙˆÙ‡!"); }
        }

        function filterStudents() {
            const s = document.getElementById('searchBar').value.toLowerCase();
            const g = document.getElementById('filterGradeSelect').value;
            const filtered = allStudents.filter(std => 
                (std.name.toLowerCase().includes(s) || std.asas.includes(s)) && 
                (g === "" || std.grade === g)
            );
            renderTable(filtered);
        }

        function viewProfile(id) {
            const std = allStudents.find(s => s.id === id);
            if(std) {
                document.getElementById('viewName').innerText = std.name;
                document.getElementById('viewPhoto').src = std.photo || "https://via.placeholder.com/150?text=No+Photo";
                document.getElementById('profileModal').style.display = 'flex';
                document.getElementById('valFather').innerText = std.father;
                document.getElementById('valGFather').innerText = std.gFather || "Ù†Ø´ØªÙ‡";
                document.getElementById('valGrade').innerText = std.grade;
                document.getElementById('valSection').innerText = "Ú…Ø§Ù†Ú«Ù‡ " + (std.section || "Ø§Ù„Ù");
                document.getElementById('valAsas').innerText = std.asas;
                document.getElementById('valPhone').innerText = std.phone || "Ù†Ø´ØªÙ‡";
                document.getElementById('viewID').innerText = std.studentId;
            }
        }

        async function deleteStudent(id) { 
            if(confirm("Ø¢ÛŒØ§ Ú‰Ø§Ú‰Ù‡ ÛŒØ§Ø³Øª Ú†Û Ø¯Ø§ Ø²Ø¯Ù‡â€ŒÚ©ÙˆÙˆÙ†Ú©ÛŒ Ø­Ø°Ù Ú©Ú“Ø¦ØŸ")) {
                try {
                    await db.collection("babaStudents").doc(id).delete();
                    alert("Ø­Ø°Ù Ø´Ùˆ âœ…");
                } catch(e) { alert("Ø³ØªÙˆÙ†Ø²Ù‡ ÙˆÙ‡!"); }
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onload = loadStudents;
    </script>
</body>
</html>

