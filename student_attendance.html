<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø²Ù…Ø§ Ø­Ø§Ø¶Ø±ÙŠ - Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© Ù„ÛŒØ³Ù‡</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; --bg: #f0f4f8; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; direction: rtl; }
        
        .header { background: white; padding: 20px; border-radius: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .back-btn { background: #eee; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-weight: bold; text-decoration: none; color: black; font-size: 14px; }
        
        select { padding: 8px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; outline: none; background: #fff; cursor: pointer; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .stat-card h2 { margin: 0; color: var(--success); font-size: 28px; }
        .stat-card p { margin: 5px 0 0; color: #7f8c8d; font-size: 14px; }

        .attendance-table-container { background: white; padding: 15px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 200px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; padding: 12px; text-align: center; font-size: 14px; color: #2c3e50; border-bottom: 2px solid #eee; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        
        /* Ø¯ Ø³ÙˆØ¨ Ø§Ùˆ Ù†Ø§Ø³ÙˆØ¨ Ù„Ù¾Ø§Ø±Ù‡ Ø³Ù¼Ø§ÛŒÙ„ */
        .status-present { background: #e8f5e9; color: var(--success); padding: 6px 12px; border-radius: 10px; font-weight: bold; }
        .status-absent { background: #ffebee; color: var(--danger); padding: 6px 12px; border-radius: 10px; font-weight: bold; }
        .status-leave { background: #fff3e0; color: var(--warning); padding: 6px 12px; border-radius: 10px; font-weight: bold; }
        
        #loading { text-align: center; padding: 40px; color: #7f8c8d; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <h3 style="margin:0;">ğŸ“… Ø²Ù…Ø§ Ø¯ Ø­Ø§Ø¶Ø±Û Ø±Ø§Ù¾ÙˆØ±</h3>
    <select id="monthFilter" onchange="getAttendance()">
        <option value="all">Ù¼ÙˆÙ„ Ú©Ø§Ù„</option>
        <option value="01">ÙˆØ±ÛŒ (Ø­Ù…Ù„)</option>
        <option value="02">ØºÙˆÛŒÛŒ (Ø«ÙˆØ±)</option>
        <option value="03">ØºØ¨Ø±Ú«ÙˆÙ„ÛŒ (Ø¬ÙˆØ²Ø§)</option>
        <option value="04">Ú†Ù†Ú«Ø§Úš (Ø³Ø±Ø·Ø§Ù†)</option>
        <option value="05">Ø²Ù…Ø±ÛŒ (Ø§Ø³Ø¯)</option>
        <option value="06">ÙˆÚ–ÛŒ (Ø³Ù†Ø¨Ù„Ù‡)</option>
        <option value="07">ØªÙ„Ù‡ (Ù…ÛŒØ²Ø§Ù†)</option>
        <option value="08">Ù„Ú“Ù… (Ø¹Ù‚Ø±Ø¨)</option>
        <option value="09">Ù„ÛŒÙ†Ø¯Û (Ù‚ÙˆØ³)</option>
        <option value="10">Ù…Ø±ØºÙˆÙ…ÛŒ (Ø¬Ø¯ÙŠ)</option>
        <option value="11">Ø³Ù„ÙˆØ§ØºÙ‡ (Ø¯Ù„ÙˆÙ‡)</option>
        <option value="12">Ú©Ø¨ (Ø­ÙˆØª)</option>
    </select>
    <a href="student_dashboard.html" class="back-btn">Ø´Ø§ ØªÙ‡ â¬…ï¸</a>
</div>

<div class="stats-grid">
    <div class="stat-card"><h2 id="rateDisplay">0%</h2><p>Ø³Ù„Ù†Ù‡ (ÙÛŒØµØ¯ÙŠ)</p></div>
    <div class="stat-card"><h2 id="presentCount">0</h2><p>Ø­Ø§Ø¶Ø±Û ÙˆØ±ÚÛ</p></div>
</div>

<div class="attendance-table-container">
    <div id="loading">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø±Ø§ÙˆÚ“Ù„ Ú©ÛÚ–ÙŠ...</div>
    <table id="attendanceTable" style="display: none;">
        <thead>
            <tr>
                <th>Ù†ÛÙ¼Ù‡</th>
                <th>Ø­Ø§Ù„Øª</th>
            </tr>
        </thead>
        <tbody id="attendanceList"></tbody>
    </table>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
        projectId: "babahotakschool",
        appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const studentId = localStorage.getItem('userId');

    async function getAttendance() {
        if (!studentId) {
            window.location.href = 'login.html';
            return;
        }

        document.getElementById('loading').innerText = "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø±Ø§ÙˆÚ“Ù„ Ú©ÛÚ–ÙŠ...";
        document.getElementById('loading').style.display = 'block';
        document.getElementById('attendanceTable').style.display = 'none';

        try {
            // Ù„Ù‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ú…Ø®Ù‡ Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙˆ Ø±Ø§ÙˆÚ“Ù„
            const snapshot = await db.collection("babaAttendance")
                .where("studentId", "==", studentId)
                .get();

            if (snapshot.empty) {
                document.getElementById('loading').innerText = "Ø¯ Ø­Ø§Ø¶Ø±Û Ù‡ÛŒÚ… Ø±ÛŒÚ©Ø§Ø±Ú‰ ÙˆÙ†Ù‡ Ù…ÙˆÙ†Ø¯Ù„ Ø´Ùˆ.";
                return;
            }

            let attendanceArray = [];
            snapshot.forEach(doc => attendanceArray.push(doc.data()));

            // Ù†ÛÙ¼Ù‡ ØªÙ†Ø¸ÛŒÙ…ÙˆÙ„ (Ù„Ù‡ Ù†ÙˆÛ Ú…Ø®Ù‡ Ø²Ú“Û ØªÙ‡)
            attendanceArray.sort((a, b) => new Date(b.date) - new Date(a.date));

            const selectedMonth = document.getElementById('monthFilter').value;
            let totalFiltered = 0;
            let present = 0;
            let html = "";

            attendanceArray.forEach(data => {
                // Ù†ÛÙ¼Ù‡ Ø¨Ø§ÛŒØ¯ 2026-01-14 ÙØ§Ø±Ù…Ù¼ Ú©Û ÙˆÙŠ
                const dateParts = data.date.split('-');
                const month = dateParts[1];

                if (selectedMonth !== 'all' && month !== selectedMonth) return;

                totalFiltered++;
                let statusText = "Ù†Ø§Ø³ÙˆØ¨";
                let statusClass = "status-absent";

                // Ø¯ 'Ø³ÙˆØ¨' Ø§Ùˆ 'Ù†Ø§Ø³ÙˆØ¨' Ù…Ù†Ø·Ù‚ Ø¯Ù„ØªÙ‡ Ø¯ÛŒ
                if (data.status === 'Ø³ÙˆØ¨' || data.status === 'present') {
                    statusText = "Ø³ÙˆØ¨ (Ø­Ø§Ø¶Ø±)";
                    statusClass = "status-present";
                    present++;
                } else if (data.status === 'Ø±Ø®ØµØª' || data.status === 'leave') {
                    statusText = "Ø±Ø®ØµØª";
                    statusClass = "status-leave";
                } else {
                    statusText = "Ù†Ø§Ø³ÙˆØ¨ (ØºÛŒØ±Ø­Ø§Ø¶Ø±)";
                    statusClass = "status-absent";
                }

                html += `
                    <tr>
                        <td>${data.date || '---'}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });

            if(totalFiltered === 0) {
                document.getElementById('loading').innerText = "Ù¾Ù‡ Ø¯Û Ù…ÛŒØ§Ø´Øª Ú©Û Ø±ÛŒÚ©Ø§Ø±Ú‰ Ù†Ø´ØªÙ‡.";
                document.getElementById('rateDisplay').innerText = "0%";
                document.getElementById('presentCount').innerText = "0";
                return;
            }

            const rate = Math.round((present / totalFiltered) * 100);
            document.getElementById('rateDisplay').innerText = rate + "%";
            document.getElementById('presentCount').innerText = present;
            document.getElementById('attendanceList').innerHTML = html;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('attendanceTable').style.display = 'table';

        } catch (error) {
            console.error("ØªÛØ±ÙˆØªÙ†Ù‡:", error);
            document.getElementById('loading').innerText = "Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙˆ Ù¾Ù‡ Ø±Ø§ÙˆÚ“Ù„Ùˆ Ú©Û Ø³ØªÙˆÙ†Ø²Ù‡ Ø¯Ù‡.";
        }
    }

    window.onload = getAttendance;
</script>

</body>
</html>
