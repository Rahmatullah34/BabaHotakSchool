<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¯ Ù…Ø¯ÛŒØ± Ú†Ù¼ - Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© Ù„ÛŒØ³Ù‡</title>
  <style>
    :root {
      --primary: #3498db;
      --teacher: #e74c3c;
      --admin: #2ecc71;
      --bg: #f5f7fa;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma; 
      background: var(--bg); 
      margin: 0; 
      padding: 15px; 
      direction: rtl; 
    }
    
    .layout { 
      display: flex; 
      flex-direction: column; 
      gap: 15px; 
      max-width: 1000px; 
      margin: auto; 
    }
    
    /* Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± */
    .sidebar {
      width: 100%; 
      background: white; 
      border-radius: 15px;
      padding: 15px; 
      max-height: 300px; 
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .teacher-item {
      padding: 12px; 
      border-bottom: 1px solid #eee; 
      cursor: pointer;
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      transition: all 0.3s;
      border-radius: 10px;
      margin-bottom: 5px;
    }
    
    .teacher-item:hover { 
      background: #f0f8ff; 
      transform: translateX(-5px);
    }
    
    .teacher-item.active {
      background: var(--primary);
      color: white;
    }
    
    /* Ø¯ Ú†Ù¼ Ø¨Ú©Ø³ */
    .chat-box {
      background: white; 
      border-radius: 20px;
      padding: 20px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex; 
      flex-direction: column;
      height: 70vh;
    }
    
    /* Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡ */
    .messages {
      flex: 1; 
      height: 400px; 
      overflow-y: auto;
      border: 1px solid #e1e8ed; 
      padding: 15px; 
      border-radius: 15px;
      margin-bottom: 15px; 
      display: flex; 
      flex-direction: column;
      background: #fafafa;
    }
    
    .msg {
      margin: 8px 0; 
      padding: 12px 16px; 
      border-radius: 18px;
      max-width: 75%; 
      position: relative; 
      word-wrap: break-word;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .msg.admin {
      background: var(--admin);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
      box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
    }
    
    .msg.teacher {
      background: var(--teacher);
      color: white;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
      box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
    }
    
    /* Ø¯ Ø§Ø³ØªÙˆÙ„Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
    .sender-info { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      margin-bottom: 8px; 
    }
    
    .sender-info img { 
      width: 36px; 
      height: 36px; 
      border-radius: 50%; 
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .sender-info strong { 
      font-size: 14px; 
      font-weight: 600;
    }
    
    .msg small { 
      font-size: 11px; 
      color: rgba(255,255,255,0.8); 
      display: block; 
      margin-top: 6px; 
      text-align: left;
    }
    
    /* Ø¯ ÚÙˆØ§Ø¨ Ø¨Ú©Ø³ */
    .reply-box {
      background: #fff3cd; 
      border: 1px solid #ffeaa7;
      padding: 10px 15px; 
      border-radius: 12px;
      margin-bottom: 12px; 
      font-size: 13px; 
      color: #856404;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .close-reply {
      background: none;
      border: none;
      color: #856404;
      cursor: pointer;
      font-size: 18px;
    }
    
    /* Ø¯ Ø§Ù†Ù¾Ù¼ Ø¨Ú©Ø³ */
    .input-row { 
      display: flex; 
      flex-direction: row; 
      gap: 10px; 
      flex-wrap: wrap; 
    }
    
    input[type="text"] {
      flex: 1; 
      padding: 14px; 
      border-radius: 12px; 
      border: 2px solid #e1e8ed;
      font-size: 15px;
      transition: all 0.3s;
    }
    
    input[type="text"]:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    button {
      padding: 14px 20px; 
      border: none; 
      border-radius: 12px;
      background: var(--primary); 
      color: white; 
      font-weight: 600; 
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    /* Ù†ÙˆÙŠ Ù¾ÛŒØºØ§Ù… Ù†ÚšÙ‡ */
    .unread-badge {
      background: #e74c3c;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 5px;
    }
    
    /* Ø¯ ÙØ§ÛŒÙ„ Ø§Ù¾Ù„ÙˆÚ‰ */
    .file-upload {
      position: relative;
    }
    
    .file-label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    
    /* Ø¯ Ù¾ÛŒØºØ§Ù… Ø­Ø§Ù„Øª */
    .status-indicator {
      font-size: 10px;
      margin-top: 3px;
    }
    
    .status-sent { color: #95a5a6; }
    .status-delivered { color: #3498db; }
    .status-read { color: #2ecc71; }
  </style>
</head>
<body>

<div class="layout">
  <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¯ ÚšÙˆÙˆÙ†Ú©Ùˆ Ù„Ù¾Ø§Ø±Ù‡ -->
  <div class="sidebar">
    <h3 style="margin:0 0 15px 0; color:var(--primary); display:flex; align-items:center; gap:10px;">
      <span>ğŸ‘¨â€ğŸ«</span> ÚšÙˆÙˆÙ†Ú©ÙŠ
    </h3>
    <div id="teacherList"></div>
  </div>

  <!-- Ø¯ Ú†Ù¼ Ø¨Ú©Ø³ -->
  <div class="chat-box">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <button onclick="goBack()" style="background:#95a5a6;">â¬…ï¸ Ø´Ø§ØªÙ‡</button>
      <h3 id="chatTitle" style="margin:0; color:var(--primary); display:flex; align-items:center; gap:10px;">
        <span id="chatIcon">ğŸ’¬</span> <span id="chatTitleText">Ø¹Ù…ÙˆÙ…ÙŠ Ú†Ù¼</span>
      </h3>
    </div>

    <!-- Ø¯ ÚÙˆØ§Ø¨ Ø¨Ú©Ø³ -->
    <div id="replyBox" class="reply-box" style="display:none;">
      <span id="replyText"></span>
      <button class="close-reply" onclick="clearReply()">Ã—</button>
    </div>
    
    <!-- Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡ -->
    <div id="messages" class="messages"></div>

    <!-- Ø¯ Ø§Ù†Ù¾Ù¼ Ø¨Ú©Ø³ -->
    <div class="input-row">
      <input type="text" id="msgInput" placeholder="Ù¾ÛŒØºØ§Ù… ÙˆÙ„ÛŒÚ©Ø¦..." onkeypress="handleEnter(event)">
      <div class="file-upload">
        <label for="fileInput" class="file-label">
          <button style="background:#9b59b6;">ğŸ“ ÙØ§ÛŒÙ„</button>
        </label>
        <input type="file" id="fileInput" style="display:none;" onchange="sendFile(event)">
      </div>
      <button onclick="sendMessage()" id="sendBtn">ğŸ“¤ Ø§Ø³ØªÙˆÙ„</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
    authDomain: "babahotakschool.firebaseapp.com",
    projectId: "babahotakschool",
    storageBucket: "babahotakschool.firebasestorage.app",
    messagingSenderId: "12958892996",
    appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  let replyTo = null;
  let currentChat = "admin-group"; // Ú‰ÛŒÙØ§Ù„Ù¼ Ú«Ø±ÙˆÙ¾ Ú†Ù¼
  let currentTeacherId = null;

  // ==================== Ø¯ ÚšÙˆÙˆÙ†Ú©Ùˆ Ù„ÛŒØ³Øª Ø±Ø§ÙˆØ³ØªÙ„ ====================
  function loadTeachers() {
    db.collection("babaTeachers").onSnapshot(snap => {
      const list = document.getElementById("teacherList");
      list.innerHTML = "";
      
      // Ø¯ Ú«Ø±ÙˆÙ¾ Ú†Ù¼ Ø¢Ù¾Ø´Ù†
      list.innerHTML += `
        <div class="teacher-item ${currentChat === 'admin-group' ? 'active' : ''}" 
             onclick="openGroupChat()">
          <span>ğŸ“¢ Ø¹Ù…ÙˆÙ…ÙŠ Ú†Ù¼ (Ù¼ÙˆÙ„ ÚšÙˆÙˆÙ†Ú©ÙŠ)</span>
          <span style="color:#2ecc71; font-size:12px;">â—</span>
        </div>
      `;
      
      snap.forEach(doc => {
        const t = doc.data();
        const isActive = currentChat === doc.id ? 'active' : '';
        const unreadCount = getUnreadCount(doc.id);
        
        list.innerHTML += `
          <div class="teacher-item ${isActive}" 
               onclick="openPrivateChat('${doc.id}', '${t.name}')">
            <span>ğŸ‘¨â€ğŸ« ${t.name}</span>
            <div>
              ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
              <span style="color:${t.status === 'Active' ? '#2ecc71' : '#95a5a6'}; font-size:10px;">
                â—
              </span>
            </div>
          </div>
        `;
      });
      
      updateUnreadBadge();
    });
  }

  // ==================== Ø¯ Ú«Ø±ÙˆÙ¾ Ú†Ù¼ Ø®Ù„Ø§ØµÙˆÙ„ ====================
  function openGroupChat() {
    currentChat = "admin-group";
    currentTeacherId = null;
    document.getElementById("chatTitleText").innerText = "ğŸ’¬ Ø¹Ù…ÙˆÙ…ÙŠ Ú†Ù¼";
    document.getElementById("chatIcon").innerText = "ğŸ’¬";
    loadMessages();
    
    // Ø¯ ÙØ¹Ø§Ù„ Ø¢ÛŒÙ¼Ù… ØªØ§Ø²Ù‡ Ú©ÙˆÙ„
    document.querySelectorAll('.teacher-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelectorAll('.teacher-item')[0].classList.add('active');
  }

  // ==================== Ø¯ Ø®ØµÙˆØµÙŠ Ú†Ù¼ Ø®Ù„Ø§ØµÙˆÙ„ ====================
  function openPrivateChat(teacherId, teacherName) {
    currentChat = teacherId;
    currentTeacherId = teacherId;
    document.getElementById("chatTitleText").innerText = `ğŸ‘¨â€ğŸ« Ú†Ù¼ Ù„Ù‡: ${teacherName}`;
    document.getElementById("chatIcon").innerText = "ğŸ‘¨â€ğŸ«";
    loadMessages();
    
    // Ø¯ Ù„ÛŒØ¯Ù„Ùˆ Ù†ÚšÙ‡ Ú©ÙˆÙ„
    markMessagesAsRead(teacherId);
    
    // Ø¯ ÙØ¹Ø§Ù„ Ø¢ÛŒÙ¼Ù… ØªØ§Ø²Ù‡ Ú©ÙˆÙ„
    document.querySelectorAll('.teacher-item').forEach(item => {
      item.classList.remove('active');
    });
    event.target.closest('.teacher-item').classList.add('active');
  }

  // ==================== Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø±Ø§ÙˆØ³ØªÙ„ ====================
  function loadMessages() {
    db.collection("schoolChat")
      .orderBy("timestamp", "asc")
      .onSnapshot(async snapshot => {
        const box = document.getElementById('messages');
        box.innerHTML = "";
        
        let hasMessages = false;
        
        for (const doc of snapshot.docs) {
          const msg = doc.data();
          
          // Ø¯ Ú†Ù¼ ÙÙ„Ù¼Ø±
          if (currentChat === "admin-group") {
            // Ù¾Ù‡ Ú«Ø±ÙˆÙ¾ Ú©Û Ù¼ÙˆÙ„ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡ Ú†Û Ø¯ Ú«Ø±ÙˆÙ¾ ÛŒØ§ Ù…Ø¯ÛŒØ± Ù„Ù¾Ø§Ø±Ù‡ Ø¯ÙŠ
            if (msg.chatType !== "group" && msg.receiverId !== "admin-group") continue;
          } else {
            // Ù¾Ù‡ Ø®ØµÙˆØµÙŠ Ú†Ù¼ Ú©Û Ø¯ Ø¯ÙˆØ§Ú“Ùˆ Ø®ÙˆØ§ÙˆÙˆ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡
            if (!((msg.senderId === currentChat && msg.receiverId === "admin") || 
                  (msg.senderId === "admin" && msg.receiverId === currentChat))) {
              continue;
            }
          }
          
          hasMessages = true;
          await displayMessage(doc.id, msg);
        }
        
        if (!hasMessages) {
          box.innerHTML = `
            <div style="text-align:center; color:#95a5a6; padding:40px;">
              <div style="font-size:48px; margin-bottom:10px;">ğŸ’¬</div>
              <p>Ù„Ø§ ØªØ± Ø§ÙˆØ³Ù‡ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ù‡ Ù†Ø´ØªÙ‡.</p>
              <p style="font-size:12px;">Ù„ÙˆÙ…Ú“ÛŒ Ù¾ÛŒØºØ§Ù… ÙˆÙ„ÛŒÚ©Ø¦!</p>
            </div>
          `;
        }
        
        box.scrollTop = box.scrollHeight;
      });
  }

  // ==================== Ø¯ Ù¾ÛŒØºØ§Ù… ÚšÙˆØ¯Ù„ ====================
  async function displayMessage(id, msg) {
    const box = document.getElementById('messages');
    const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('ps-AF', {
      hour: '2-digit',
      minute: '2-digit'
    }) : new Date().toLocaleTimeString('ps-AF', { hour: '2-digit', minute: '2-digit' });
    
    // Ø¯ Ù¾ÛŒØºØ§Ù… Ø­Ø§Ù„Øª
    let status = "";
    if (msg.senderId === "admin") {
      if (msg.readBy && msg.readBy.includes(msg.receiverId)) {
        status = "âœ”âœ” Ù„ÛŒØ¯Ù„ Ø´ÙˆÛŒ";
      } else if (msg.deliveredTo && msg.deliveredTo.includes(msg.receiverId)) {
        status = "âœ”âœ” ØªÚ“Ù„ Ø´ÙˆÛŒ";
      } else {
        status = "âœ” ÙˆÙ„ÛŒÚ–Ù„ Ø´Ùˆ";
      }
    }
    
    // Ú©Ù‡ Ù¾ÛŒØºØ§Ù… Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ú…Ø®Ù‡ ÙˆÙŠ
    if (msg.senderId !== "admin" && msg.senderId !== "admin-group") {
      let teacherName = "ÚšÙˆÙˆÙ†Ú©ÛŒ";
      let teacherPhoto = "https://via.placeholder.com/40";
      
      try {
        const teacherDoc = await db.collection("babaTeachers").doc(msg.senderId).get();
        if (teacherDoc.exists) {
          const teacherData = teacherDoc.data();
          teacherName = teacherData.name;
          teacherPhoto = teacherData.photo || teacherPhoto;
        }
      } catch (error) {
        console.error("Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙˆ Ø³ØªÙˆÙ†Ø²Ù‡:", error);
      }
      
      box.innerHTML += `
        <div class="msg teacher" onclick="setReply('${id}', '${msg.text || ''}')">
          <div class="sender-info">
            <img src="${teacherPhoto}" alt="${teacherName}">
            <strong>${teacherName}</strong>
          </div>
          ${msg.text || ''}
          ${msg.fileUrl ? `<div style="margin-top:8px;"><a href="${msg.fileUrl}" target="_blank" style="color:white; text-decoration:underline;">ğŸ“ ÙØ§ÛŒÙ„</a></div>` : ''}
          <small>${time} ${status}</small>
        </div>
      `;
    } 
    // Ú©Ù‡ Ù¾ÛŒØºØ§Ù… Ø¯ Ù…Ø¯ÛŒØ± Ú…Ø®Ù‡ ÙˆÙŠ
    else {
      box.innerHTML += `
        <div class="msg admin" onclick="setReply('${id}', '${msg.text || ''}')">
          <div class="sender-info">
            <img src="https://via.placeholder.com/40" alt="Ù…Ø¯ÛŒØ±">
            <strong>Ù…Ø¯ÛŒØ±</strong>
          </div>
          ${msg.text || ''}
          ${msg.fileUrl ? `<div style="margin-top:8px;"><a href="${msg.fileUrl}" target="_blank" style="color:white; text-decoration:underline;">ğŸ“ ÙØ§ÛŒÙ„</a></div>` : ''}
          <small>${time} ${status}</small>
        </div>
      `;
    }
  }

  // ==================== Ø¯ Ù¾ÛŒØºØ§Ù… Ø§Ø³ØªÙˆÙ„ ====================
  async function sendMessage() {
    const text = document.getElementById('msgInput').value.trim();
    const fileInput = document.getElementById('fileInput');
    
    if (!text && fileInput.files.length === 0) {
      alert("Ù…Ù‡Ø±Ø¨Ø§Ù†ÙŠ ÙˆÚ©Ú“Ø¦ Ù¾ÛŒØºØ§Ù… ÛŒØ§ ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ú“Ø¦!");
      return;
    }
    
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = "â³ Ø§Ø³ØªÙˆÙ„ Ú©ÛÚ–ÙŠ...";
    
    try {
      let fileUrl = "";
      
      // Ú©Ù‡ ÙØ§ÛŒÙ„ ÙˆÙŠØŒ Ø§Ù¾Ù„ÙˆÚ‰ Ú©Ú“Ø¦
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const storageRef = storage.ref(`chat-files/${Date.now()}_${file.name}`);
        const uploadTask = await storageRef.put(file);
        fileUrl = await uploadTask.ref.getDownloadURL();
        
        // Ø¯ ÙØ§ÛŒÙ„ Ø§Ù†Ù¾Ù¼ Ù¾Ø§Ú©ÙˆÙ„
        fileInput.value = "";
      }
      
      const messageData = {
        text: text,
        senderId: "admin",
        senderName: "Ù…Ø¯ÛŒØ±",
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        readBy: ["admin"],
        deliveredTo: currentChat === "admin-group" ? ["admin"] : [currentChat],
        chatType: currentChat === "admin-group" ? "group" : "private"
      };
      
      if (currentChat === "admin-group") {
        messageData.receiverId = "admin-group";
      } else {
        messageData.receiverId = currentChat;
      }
      
      if (fileUrl) {
        messageData.fileUrl = fileUrl;
        messageData.fileName = fileInput.files[0]?.name || "ÙØ§ÛŒÙ„";
      }
      
      if (replyTo) {
        messageData.replyTo = replyTo.id;
        messageData.replyText = replyTo.text;
      }
      
      await db.collection("schoolChat").add(messageData);
      
      // Ø¯ Ø§Ù†Ù¾Ù¼ Ù¾Ø§Ú©ÙˆÙ„
      document.getElementById('msgInput').value = "";
      replyTo = null;
      document.getElementById('replyBox').style.display = "none";
      
    } catch (error) {
      console.error("Ø¯ Ù¾ÛŒØºØ§Ù… Ø³ØªÙˆÙ†Ø²Ù‡:", error);
      alert("Ù¾ÛŒØºØ§Ù… ÙˆÙ†Ù‡ Ø§Ø³ØªÙˆÙ„ Ø´Ùˆ: " + error.message);
    } finally {
      sendBtn.disabled = false;
      sendBtn.innerHTML = "ğŸ“¤ Ø§Ø³ØªÙˆÙ„";
    }
  }

  // ==================== Ø¯ ÙØ§ÛŒÙ„ Ø§Ø³ØªÙˆÙ„ ====================
  async function sendFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = "â³ ÙØ§ÛŒÙ„ Ø§Ø³ØªÙˆÙ„ Ú©ÛÚ–ÙŠ...";
    
    try {
      const storageRef = storage.ref(`chat-files/${Date.now()}_${file.name}`);
      const uploadTask = await storageRef.put(file);
      const fileUrl = await uploadTask.ref.getDownloadURL();
      
      const messageData = {
        senderId: "admin",
        senderName: "Ù…Ø¯ÛŒØ±",
        fileUrl: fileUrl,
        fileName: file.name,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        readBy: ["admin"],
        deliveredTo: currentChat === "admin-group" ? ["admin"] : [currentChat],
        chatType: currentChat === "admin-group" ? "group" : "private"
      };
      
      if (currentChat === "admin-group") {
        messageData.receiverId = "admin-group";
      } else {
        messageData.receiverId = currentChat;
      }
      
      await db.collection("schoolChat").add(messageData);
      
    } catch (error) {
      console.error("Ø¯ ÙØ§ÛŒÙ„ Ø³ØªÙˆÙ†Ø²Ù‡:", error);
      alert("ÙØ§ÛŒÙ„ ÙˆÙ†Ù‡ Ø§Ø³ØªÙˆÙ„ Ø´Ùˆ: " + error.message);
    } finally {
      sendBtn.disabled = false;
      sendBtn.innerHTML = "ğŸ“¤ Ø§Ø³ØªÙˆÙ„";
      event.target.value = "";
    }
  }

  // ==================== Ø¯ ÚÙˆØ§Ø¨ ØªÙ†Ø¸ÛŒÙ…ÙˆÙ„ ====================
  function setReply(id, text) {
    replyTo = { id: id, text: text };
    document.getElementById('replyText').innerText = "ÚÙˆØ§Ø¨ ÙˆØ±Ú©ÙˆÙ„: " + (text.length > 50 ? text.substring(0, 50) + "..." : text);
    document.getElementById('replyBox').style.display = "flex";
  }

  function clearReply() {
    replyTo = null;
    document.getElementById('replyBox').style.display = "none";
  }

  // ==================== Ø¯ Enter Ú©Û Ø¯ Ø§Ø³ØªÙˆÙ„Ùˆ Ù…Ù„Ø§ØªÚ“ ====================
  function handleEnter(event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  }

  // ==================== Ø¯ Ù†Ø§Ù„ÛŒØ¯Ù„Ùˆ Ø´Ù…ÛØ± Ù…ÙˆÙ†Ø¯Ù„ ====================
  function getUnreadCount(teacherId) {
    // Ù¾Ù‡ Ø¹Ù…Ù„ÙŠ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ú©ÛØŒ Ø¯Ø§ Ø¯ Ú‰ÛŒÙ¼Ø§Ø¨ÛŒØ³ Ú…Ø®Ù‡ Ø±Ø§ÙˆØ³ØªÙ„ Ú©ÛÚ–ÙŠ
    return 0;
  }

  // ==================== Ø¯ Ù†Ø§Ù„ÛŒØ¯Ù„Ùˆ Ù†ÚšÛ ØªØ§Ø²Ù‡ Ú©ÙˆÙ„ ====================
  function updateUnreadBadge() {
    // Ø¯Ù„ØªÙ‡ Ø¯ Ù†ÙˆÙ¼ÛŒÙÛŒÚ©ÛŒØ´Ù†ÙˆÙ†Ùˆ Ù…Ù†Ø·Ù‚ Ø§Ø¶Ø§ÙÙ‡ Ú©ÙˆÙ„ÛŒ Ø´Ø¦
  }

  // ==================== Ø¯ Ù¾ÛŒØºØ§Ù…ÙˆÙ†Ùˆ Ø¯ Ù„ÛŒØ¯Ù„Ùˆ Ù†ÚšÙ‡ Ú©ÙˆÙ„ ====================
  async function markMessagesAsRead(teacherId) {
    try {
      const snapshot = await db.collection("schoolChat")
        .where("senderId", "==", teacherId)
        .where("readBy", "not-in", [["admin"]])
        .get();
      
      const batch = db.batch();
      snapshot.forEach(doc => {
        const msg = doc.data();
        const readBy = msg.readBy || [];
        if (!readBy.includes("admin")) {
          readBy.push("admin");
          batch.update(doc.ref, { readBy: readBy });
        }
      });
      
      if (snapshot.size > 0) {
        await batch.commit();
      }
    } catch (error) {
      console.error("Ø¯ Ù„ÛŒØ¯Ù„Ùˆ Ù†ÚšÛ Ø³ØªÙˆÙ†Ø²Ù‡:", error);
    }
  }

  // ==================== Ø¯ ØªÚ« Ø´Ø§ØªÙ‡ ====================
  function goBack() {
    window.location.href = "admin_dashboard.html";
  }

  // ==================== Ù¾ÛŒÙ„ Ú©ÙˆÙ„ ====================
  window.onload = function() {
    loadTeachers();
    loadMessages();
    
    // Ù¾Ù‡ Ø§ØªÙˆÙ…Ø§Øª Ú‰ÙˆÙ„ Ú«Ø±ÙˆÙ¾ Ú†Ù¼ Ø®Ù„Ø§Øµ Ú©Ú“Ø¦
    openGroupChat();
  };
</script>

</body>
</html>