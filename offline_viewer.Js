/* Ø¯ Offline Viewer Ø§ØµÙ„ÙŠ Ø³ÛŒØ³ØªÙ… */

class OfflineViewer {
    constructor() {
        this.viewerData = {};
        this.init();
    }

    async init() {
        console.log('ğŸ“– Offline Viewer Ù¾ÛŒÙ„ÛÚ–ÙŠ...');
        
        // Ø¯ Offline Ú‰ÛŒÙ¼Ø§ Ú†Ø§Ø±Ø¬ÙˆÙ„
        await this.loadOfflineViewerData();
        
        // Ø¯ Offline Viewer UI Ø¬ÙˆÚ“ÙˆÙ„
        this.setupOfflineViewerUI();
        
        // Ø¯ Offline Navigation ØªÙ†Ø¸ÛŒÙ…ÙˆÙ„
        this.setupOfflineNavigation();
    }

    // ==================== Offline Data Loading ====================

    async loadOfflineViewerData() {
        console.log('ğŸ’¾ Ø¯ Offline Viewer Ú‰ÛŒÙ¼Ø§ Ú†Ø§Ø±Ø¬ÛÚ–ÙŠ...');
        
        // Ø¯ Critical Ú‰ÛŒÙ¼Ø§ Ú†Ø§Ø±Ø¬ÙˆÙ„
        await this.loadCriticalData();
        
        // Ø¯ Cached Ù¾Ø§Ú¼Ùˆ Ú†Ø§Ø±Ø¬ÙˆÙ„
        await this.loadCachedPages();
        
        // Ø¯ Sample Ú‰ÛŒÙ¼Ø§ Ú†Ø§Ø±Ø¬ÙˆÙ„ (Ú©Ù‡ Ú†ÛŒØ±Û ÙˆØ§Ù‚Ø¹ÙŠ Ú‰ÛŒÙ¼Ø§ Ù†Ù‡ ÙˆÙŠ)
        await this.loadSampleData();
        
        console.log('âœ… Offline Viewer Ú‰ÛŒÙ¼Ø§ Ú†Ø§Ø±Ø¬ Ø´Ùˆ:', this.viewerData);
    }

    async loadCriticalData() {
        // Ø¯ Ø§Ú“ÛŒÙ†Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙˆ Ú†Ø§Ø±Ø¬ÙˆÙ„
        this.viewerData.critical = {
            userInfo: {
                name: localStorage.getItem('userName') || 'Ú©Ø§Ø±ÙˆÙ†Ú©ÛŒ',
                role: localStorage.getItem('userRole') || 'Ú«ÙˆÚšÙ‡',
                photo: localStorage.getItem('userPhoto') || 'https://via.placeholder.com/40'
            },
            schoolInfo: {
                name: 'Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© Ù„ÛŒØ³Ù‡',
                address: 'Ú©Ù†Ø¯Ù‡Ø§Ø±ØŒ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†',
                phone: '+93 70 123 4567',
                lastSync: localStorage.getItem('lastSync') || 'Ù†Ù‡ Ø¯ÛŒ ØªØ§Ø²Ù‡ Ø´ÙˆÛŒ'
            },
            systemInfo: {
                mode: 'offline',
                lastUpdated: new Date().toLocaleDateString('fa-AF'),
                dataSource: 'cached'
            }
        };
    }

    async loadCachedPages() {
        if ('caches' in window) {
            try {
                const cache = await caches.open('baba-hotak-cache-v2');
                this.viewerData.cachedPages = {};
                
                // Ø¯ Ø§Ú“ÛŒÙ†Ùˆ Ù¾Ø§Ú¼Ùˆ Ù„ÛŒØ³Øª
                const essentialPages = [
                    'index.html',
                    'admin_dashboard.html',
                    'teacher_dashboard.html',
                    'student_dashboard.html',
                    'students.html',
                    'attendance.html',
                    'finance.html',
                    'results.html'
                ];
                
                for (const page of essentialPages) {
                    const response = await cache.match('/' + page);
                    if (response) {
                        this.viewerData.cachedPages[page] = true;
                    }
                }
                
            } catch (error) {
                console.error('âŒ Ø¯ Cached Pages Ú†Ø§Ø±Ø¬ Ø³ØªÙˆÙ†Ø²Ù‡:', error);
            }
        }
    }

    async loadSampleData() {
        // Ø¯ Offline Viewer Ù„Ù¾Ø§Ø±Ù‡ Sample Ú‰ÛŒÙ¼Ø§
        this.viewerData.sample = {
            students: this.getSampleStudents(),
            attendance: this.getSampleAttendance(),
            marks: this.getSampleMarks(),
            finance: this.getSampleFinance()
        };
    }

    getSampleStudents() {
        return [
            { id: 1, name: 'Ø§Ø­Ù…Ø¯ ÙˆÙ„ÙŠ', grade: 'Ù†Ù‡Ù…', section: 'Ø§Ù„Ù', phone: '0701234567' },
            { id: 2, name: 'Ù…Ø­Ù…Ø¯ Ø§Ù†ÙˆØ±', grade: 'Ù†Ù‡Ù…', section: 'Ø§Ù„Ù', phone: '0702345678' },
            { id: 3, name: 'Ú«Ù„ Ø®Ø§Ù†', grade: 'Ù†Ù‡Ù…', section: 'Ø¨', phone: '0703456789' },
            { id: 4, name: 'Ø´ÛØ±Ø²Ø§Ø¯', grade: 'Ù†Ù‡Ù…', section: 'Ø¨', phone: '0704567890' }
        ];
    }

    getSampleAttendance() {
        const today = new Date().toLocaleDateString('fa-AF');
        return {
            date: today,
            stats: {
                present: 85,
                absent: 5,
                leave: 2,
                total: 92
            },
            byGrade: {
                'Ù†Ù‡Ù…': { present: 45, absent: 3 },
                'Ù„Ø³Ù…': { present: 40, absent: 2 }
            }
        };
    }

    getSampleMarks() {
        return [
            { student: 'Ø§Ø­Ù…Ø¯ ÙˆÙ„ÙŠ', subject: 'Ø±ÛŒØ§Ø¶ÙŠ', mark: 85, grade: 'A' },
            { student: 'Ù…Ø­Ù…Ø¯ Ø§Ù†ÙˆØ±', subject: 'Ù¾ÚšØªÙˆ', mark: 92, grade: 'A+' },
            { student: 'Ú«Ù„ Ø®Ø§Ù†', subject: 'Ú©ÛŒÙ…ÛŒØ§', mark: 78, grade: 'B' },
            { student: 'Ø´ÛØ±Ø²Ø§Ø¯', subject: 'ÙØ²ÛŒÚ©', mark: 88, grade: 'A' }
        ];
    }

    getSampleFinance() {
        return {
            totalIncome: 150000,
            totalExpense: 120000,
            netProfit: 30000,
            byMonth: {
                Ø­Ù…Ù„: 45000,
                Ø«ÙˆØ±: 48000,
                Ø¬ÙˆØ²Ø§: 52000,
                Ø³Ø±Ø·Ø§Ù†: 50000
            }
        };
    }

    // ==================== Offline Viewer UI ====================

    setupOfflineViewerUI() {
        // Ø¯ Offline Viewer Dashboard Ø¬ÙˆÚ“ÙˆÙ„
        this.createOfflineDashboard();
        
        // Ø¯ Offline Stats ÚšÚ©Ø§Ø±Ù‡ Ú©ÙˆÙ„
        this.showOfflineStats();
        
        // Ø¯ Offline Navigation Menu
        this.createOfflineNavMenu();
    }

    createOfflineDashboard() {
        // Ú©Ù‡ Ø¯Ø§ Dashboard Ù¾Ø§Ú¼Ù‡ ÙˆÙŠ
        if (document.querySelector('.dashboard-container')) {
            this.enhanceDashboardForOffline();
        }
    }

    enhanceDashboardForOffline() {
        const dashboard = document.querySelector('.dashboard-container');
        if (!dashboard) return;
        
        // Ø¯ Offline Viewer Header Ø§Ø¶Ø§ÙÙ‡ Ú©ÙˆÙ„
        const offlineHeader = document.createElement('div');
        offlineHeader.className = 'offline-viewer-header';
        offlineHeader.style.cssText = `
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        `;
        
        offlineHeader.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom:10px;">
                <span style="font-size:40px;">ğŸ“–</span>
                <div>
                    <h3 style="margin:0; font-size:18px;">Offline Viewer Mode</h3>
                    <small style="opacity:0.8;">ØªØ§Ø³Ùˆ ÛŒÙˆØ§Ø²Û Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÚ«ÙˆØ±Ø¦</small>
                </div>
            </div>
            <p style="margin:0; font-size:13px; opacity:0.9;">
                Ø¯ Ø§Ù†Ù¼Ø±Ù†Ù¼ Ø§ØªØµØ§Ù„ ÙˆØµÙ„ Ú©Ú“Ø¦ ØªØ±Ú…Ùˆ ØªØºÛŒØ±Ø§Øª ÙˆÚ©Ú“Ø¦
            </p>
        `;
        
        dashboard.insertBefore(offlineHeader, dashboard.firstChild);
        
        // Ø¯ Offline Cards Ø§Ø¶Ø§ÙÙ‡ Ú©ÙˆÙ„
        this.addOfflineCards(dashboard);
    }

    addOfflineCards(dashboard) {
        const cardsContainer = document.createElement('div');
        cardsContainer.className = 'offline-cards-container';
        cardsContainer.style.cssText = `
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        `;
        
        const cards = [
            {
                title: 'Ø´Ø§Ú«Ø±Ø¯Ø§Ù†',
                count: this.viewerData.sample?.students?.length || 0,
                icon: 'ğŸ‘¥',
                color: '#3498db',
                description: 'Ù¾Ù‡ Offline Ú©Û Ø´ØªÙˆÙ† Ù„Ø±ÙŠ'
            },
            {
                title: 'ÙˆØ±ÚÙ†ÛŒ Ø­Ø§Ø¶Ø±ÙŠ',
                count: this.viewerData.sample?.attendance?.stats?.present || 0,
                icon: 'âœ…',
                color: '#2ecc71',
                description: 'Ø¯ Ù†Ù† Ù„Ù¾Ø§Ø±Ù‡'
            },
            {
                title: 'Ù†Ù…Ø±Û',
                count: this.viewerData.sample?.marks?.length || 0,
                icon: 'ğŸ“Š',
                color: '#9b59b6',
                description: 'Ù†Ù…ÙˆÙ†Û Ú‰ÛŒÙ¼Ø§'
            },
            {
                title: 'Ø¹Ø§ÛŒØ¯',
                count: (this.viewerData.sample?.finance?.totalIncome || 0) + ' AFN',
                icon: 'ğŸ’°',
                color: '#f39c12',
                description: 'Ù…ÛŒØ§Ø´ØªÙ†ÛŒ'
            }
        ];
        
        cards.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.style.cssText = `
                background: white;
                padding: 15px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                text-align: center;
                border-top: 4px solid ${card.color};
            `;
            
            cardElement.innerHTML = `
                <div style="font-size:30px; margin-bottom:10px;">${card.icon}</div>
                <h4 style="margin:0 0 5px 0; color:#2c3e50;">${card.title}</h4>
                <div style="font-size:24px; font-weight:bold; color:${card.color}; margin:10px 0;">
                    ${card.count}
                </div>
                <small style="color:#7f8c8d; font-size:11px;">${card.description}</small>
            `;
            
            cardsContainer.appendChild(cardElement);
        });
        
        // Ø¯ Dashboard ÙˆØ±ÙˆØ³ØªÛŒ Ø¨Ø±Ø®Ù‡ Ú©Û Ø§Ø¶Ø§ÙÙ‡ Ú©ÙˆÙ„
        const statsSection = dashboard.querySelector('.stats-grid, .stats-row');
        if (statsSection) {
            statsSection.parentNode.insertBefore(cardsContainer, statsSection.nextSibling);
        } else {
            const header = dashboard.querySelector('.offline-viewer-header');
            if (header) {
                header.parentNode.insertBefore(cardsContainer, header.nextSibling);
            }
        }
    }

    showOfflineStats() {
        // Ø¯ Offline Statistics Ù¾Ù‡ Footer Ú©Û ÚšÚ©Ø§Ø±Ù‡ Ú©ÙˆÙ„
        const footer = document.querySelector('footer, .footer') || document.body;
        
        const statsFooter = document.createElement('div');
        statsFooter.className = 'offline-stats-footer';
        statsFooter.style.cssText = `
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 15px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 9995;
        `;
        
        statsFooter.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="color:#e74c3c;">â—</span>
                <span>Offline Viewer</span>
            </div>
            <div style="display:flex; gap:15px;">
                <span>ğŸ‘¥ ${this.viewerData.sample?.students?.length || 0} Ø´Ø§Ú«Ø±Ø¯Ø§Ù†</span>
                <span>âœ… ${this.viewerData.sample?.attendance?.stats?.present || 0} Ø­Ø§Ø¶Ø±</span>
                <span>ğŸ’° ${this.viewerData.sample?.finance?.totalIncome || 0} Ø¹Ø§ÛŒØ¯</span>
            </div>
            <div>
                <small style="opacity:0.7;">Ø¢Ø®Ø± ØªØ§Ø²Ù‡: ${new Date().toLocaleTimeString('ps-AF', {hour: '2-digit', minute:'2-digit'})}</small>
            </div>
        `;
        
        footer.appendChild(statsFooter);
    }

    createOfflineNavMenu() {
        // Ø¯ Offline Navigation Ù¾Ù‡ Sidebar ÛŒØ§ Header Ú©Û
        const sidebar = document.querySelector('.sidebar, .menu-grid, .dashboard-header');
        if (!sidebar) return;
        
        const offlineNav = document.createElement('div');
        offlineNav.className = 'offline-nav-section';
        offlineNav.style.cssText = `
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px dashed #dee2e6;
        `;
        
        offlineNav.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <span style="font-size:20px;">ğŸ“´</span>
                <strong style="font-size:14px;">Offline Navigation</strong>
            </div>
            <div style="font-size:12px; color:#666;">
                Ù¾Ù‡ Offline Ú©Û Ù„Ø§Ø³Ø±Ø³ÛŒ:
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">
                ${this.getAvailableOfflinePages().map(page => `
                    <a href="${page.url}" 
                       style="background:#e9ecef; color:#495057; padding:5px 10px; border-radius:5px; text-decoration:none; font-size:11px;">
                        ${page.name}
                    </a>
                `).join('')}
            </div>
        `;
        
        sidebar.appendChild(offlineNav);
    }

    getAvailableOfflinePages() {
        // Ø¯ Offline Ù¾Ù‡ Ø­Ø§Ù„Øª Ú©Û Ø¯ Ù„Ø§Ø³Ø±Ø³ÙŠ ÙˆÚ“ Ù¾Ø§Ú¼Û
        return [
            { name: 'Ú‰Ø´Ø¨ÙˆØ±Ú‰', url: 'index.html' },
            { name: 'Ø´Ø§Ú«Ø±Ø¯Ø§Ù†', url: 'students.html' },
            { name: 'Ø­Ø§Ø¶Ø±ÙŠ', url: 'attendance.html' },
            { name: 'Ù…Ø§Ù„ÙŠ', url: 'finance.html' },
            { name: 'Ù†ØªØ§ÛŒØ¬', url: 'results.html' }
        ];
    }

    // ==================== Offline Navigation ====================

    setupOfflineNavigation() {
        // Ø¯ Offline Ù„Ù¾Ø§Ø±Ù‡ Navigation Ù…Ø­Ø¯ÙˆØ¯ÙˆÙ„
        this.limitNavigationForOffline();
        this.setupOfflineBackButton();
    }

    limitNavigationForOffline() {
        // Ø¯ Online ÛŒÙˆØ§Ø²Û Ù¾Ø§Ú¼Ùˆ Ù…Ø®Ù†ÛŒÙˆÛŒ
        const onlineOnlyLinks = document.querySelectorAll('[data-online-only]');
        onlineOnlyLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                if (hybridSystem.getCurrentMode() === 'offline') {
                    e.preventDefault();
                    this.showOnlineOnlyMessage(link.textContent);
                }
            });
            
            link.style.opacity = '0.5';
            link.style.pointerEvents = 'none';
            link.title = 'Ù¾Ù‡ Online Ø­Ø§Ù„Øª Ú©Û ÛŒÙˆØ§Ø²Û';
        });
    }

    showOnlineOnlyMessage(featureName) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 300px;
        `;
        
        content.innerHTML = `
            <span style="font-size:48px; display:block; margin-bottom:15px;">ğŸŒ</span>
            <h3 style="margin:0 0 10px 0; color:#2c3e50;">Online Feature</h3>
            <p style="color:#666; margin-bottom:20px;">
                "${featureName}" ÛŒÙˆØ§Ø²Û Ù¾Ù‡ Online Ø­Ø§Ù„Øª Ú©Û Ù„Ø§Ø³Ø±Ø³ÛŒ Ù„Ø±ÙŠ.
                Ù…Ù‡Ø±Ø¨Ø§Ù†ÙŠ ÙˆÚ©Ú“Ø¦ Ø§Ù†Ù¼Ø±Ù†Ù¼ Ø§ØªØµØ§Ù„ ÙˆØµÙ„ Ú©Ú“Ø¦.
            </p>
            <button onclick="this.closest('div').parentNode.remove()"
                    style="background:#3498db; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">
                Ù¾ÙˆÙ‡ Ø´ÙˆÙ…
            </button>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // Ø¯ Ú©Ù„ÛŒÚ© Ø®Ø§Ø±Ø¬ Modal Ø¨Ù†Ø¯ÙˆÙ„
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    setupOfflineBackButton() {
        // Ø¯ Offline Back Button Ù¾Ù‡ Ù‡Ø±Ù‡ Ù¾Ø§Ú¼Ù‡ Ú©Û
        if (window.location.pathname !== '/index.html' && 
            window.location.pathname !== '/' &&
            hybridSystem.getCurrentMode() === 'offline') {
            
            const backBtn = document.createElement('button');
            backBtn.innerHTML = 'ğŸ  Ø§ØµÙ„ÙŠ Ù¾Ø§Ú¼Ù‡';
            backBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 25px;
                cursor: pointer;
                font-weight: bold;
                font-size: 12px;
                z-index: 9996;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 5px;
            `;
            
            backBtn.onclick = () => window.location.href = 'index.html';
            document.body.appendChild(backBtn);
        }
    }

    // ==================== Public API ====================

    getViewerData() {
        return this.viewerData;
    }

    refreshViewerData() {
        return this.loadOfflineViewerData();
    }

    isPageAvailableOffline(pageUrl) {
        return this.viewerData.cachedPages && 
               this.viewerData.cachedPages[pageUrl.replace('.html', '')];
    }

    getOfflineStatus() {
        return {
            mode: 'viewer',
            dataAvailable: Object.keys(this.viewerData).length > 0,
            lastUpdated: new Date().toISOString(),
            pages: Object.keys(this.viewerData.cachedPages || {}).length
        };
    }
}

// Ø¯ Global Instance Ø¬ÙˆÚ“ÙˆÙ„
window.offlineViewer = new OfflineViewer();

console.log('ğŸ“š Offline Viewer Ú†Ù…ØªÙˆ Ø¯ÛŒ!');