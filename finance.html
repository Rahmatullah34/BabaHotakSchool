<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© - Ù…Ø§Ù„ÙŠ Ù…Ø¯ÛŒØ±ÛŒØª</title>
    <style>
        :root {
            --primary: #4A90E2; 
            --success: #2ecc71; 
            --danger: #e74c3c;
            --bg: #F0F4F8; 
            --card-bg: #FFFFFF; 
            --text: #334E68;
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }

        /* Û±. Ø¹ØµØ±ÙŠ Ø¨Ù¼Ù†ÙˆÙ†Ù‡ Ø§Ùˆ Ù†ÛŒÙˆÛŒÚ«ÛŒØ´Ù† */
        .back-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-btn { background: var(--card-bg); border: none; padding: 10px 15px; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-weight: bold; }

        /* Û². Ø¯ Ø§Ø­ØµØ§ÛŒÛ Ú©Ø§Ø±ØªÙˆÙ†Ù‡ */
        .header-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 20px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .stat-card b { font-size: 16px; display: block; margin-top: 5px; }

        /* Û³. Ø¯ ÙØ§Ø±Ù…ÙˆÙ†Ùˆ Ù†ÙˆÛŒ Ú‰ÛŒØ²Ø§ÛŒÙ† */
        .forms-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        @media (max-width: 600px) { .forms-grid { grid-template-columns: 1fr; } }
        
        .glass-container { background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); }
        .glass-container h3 { margin: 0 0 15px 0; font-size: 15px; border-right: 4px solid var(--primary); padding-right: 10px; }

        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1.5px solid #E1E8F0; background: #F8FAFC; margin-bottom: 10px; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; background: #FFF; }

        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }

        /* Û´. Ø¹ØµØ±ÙŠ Ø¬Ø¯ÙˆÙ„ */
        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 10px; }
        .modern-table th { padding: 10px; font-size: 13px; color: #829AB1; text-align: right; }
        .modern-table tr { background: var(--card-bg); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .modern-table td { padding: 12px; border: none; }
        .modern-table td:first-child { border-radius: 0 12px 12px 0; }
        .modern-table td:last-child { border-radius: 12px 0 0 12px; }

        .badge { padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; }
        .badge-paid { background: #D1FAE5; color: #065F46; }
        .badge-unpaid { background: #FEE2E2; color: #991B1B; }

        .filter-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="back-nav">
    <h2 style="font-size: 20px; margin: 0;">ğŸ’° Ù…Ø§Ù„ÙŠ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ùˆ Ù…ØµØ§Ø±Ù</h2>
    <div>
        <button onclick="window.print()" class="nav-btn">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
        <button onclick="window.history.back()" class="nav-btn">â¬…ï¸ Ø´Ø§ØªÙ‡</button>
    </div>
</div>

<div class="header-stats">
    <div class="stat-card" style="border-top: 4px solid var(--success);">
        <small>Ù¼ÙˆÙ„ ÙÛŒØ³ÙˆÙ†Ù‡</small><b id="totalCol" style="color: var(--success);">0 AFN</b>
    </div>
    <div class="stat-card" style="border-top: 4px solid var(--danger);">
        <small>Ø®Ø§Ù„Øµ Ø¹Ø§ÛŒØ¯</small><b id="totalOut" style="color: var(--primary);">0 AFN</b>
    </div>
    <div class="stat-card" style="border-top: 4px solid var(--primary);">
        <small>Ù¼ÙˆÙ„ Ù…ØµØ§Ø±Ù</small><b id="totalExp" style="color: var(--danger);">0 AFN</b>
    </div>
</div>

<div class="forms-grid">
    <div class="glass-container">
        <h3 style="border-color: var(--success); color: var(--success);">ğŸ“¥ Ø¯ ÙÛŒØ³ ØªØ±Ù„Ø§Ø³Ù‡ Ú©ÙˆÙ„</h3>
        <input type="number" id="fAsas" placeholder="Ø§Ø³Ø§Ø³ Ù†Ù…Ø¨Ø±..." oninput="findStudentName()">
        <div id="stNameBox" style="font-size:12px; color:var(--primary); margin-bottom:10px; font-weight:bold;">Ø¯ Ø²Ø¯Ù‡ Ú©ÙˆÙˆÙ†Ú©ÙŠ Ù†ÙˆÙ…: ---</div>
        <input type="number" id="fAmount" placeholder="Ù…Ù‚Ø¯Ø§Ø± (AFN)...">
        <select id="fMonth">
            <option value="">Ù…ÛŒØ§Ø´Øª ÙˆÙ¼Ø§Ú©Ø¦</option>
            <option>Ø­Ù…Ù„</option><option>Ø«ÙˆØ±</option><option>Ø¬ÙˆØ²Ø§</option><option>Ø³Ø±Ø·Ø§Ù†</option>
            <option>Ø§Ø³Ø¯</option><option>Ø³Ù†Ø¨Ù„Ù‡</option><option>Ù…ÛŒØ²Ø§Ù†</option><option>Ø¹Ù‚Ø±Ø¨</option>
            <option>Ù‚ÙˆØ³</option><option>Ø¬Ø¯ÙŠ</option><option>Ø¯Ù„Ùˆ</option><option>Ø­ÙˆØª</option>
        </select>
        <button onclick="savePayment()" class="btn-action btn-success">âœ… ØªØ±Ù„Ø§Ø³Ù‡ Ø§Ùˆ Ø±Ø³ÛŒØ¯ Ù„ÛÚ–Ù„</button>
    </div>

    <div class="glass-container">
        <h3 style="border-color: var(--danger); color: var(--danger);">ğŸ“¤ Ø¯ Ù„Ú«ÚšØª Ø«Ø¨ØªÙˆÙ„ (Expense)</h3>
        <input type="text" id="eType" placeholder="Ø¯ Ù…ØµØ±Ù Ú‰ÙˆÙ„ (Ù…Ø¹Ø§Ø´ØŒ Ø¨Ø±Ù‚...)">
        <input type="number" id="eAmount" placeholder="Ù…Ù‚Ø¯Ø§Ø±...">
        <input type="date" id="eDate">
        <button onclick="saveExpense()" class="btn-action btn-danger">â• Ø¯ Ù„Ú«ÚšØª Ø«Ø¨ØªÙˆÙ„</button>
    </div>
</div>

<div class="filter-buttons">
    <button onclick="loadFinanceData()" class="nav-btn">ğŸ“‹ Ù¼ÙˆÙ„ Ø±Ø§Ú©Ú“Ù‡ ÙˆØ±Ú©Ú“Ù‡</button>
</div>

<table class="modern-table" id="fTable">
    <thead>
        <tr>
            <th>Ù†ÙˆÙ…/ØªÙØµÛŒÙ„</th>
            <th>Ù…ÛŒØ§Ø´Øª/Ù†ÛŒÙ¼Ù‡</th>
            <th>Ù…Ù‚Ø¯Ø§Ø±</th>
            <th>Ø­Ø§Ù„Øª</th>
        </tr>
    </thead>
    <tbody id="fTableBody">
        </tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<script>
  // Û². ÙØ§ÛŒØ±Ø¨ÛŒØ³ Config
  const firebaseConfig = {
    apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
    authDomain: "babahotakschool.firebaseapp.com",
    projectId: "babahotakschool",
    storageBucket: "babahotakschool.firebasestorage.app",
    messagingSenderId: "12958892996",
    appId: "1:12958892996:web:477e44b4453a0fbd9b9a91",
    measurementId: "G-28QZY65DZE"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Û³. Ø¯ Ø§Ø³Ø§Ø³ Ù†Ù…Ø¨Ø± Ù„Ù‡ Ù…Ø®Û Ø¯ Ø²Ø¯Ù‡ Ú©ÙˆÙˆÙ†Ú©ÙŠ Ù†ÙˆÙ… Ù¾ÛŒØ¯Ø§ Ú©ÙˆÙ„
  async function findStudentName() {
    const asas = document.getElementById('fAsas').value;
    const nameBox = document.getElementById('stNameBox');
    
    if (asas.length > 0) {
      try {
        const snapshot = await db.collection("babaStudents").where("asas", "==", asas).get();
        if (!snapshot.empty) {
          const student = snapshot.docs[0].data();
          nameBox.innerText = "Ø´Ø§Ú«Ø±Ø¯: " + student.name;
          nameBox.style.color = "var(--success)";
          nameBox.setAttribute('data-phone', student.phone || '');
        } else {
          nameBox.innerText = "Ø´Ø§Ú«Ø±Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ùˆ! âŒ";
          nameBox.style.color = "var(--danger)";
        }
      } catch (e) { console.error(e); }
    }
  }

  // Û´. Ø¯ ÙÛŒØ³ Ø®ÙˆÙ†Ø¯ÙŠ Ú©ÙˆÙ„
  async function savePayment() {
    const asas = document.getElementById('fAsas').value;
    const amount = document.getElementById('fAmount').value;
    const month = document.getElementById('fMonth').value;
    const stName = document.getElementById('stNameBox').innerText;
    const phone = document.getElementById('stNameBox').getAttribute('data-phone');

    if (!asas || !amount || !month || stName.includes("Ù¾ÛŒØ¯Ø§ Ù†Ø´Ùˆ")) {
      alert("Ù…Ù‡Ø±Ø¨Ø§Ù†ÙŠ ÙˆÚ©Ú“Ø¦ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù¾ÙˆØ±Ù‡ Ú©Ú“Ø¦!");
      return;
    }

    try {
      await db.collection("babaFinance").add({
        type: "income",
        asas: asas,
        name: stName.replace("Ø´Ø§Ú«Ø±Ø¯: ", ""),
        amount: Number(amount),
        month: month,
        date: new Date().toLocaleDateString('fa-AF'),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // ÙˆØ§Ù¼Ø³Ø§Ù¾ Ù¾ÛŒØºØ§Ù…
      if (phone) {
          const msg = `Ù…Ø­ØªØ±Ù… Ù¾Ù„Ø§Ø±! Ø¯ ${stName} Ø¯ ${month} Ù…ÛŒØ§Ø´ØªÛ ÙÛŒØ³ (${amount} AFN) ØªØ±Ù„Ø§Ø³Ù‡ Ø´Ùˆ. Ù…Ù†Ù†Ù‡ - Ø¯ Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© Ù„ÛŒØ³Ù‡.`;
          window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
      }

      alert("ÙÛŒØ³ Ù¾Ù‡ Ø¨Ø±ÛŒØ§Ù„ÛŒØªÙˆØ¨ Ø³Ø±Ù‡ Ø«Ø¨Øª Ø´Ùˆ! âœ…");
      location.reload();
    } catch (e) { alert("Ø®Ø·Ø§: " + e.message); }
  }

  // Ûµ. Ø¯ Ù„Ú«ÚšØª Ø«Ø¨ØªÙˆÙ„
  async function saveExpense() {
    const type = document.getElementById('eType').value;
    const amount = document.getElementById('eAmount').value;
    const date = document.getElementById('eDate').value;

    if (!type || !amount) {
      alert("Ø¯ Ù…ØµØ±Ù Ù¼ÙˆÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÙ„ÛŒÚ©Ø¦!");
      return;
    }

    try {
      await db.collection("babaFinance").add({
        type: "expense",
        name: type,
        amount: Number(amount),
        date: date || new Date().toLocaleDateString('fa-AF'),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Ù…ØµØ±Ù Ø«Ø¨Øª Ø´Ùˆ! âœ…");
      location.reload();
    } catch (e) { alert("Ø®Ø·Ø§: " + e.message); }
  }

  // Û¶. Ø¯ Ø§Ø±Ù‚Ø§Ù…Ùˆ Ø§Ùˆ Ø¬Ø¯ÙˆÙ„ Ø±Ø§ÙˆØ³ØªÙ„ (Real-time)
  function loadFinanceData() {
    db.collection("babaFinance").orderBy("timestamp", "desc").onSnapshot(snap => {
      let income = 0;
      let expense = 0;
      const tableBody = document.getElementById('fTableBody');
      tableBody.innerHTML = "";

      snap.forEach(doc => {
        const d = doc.data();
        if (d.type === "income") {
          income += d.amount;
          tableBody.innerHTML += `
            <tr>
                <td>${d.name}</td>
                <td>${d.month}</td>
                <td>${d.amount}</td>
                <td><span class="badge badge-paid">ÙÛŒØ³</span></td>
            </tr>`;
        } else {
          expense += d.amount;
          tableBody.innerHTML += `
            <tr style="background:#fff5f5;">
                <td>${d.name}</td>
                <td>${d.date}</td>
                <td>${d.amount}</td>
                <td><span class="badge badge-unpaid">Ù…ØµØ±Ù</span></td>
            </tr>`;
        }
      });

      document.getElementById('totalCol').innerText = income + " AFN";
      document.getElementById('totalExp').innerText = expense + " AFN";
      document.getElementById('totalOut').innerText = (income - expense) + " AFN";
    });
  }

  window.onload = loadFinanceData;
</script>

</body>
</html>
