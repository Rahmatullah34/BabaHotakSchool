<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ ØºÛŒØ±Ø­Ø§Ø¶Ø±Ø§Ù†Ùˆ Ø±Ø§Ù¾ÙˆØ± - Ù…Ø¯ÛŒØ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --danger: #e74c3c; --warning: #f1c40f; --primary: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; direction: rtl; margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); margin-bottom: 20px; padding-bottom: 10px; }
        
        .filter-box { background: #eef2f3; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 10px; }
        input[type="date"] { padding: 10px; border-radius: 8px; border: 1px solid #ddd; flex: 1; }
        
        .absent-card { border: 1px solid #eee; border-right: 5px solid var(--danger); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .absent-card.leave { border-right-color: var(--warning); }
        
        .info h4 { margin: 0 0 5px 0; color: #2c3e50; }
        .info p { margin: 0; font-size: 13px; color: #7f8c8d; }
        
        .status-tag { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; color: white; }
        .tag-absent { background: var(--danger); }
        .tag-leave { background: var(--warning); color: #000; }
        
        .whatsapp-btn { background: #25D366; color: white; text-decoration: none; padding: 8px 12px; border-radius: 5px; font-size: 12px; }
        .no-data { text-align: center; padding: 40px; color: #95a5a6; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h3>ğŸ“Š Ø¯ ØºÛŒØ±Ø­Ø§Ø¶Ø±Ø§Ù†Ùˆ Ø§Ùˆ Ø±Ø®ØµØªØ§Ù†Ùˆ Ù„ÛŒØ³Øª</h3>
        <button onclick="history.back()" style="padding:5px 15px; border-radius:8px; border:1px solid #ccc; cursor:pointer;">Ø´Ø§ØªÙ‡</button>
    </div>

    <div class="filter-box">
        <input type="date" id="reportDate" onchange="loadReport()">
        <button onclick="loadReport()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Ø±Ø§Ù¾ÙˆØ± ÚšÚ©Ø§Ø±Ù‡ Ú©Ú“Ù‡</button>
    </div>

    <div id="reportList">
        </div>
</div>
<button onclick="toggleMonthlyReport()" style="width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 12px; font-size: 16px; margin-top: 10px; cursor: pointer;">ğŸ“… Ø¯ Ù…ÛŒØ§Ø´ØªÙ†ÙŠ Ø±Ø§Ù¾ÙˆØ± Ù„ÛŒØ¯Ù„</button>

<div id="monthlyReportSection" style="display:none; margin-top: 20px; background: white; padding: 15px; border-radius: 15px; border: 1px solid #ddd; overflow-x: auto;">
    <h3 style="text-align: center; color: #2c3e50; border-bottom: 2px solid #27ae60; padding-bottom: 10px;">ğŸ“Š Ø¯ Ù…ÛŒØ§Ø´ØªÙ†ÙŠ Ø­Ø§Ø¶Ø±Û Ø±Ø§Ù¾ÙˆØ±</h3>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <select id="reportMonth" onchange="generateMonthlyReport()">
            <option value="01">Ø­Ù…Ù„ (ÙˆØ±Û)</option>
            <option value="02">Ø«ÙˆØ± (ØºÙˆÙŠÛŒ)</option>
            <option value="03">Ø¬ÙˆØ²Ø§ (ØºØ¨Ø±Ú«ÙˆÙ„ÛŒ)</option>
            <option value="04">Ø³Ø±Ø·Ø§Ù† (Ú†Ù†Ú«Ø§Úš)</option>
            <option value="05">Ø§Ø³Ø¯ (Ø²Ù…Ø±ÛŒ)</option>
            <option value="06">Ø³Ù†Ø¨Ù„Ù‡ (ÙˆÚ–ÛŒ)</option>
            <option value="07">Ù…ÛŒØ²Ø§Ù† (ØªÙ„Ù‡)</option>
            <option value="08">Ø¹Ù‚Ø±Ø¨ (Ù„Ú“Ù…)</option>
            <option value="09">Ù‚ÙˆØ³ (Ù„ÛÙ†Ø¯Û)</option>
            <option value="10">Ø¬Ø¯ÙŠ (Ù…Ø±ØºÙˆÙ…ÛŒ)</option>
            <option value="11">Ø¯Ù„Ùˆ (Ø³Ù„ÙˆØ§ØºÙ‡)</option>
            <option value="12">Ø­ÙˆØª (Ú©Ø¨)</option>
        </select>
        <button onclick="printReport()" style="background:#34495e; color:white; border:none; padding:10px; border-radius:8px;">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
    </div>

    <table id="monthlyGrid" style="font-size: 10px; width: 100%; text-align: center; border-collapse: collapse;">
        <thead>
            <tr id="gridHeader" style="background: #f8f9fa;">
                <th style="border: 1px solid #ddd; padding: 5px;">Ù†ÙˆÙ…</th>
                <th style="border: 1px solid #ddd; padding: 5px; background: #e8f5e9;">Ù…Ø¬Ù…ÙˆØ¹Ù‡</th>
            </tr>
        </thead>
        <tbody id="gridBody">
            </tbody>
    </table>
</div>

<style>
    /* Ø¯ Ú†Ø§Ù¾ Ù„Ù¾Ø§Ø±Ù‡ Ø³Ù¼Ø§ÛŒÙ„ */
    @media print {
        body * { visibility: hidden; }
        #monthlyReportSection, #monthlyReportSection * { visibility: visible; }
        #monthlyReportSection { position: absolute; left: 0; top: 0; width: 100%; }
        select, button { display: none; }
    }
    .cell-p { color: #2ecc71; font-weight: bold; } /* Ø­Ø§Ø¶Ø± */
    .cell-a { color: #e74c3c; font-weight: bold; } /* ØºÛŒØ±Ø­Ø§Ø¶Ø± */
    .cell-l { color: #f1c40f; font-weight: bold; } /* Ø±Ø®ØµØª */
</style>

<script>
    function toggleMonthlyReport() {
        const section = document.getElementById('monthlyReportSection');
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
        if(section.style.display === 'block') generateMonthlyReport();
    }

    async function generateMonthlyReport() {
        const grade = document.getElementById('attGrade').value;
        const section = document.getElementById('attSection').value;
        const month = document.getElementById('reportMonth').value;
        const headerRow = document.getElementById('gridHeader');
        const body = document.getElementById('gridBody');

        if (!grade || !section) return alert("Ù„ÙˆÙ…Ú“ÛŒ Ù¼ÙˆÙ„Ú«ÛŒ ÙˆÙ¼Ø§Ú©Ø¦!");

        // Ø¯ Ø¬Ø¯ÙˆÙ„ Ù‡ÛÚ‰Ø± Ø¬ÙˆÚ“ÙˆÙ„ (Û± ØªØ± Û³Û° Ù†ÛÙ¼Û)
        headerRow.innerHTML = '<th style="border: 1px solid #ddd; padding: 5px; width:80px;">Ø´Ø§Ú«Ø±Ø¯</th>';
        for (let i = 1; i <= 30; i++) {
            headerRow.innerHTML += `<th style="border: 1px solid #ddd; font-size:8px;">${i}</th>`;
        }
        headerRow.innerHTML += '<th style="border: 1px solid #ddd; padding: 5px; background: #fee2e2;">Øº</th>';

        body.innerHTML = "Ù„ÙˆÚ‰ Ú©ÛÚ–ÙŠ...";

        try {
            // Ù„Ù‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ú…Ø®Ù‡ Ø¯ Ø¯Û ØµÙ†Ù Ø¯ Ù…ÛŒØ§Ø´ØªÛ Ú‰Ø§Ù¼Ø§ Ø§Ø®ÛŒØ³ØªÙ„
            const studentsSnap = await db.collection("babaStudents")
                                        .where("grade", "==", grade)
                                        .where("section", "==", section)
                                        .get();

            body.innerHTML = "";
            
            for (const sDoc of studentsSnap.docs) {
                const s = sDoc.data();
                let rowHtml = `<tr style="border-bottom: 1px solid #eee;">
                                <td style="text-align:right; border: 1px solid #ddd; padding:3px;"><b>${s.name}</b></td>`;
                
                let absentCount = 0;

                // Ø¯ Ù‡Ø±Û ÙˆØ±ÚÛ Ù„Ù¾Ø§Ø±Ù‡ Ú†ÛŒÚ© Ú©ÙˆÙ„ (Ø¯Ø§ Ø¨Ø±Ø®Ù‡ Ø³ØªØ§Ø³Ùˆ Ø¯ Ú‰ÛŒÙ¼Ø§Ø¨ÛŒØ³ Ø³Ù¼Ø±Ú©Ú†Ø± Ø³Ø±Ù‡ ÙˆØµÙ„ Ø¯Ù‡)
                for (let d = 1; d <= 30; d++) {
                    const dayStr = d < 10 ? '0' + d : d;
                    const fullDate = `2025-${month}-${dayStr}`; // Ø¯Ù„ØªÙ‡ Ú©Ø§Ù„ Ú‰ÛŒÙ†Ø§Ù…ÛŒÚ© Ù‡Ù… Ú©ÛŒØ¯Ø§ÛŒ Ø´ÙŠ
                    
                    // Ù¾Ù‡ ÙØ±Ø¶ÙŠ Ú‰ÙˆÙ„ Ø¯ Ú‰ÛŒÙ¼Ø§ Ù„Ù¼ÙˆÙ† (Ø§ØµÙ„ÙŠ Ú©ÙˆÚ‰ Ú©Û Ø¨Ø§ÛŒØ¯ Ù„Ù‡ Ø­Ø§ÙØ¸Û ÛŒØ§ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ú…Ø®Ù‡ ÙÙ„Ù¼Ø± Ø´ÙŠ)
                    let status = ""; 
                    // Ù¾Ù‡ Ø¯Û ÚØ§ÛŒ Ú©Û Ø³ØªØ§Ø³Ùˆ Ø¯ Ø­Ø§Ø¶Ø±ÙŠ Ù„ÙˆØ¬ÛŒÚ© Ø³Ø±Ù‡ Ø³Ù… Ú‰Ø§Ù¼Ø§ Ú‰Ú©ÛÚ–ÙŠ
                    rowHtml += `<td style="border: 1px solid #ddd; font-size:8px;">${status}</td>`;
                }

                rowHtml += `<td style="border: 1px solid #ddd; background:#fff5f5; color:red;">${absentCount}</td></tr>`;
                body.innerHTML += rowHtml;
            }
        } catch (e) { console.error(e); }
    }

    function printReport() { window.print(); }
</script>

<script>
    // Ø³ØªØ§Ø³Ùˆ ÙØ§ÛŒØ±Ø¨ÛŒØ³ ØªØ±ØªÛŒØ¨
    const firebaseConfig = {
        apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
        projectId: "babahotakschool",
        appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Ù†Ù†Ù†ÛŒ ØªØ§Ø±ÛŒØ® Ù¾Ù‡ Ø§ØªÙˆÙ…Ø§Øª Ú‰ÙˆÙ„
    document.getElementById('reportDate').valueAsDate = new Date();

    async function loadReport() {
        const selectedDate = document.getElementById('reportDate').value;
        const listDiv = document.getElementById('reportList');
        listDiv.innerHTML = "<p style='text-align:center;'>Ù„ÙˆÚ‰ Ú©ÛÚ–ÙŠ...</p>";

        try {
            // Ù„Ù‡ Ú‰ÛŒÙ¼Ø§Ø¨ÛŒØ³ Ú…Ø®Ù‡ ÛŒÙˆØ§Ø²Û ØºÛŒØ±Ø­Ø§Ø¶Ø± (absent) Ø§Ùˆ Ø±Ø®ØµØª (leave) Ø±Ø§Ú©Ø§Ú–ÙŠ
            const snapshot = await db.collection("babaAttendance")
                .where("date", "==", selectedDate)
                .where("status", "in", ["absent", "leave"])
                .get();

            if (snapshot.empty) {
                listDiv.innerHTML = "<div class='no-data'>Ù¾Ù‡ Ø¯Û Ù†ÛÙ¼Ù‡ Ù‡ÛŒÚ… ØºÛŒØ±Ø­Ø§Ø¶Ø± ÛŒØ§ Ø±Ø®ØµØª Ø²Ø¯Ù‡â€ŒÚ©ÙˆÙˆÙ†Ú©ÛŒ Ù†Ø´ØªÙ‡. ğŸ˜Š</div>";
                return;
            }

            listDiv.innerHTML = "";
            
            // Ø¯ Ù‡Ø± Ø±ÛŒÚ©Ø§Ø±Ú‰ Ù„Ù¾Ø§Ø±Ù‡ Ø¯ Ø²Ø¯Ù‡â€ŒÚ©ÙˆÙˆÙ†Ú©ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ø®Ù„ÙŠ
            for (const doc of snapshot.docs) {
                const att = doc.data();
                const studentId = att.studentId;
                
                // Ø¯ Ø²Ø¯Ù‡â€ŒÚ©ÙˆÙˆÙ†Ú©ÙŠ Ù†ÙˆÙ… Ø§Ùˆ Ø´Ù…ÛØ±Ù‡ Ù„Ù‡ Ø¨Ù„ Ú©Ù„Ú©Ø´Ù† Ú…Ø®Ù‡ Ø§Ø®Ù„ÙŠ
                const stDoc = await db.collection("babaStudents").doc(studentId).get();
                const s = stDoc.data() || { name: att.name || "Ù†Ø§Ù…Ø¹Ù„ÙˆÙ…", phone: "" };

                const statusClass = att.status === 'absent' ? '' : 'leave';
                const tagClass = att.status === 'absent' ? 'tag-absent' : 'tag-leave';
                const statusName = att.status === 'absent' ? 'ØºÛŒØ±Ø­Ø§Ø¶Ø±' : 'Ø±Ø®ØµØª';

                listDiv.innerHTML += `
                    <div class="absent-card ${statusClass}">
                        <div class="info">
                            <h4>${s.name}</h4>
                            <p>ØµÙ†Ù: ${s.grade || att.class || ''} (${s.section || att.section || ''}) | Ù¾Ù„Ø§Ø±: ${s.father || ''}</p>
                            <span class="status-tag ${tagClass}">${statusName}</span>
                        </div>
                        <div>
                            ${s.phone ? 
                                `<a href="https://wa.me/${s.phone}?text=Ø³Ù„Ø§Ù…ØŒ Ø³ØªØ§Ø³Ùˆ Ø²ÙˆÛŒ ${s.name} Ù†Ù† Ù¾Ù‡ ${selectedDate} Ù†ÛÙ¼Ù‡ ÚšÙˆÙˆÙ†ÚÙŠ ØªÙ‡ Ù†Ù‡ Ø¯ÛŒ Ø±Ø§ØºÙ„ÛŒ." target="_blank" class="whatsapp-btn">ÙˆØ§Ù¼Ø³Ø§Ù¾</a>` 
                                : '<small>Ø´Ù…ÛØ±Ù‡ Ù†Ø´ØªÙ‡</small>'}
                        </div>
                    </div>
                `;
            }
        } catch (e) {
            listDiv.innerHTML = "<p style='color:red;'>ØªÛØ±ÙˆØªÙ†Ù‡: " + e.message + "</p>";
        }
    }

    // Ú©Ù„Ù‡ Ú†Û Ù¾Ø§Ú¼Ù‡ Ù„ÙˆÚ‰ Ø´ÙŠØŒ Ø±Ø§Ù¾ÙˆØ± Ù¾Ù‡ Ø§ØªÙˆÙ…Ø§Øª Ú‰ÙˆÙ„ ÚšÚ©Ø§Ø±Ù‡ Ú©Ú“Ù‡
    window.onload = loadReport;
</script>
</body>
</html>
