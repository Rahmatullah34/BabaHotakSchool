<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ ÚšÙˆÙˆÙ†Ú©Ùˆ Ù…ÛŒØ§Ø´ØªÙ†ÛŒ Ø±Ø§Ù¾ÙˆØ± Ø§Ùˆ Ù…Ø¹Ø§Ø´Ø§Øª</title>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; }
        body { font-family: 'Segoe UI', Tahoma; background: #f4f7f6; margin: 0; padding: 15px; direction: rtl; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .filter-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 12px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { background: var(--primary); color: white; padding: 12px; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        
        /* Ù¾Ø±Ú«Ø±ÛŒØ³ Ø¨Ø§Ø± Ø³Ù¼Ø§ÛŒÙ„ */
        .progress-bg { background: #eee; border-radius: 10px; height: 10px; width: 100px; margin: auto; }
        .progress-fill { height: 100%; border-radius: 10px; transition: 0.5s; }
        
        .btn-export { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; margin-left: 5px; }
        .excel-btn { background: #1f7244; }
        .pdf-btn { background: #c0392b; }
        .pay-btn { background: var(--success); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        
        input, select { padding: 8px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area no-print">
        <h2 style="margin:0; color: var(--primary);">ğŸ“Š Ø¯ ÚšÙˆÙˆÙ†Ú©Ùˆ Ø¯ Ù…Ø¹Ø§Ø´ Ø§Ùˆ Ø­Ø§Ø¶Ø±ÙŠ Ø±Ø§Ù¾ÙˆØ±</h2>
        <div>
            <button class="btn-export excel-btn" onclick="exportToExcel()">Excel ğŸ“¥</button>
            <button class="btn-export pdf-btn" onclick="window.print()">Ú†Ø§Ù¾ PDF ğŸ–¨ï¸</button>
        </div>
    </div>

    <div class="filter-row no-print">
        <select id="monthFilter" onchange="generateReport()">
            <option value="">Ù…ÛŒØ§Ø´Øª ÙˆÙ¼Ø§Ú©Ø¦</option>
            <option value="1">Ø­Ù…Ù„</option><option value="2">Ø«ÙˆØ±</option><option value="3">Ø¬ÙˆØ²Ø§</option>
            <option value="4">Ø³Ø±Ø·Ø§Ù†</option><option value="5">Ø§Ø³Ø¯</option><option value="6">Ø³Ù†Ø¨Ù„Ù‡</option>
            <option value="7">Ù…ÛŒØ²Ø§Ù†</option><option value="8">Ø¹Ù‚Ø±Ø¨</option><option value="9">Ù‚ÙˆØ³</option>
        </select>
        <input type="text" id="teacherSearch" placeholder="Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù†ÙˆÙ…..." oninput="generateReport()">
        <div style="text-align: left;"><a href="admin_dashboard.html" style="text-decoration:none; color:#7f8c8d;">â¬…ï¸ Ø´Ø§ØªÙ‡ ØªÚ«</a></div>
    </div>

    <table id="reportTable">
        <thead>
            <tr>
                <th>Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù†ÙˆÙ…</th>
                <th>Ø­Ø§Ø¶Ø±ÙŠ %</th>
                <th>Ù¼ÙˆÙ„Û ÙˆØ±ÚÛ</th>
                <th>Ø­Ø§Ø¶Ø±</th>
                <th>ØºÛŒØ±Ø­Ø§Ø¶Ø±</th>
                <th>Ø®Ù†Ú‰ (Ø¯Ù‚ÛŒÙ‚Ù‡)</th>
                <th>Ø¨Ù†Ø³Ù¼ÛŒØ² Ù…Ø¹Ø§Ø´</th>
                <th>Ú©Ø³Ø±Ø§Øª (Ø§ÙØºØ§Ù†Û)</th>
                <th>Ù†Ù‡Ø§ÙŠÙŠ Ù…Ø¹Ø§Ø´</th>
                <th class="no-print">Ø¹Ù…Ù„ÛŒÙ‡</th>
            </tr>
        </thead>
        <tbody id="reportContent">
            </tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
        authDomain: "babahotakschool.firebaseapp.com",
        projectId: "babahotakschool",
        storageBucket: "babahotakschool.firebasestorage.app",
        messagingSenderId: "12958892996",
        appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function generateReport() {
        const tbody = document.getElementById('reportContent');
        const searchTerm = document.getElementById('teacherSearch').value.toLowerCase();
        tbody.innerHTML = "<tr><td colspan='10'>Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙˆ Ø±Ø§Ù¼ÙˆÙ„ÙˆÙ„...</td></tr>";

        try {
            const tSnap = await db.collection("babaTeachers").get();
            const aSnap = await db.collection("teacherAttendance").get();
            
            tbody.innerHTML = "";
            
            tSnap.forEach(tDoc => {
                const teacher = tDoc.data();
                if (searchTerm && !teacher.name.toLowerCase().includes(searchTerm)) return;

                let present = 0, absent = 0, lateMin = 0;
                let attendanceDocs = [];
                
                aSnap.forEach(aDoc => {
                    const att = aDoc.data();
                    if(att.teacherId === tDoc.id) {
                        if(att.status === 'present' || att.status === 'late') present++;
                        if(att.status === 'absent') absent++;
                        lateMin += parseInt(att.lateMinutes || 0);
                    }
                });

                const totalDays = present + absent;
                const attRate = totalDays > 0 ? ((present / totalDays) * 100).toFixed(0) : 0;
                
                // --- Ø¯ Ù…Ø¹Ø§Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡ (Logic) ---
                const baseSalary = parseInt(teacher.salary || 10000); // Ú©Ù‡ Ù…Ø¹Ø§Ø´ Ù†Ù‡ ÙˆÙŠØŒ Û±Û° Ø²Ø±Ù‡ ÙØ±Ø¶ Ú©Ú“Ø¦
                const dailyCut = baseSalary / 30; // Ø¯ ÛŒÙˆÛ ÙˆØ±ÚÛ Ú©Ø³Ø±
                const lateCutPerMin = 2; // Ù¾Ù‡ Ù‡Ø±Ù‡ Ø¯Ù‚ÛŒÙ‚Ù‡ Û² Ø§ÙØºØ§Ù†Û Ú©Ø³Ø± (ØªØºÛŒØ±ÙˆÙ„ÛŒ ÛŒÛ Ø´Ø¦)
                
                const totalDeduction = (absent * dailyCut) + (lateMin * lateCutPerMin);
                const finalSalary = baseSalary - totalDeduction;

                // Ø¯ Ø±Ù†Ú«ÙˆÙ†Ùˆ Ù¼Ø§Ú©Ù„ Ø¯ ÙÛŒØµØ¯ÙŠ Ù…Ø·Ø§Ø¨Ù‚
                const progressColor = attRate >= 90 ? 'var(--success)' : (attRate >= 70 ? 'var(--warning)' : 'var(--danger)');

                tbody.innerHTML += `
                    <tr>
                        <td style="text-align:right;"><b>${teacher.name}</b></td>
                        <td>
                            <div class="progress-bg"><div class="progress-fill" style="width:${attRate}%; background:${progressColor};"></div></div>
                            <small>${attRate}%</small>
                        </td>
                        <td>${totalDays}</td>
                        <td style="color:green">${present}</td>
                        <td style="color:red">${absent}</td>
                        <td>${lateMin}</td>
                        <td>${baseSalary}</td>
                        <td style="color:red">-${totalDeduction.toFixed(0)}</td>
                        <td style="font-weight:bold; color:blue;">${finalSalary.toFixed(0)} AFN</td>
                        <td class="no-print">
                            <button class="pay-btn" onclick="processPayment('${tDoc.id}', ${finalSalary})">ØªØ§Ø¯ÛŒÙ‡ âœ…</button>
                        </td>
                    </tr>`;
            });
        } catch (e) { console.error(e); }
    }

    async function processPayment(id, amount) {
        if(confirm(`Ø§ÛŒØ§ Ú‰Ø§Ú‰Ù‡ ÛŒØ§Ø³Øª Ú†Û Ø¯ ${amount.toFixed(0)} Ø§ÙØºØ§Ù†ÛŒÙˆ Ù…Ø¹Ø§Ø´ ØªØ§Ø¯ÛŒÙ‡ Ø«Ø¨Øª Ú©Ú“Ø¦ØŸ`)) {
            await db.collection("babaFinance").add({
                name: "Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù…Ø¹Ø§Ø´",
                type: "expense",
                amount: amount,
                teacherId: id,
                date: new Date().toLocaleDateString('fa-AF'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Ù…Ø¹Ø§Ø´ Ù¾Ù‡ Ø¨Ø±ÛŒØ§Ù„ÛŒØªÙˆØ¨ Ø³Ø±Ù‡ Ù¾Ù‡ Ù…Ø§Ù„ÙŠ Ø³ÛŒØ³ØªÙ… Ú©Û Ø«Ø¨Øª Ø´Ùˆ!");
        }
    }

    function exportToExcel() {
        let table = document.getElementById("reportTable");
        let html = table.outerHTML;
        window.open('data:application/vnd.ms-excel,' + encodeURIComponent(html));
    }

    window.onload = generateReport;
</script>
</body>
</html>
