<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ ÚšÙˆÙˆÙ†Ú©Ùˆ Ù‡ÙˆÚšÛŒØ§Ø±Ù‡ Ø­Ø§Ø¶Ø±ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .attendance-card { background: white; border-radius: 20px; padding: 20px; margin: 10px auto; max-width: 750px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Û±. Ù…Ø¬Ù…ÙˆØ¹ÙŠ Ø­Ø§Ù„Øª (Summary Bar) */
        .summary-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; text-align: center; background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .summary-item { font-size: 12px; font-weight: bold; }
        .summary-item span { display: block; font-size: 18px; margin-top: 5px; }
        
        /* Û². ÛŒÙˆ Ú©Ù„ÛŒÚ© Ø¨Ù¼Ù†Ù‡ */
        .bulk-action { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .bulk-btn { background: #34495e; color: white; border: none; padding: 8px 18px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.3s; }
        .bulk-btn:hover { background: #2c3e50; }

        /* Ø±Ø§Ù¾ÙˆØ± Ø¨Ù¼Ù† Ø³Ù¼Ø§ÛŒÙ„ */
        .report-link { background: #8e44ad; color: white; text-decoration: none; padding: 8px 15px; border-radius: 10px; font-size: 13px; font-weight: bold; transition: 0.3s; }
        .report-link:hover { background: #732d91; opacity: 0.9; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #3498db; color: white; padding: 12px; border-radius: 5px; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        
        .status-select { padding: 6px; border-radius: 8px; border: 1px solid #ddd; width: 100%; outline: none; }
        .late-input { width: 60px; padding: 6px; border-radius: 8px; border: 1px solid #ddd; text-align: center; }
        .remarks-input { width: 100%; padding: 6px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        
        .row-late { background-color: #fff9e6 !important; }
        .row-absent { background-color: #ffeded !important; }
        .row-leave { background-color: #f0f7ff !important; }
        
        .save-btn { width: 100%; padding: 15px; background: #27ae60; color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; margin-top: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2); }
        .save-btn:hover { background: #219150; }
        .back-btn { background: #95a5a6; color: white; padding: 8px 15px; border-radius: 10px; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

<div class="attendance-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <a href="admin_dashboard.html" class="back-btn">â¬…ï¸ Ø´Ø§ØªÙ‡</a>
        <h3 style="margin:0; color: #2c3e50;">Ø¯ ÚšÙˆÙˆÙ†Ú©Ùˆ Ù…Ø³Ù„Ú©ÙŠ Ø­Ø§Ø¶Ø±ÙŠ</h3>
        <a href="teacherattendance_report.html" class="report-link">ğŸ“Š Ù…ÛŒØ§Ø´ØªÙ†ÛŒ Ø±Ø§Ù¾ÙˆØ±</a>
    </div>

    <div class="summary-bar">
        <div class="summary-item" style="color:#3498db;">Ù¼ÙˆÙ„ ÚšÙˆÙˆÙ†Ú©ÙŠ<span id="totalT">0</span></div>
        <div class="summary-item" style="color:#27ae60;">Ø­Ø§Ø¶Ø±<span id="presentT">0</span></div>
        <div class="summary-item" style="color:#e74c3c;">ØºÛŒØ±Ø­Ø§Ø¶Ø±<span id="absentT">0</span></div>
        <div class="summary-item" style="color:#f39c12;">Ø¶Ø§ÛŒØ¹ ÙˆØ®Øª (Ø¯Ù‚ÛŒÙ‚Ù‡)<span id="totalLateMin">0</span></div>
    </div>

    <div class="bulk-action">
        <button class="bulk-btn" onclick="markAllPresent()">âœ… Ù¼ÙˆÙ„ Ø­Ø§Ø¶Ø± Ú©Ú“Ù‡</button>
        <span style="font-size: 12px; color: #7f8c8d;">Ù†ÛÙ¼Ù‡: <b id="todayDate"></b></span>
    </div>

    <div id="loading" style="text-align:center; padding: 20px;">Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙˆ Ø±Ø§ÙˆÚ“Ù„...</div>

    <table id="mainTable" style="display:none;">
        <thead>
            <tr>
                <th>Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù†ÙˆÙ…</th>
                <th>Ø­Ø§Ù„Øª</th>
                <th>ÚÙ†Ú‰ (Ø¯Ù‚ÛŒÙ‚Ù‡)</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="teacherList"></tbody>
    </table>

    <button class="save-btn" onclick="submitAttendance()">ğŸ’¾ Ø­Ø§Ø¶Ø±ÙŠ Ø®ÙˆÙ†Ø¯ÙŠ Ú©Ú“Ù‡</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
        authDomain: "babahotakschool.firebaseapp.com",
        projectId: "babahotakschool",
        storageBucket: "babahotakschool.firebasestorage.app",
        messagingSenderId: "12958892996",
        appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.getElementById('todayDate').innerText = new Date().toLocaleDateString('fa-AF');

    async function loadTeachers() {
        const tbody = document.getElementById('teacherList');
        try {
            const snapshot = await db.collection("babaTeachers").get();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainTable').style.display = 'table';
            document.getElementById('totalT').innerText = snapshot.size;
            
            snapshot.forEach(doc => {
                const t = doc.data();
                tbody.innerHTML += `
                    <tr class="teacher-row" data-id="${doc.id}" data-name="${t.name}">
                        <td style="text-align:right;"><b>${t.name}</b></td>
                        <td>
                            <select class="status-select" onchange="styleRow(this); updateSummary();">
                                <option value="present">Ø­Ø§Ø¶Ø±</option>
                                <option value="absent">ØºÛŒØ±Ø­Ø§Ø¶Ø±</option>
                                <option value="leave">Ø±Ø®ØµØª</option>
                                <option value="late">Ù†Ø§ÙˆØ®ØªÙ‡</option>
                            </select>
                        </td>
                        <td><input type="number" class="late-input" value="0" oninput="updateSummary()"></td>
                        <td><input type="text" class="remarks-input" placeholder="..."></td>
                    </tr>`;
            });
            updateSummary();
        } catch (e) { alert("Error: " + e.message); }
    }

    function styleRow(select) {
        const row = select.closest('tr');
        row.classList.remove('row-late', 'row-absent', 'row-leave');
        if(select.value === 'late') row.classList.add('row-late');
        if(select.value === 'absent') row.classList.add('row-absent');
        if(select.value === 'leave') row.classList.add('row-leave');
    }

    function markAllPresent() {
        document.querySelectorAll('.status-select').forEach(s => {
            s.value = 'present';
            styleRow(s);
        });
        updateSummary();
    }

    function updateSummary() {
        let p = 0, a = 0, totalLate = 0;
        document.querySelectorAll('.teacher-row').forEach(row => {
            const status = row.querySelector('.status-select').value;
            const late = parseInt(row.querySelector('.late-input').value) || 0;
            if(status === 'present' || status === 'late') p++;
            if(status === 'absent') a++;
            totalLate += late;
        });
        document.getElementById('presentT').innerText = p;
        document.getElementById('absentT').innerText = a;
        document.getElementById('totalLateMin').innerText = totalLate;
    }

    async function submitAttendance() {
        const rows = document.querySelectorAll('.teacher-row');
        const date = new Date().toLocaleDateString('fa-AF');
        const time = new Date().toLocaleTimeString('ps-AF');

        if(!confirm("Ø§ÛŒØ§ ØºÙˆØ§Ú“Ø¦ Ù†Ù†Ù†Û Ø­Ø§Ø¶Ø±ÙŠ Ø«Ø¨Øª Ú©Ú“Ø¦ØŸ")) return;

        try {
            for (let row of rows) {
                const status = row.querySelector('.status-select').value;
                const late = row.querySelector('.late-input').value || 0;
                const rem = row.querySelector('.remarks-input').value || "";

                await db.collection("teacherAttendance").add({
                    teacherId: row.dataset.id,
                    name: row.dataset.name,
                    status: status,
                    lateMinutes: parseInt(late),
                    remarks: rem,
                    date: date,
                    exactTime: time,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            alert("âœ… Ø­Ø§Ø¶Ø±ÙŠ Ù¾Ù‡ Ø¨Ø±ÛŒØ§Ù„ÛŒØªÙˆØ¨ Ø³Ø±Ù‡ Ø«Ø¨Øª Ø´ÙˆÙ‡!");
            window.location.href = 'admin_dashboard.html';
        } catch (e) { alert("ØªÛØ±ÙˆØªÙ†Ù‡: " + e.message); }
    }

    loadTeachers();
</script>
</body>
</html>