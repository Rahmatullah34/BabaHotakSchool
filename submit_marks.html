<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ© Ù„ÛŒØ³Û Ø¬Ø§Ù…Ø¹ Ø³ÛŒØ³Ù¼Ù…</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Tahoma', sans-serif; background-color: #f0f4f8; margin: 0; padding: 10px; direction: rtl; }
        .selector-box { background: #004d99; color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center; }
        select { padding: 10px; border-radius: 8px; width: 95%; font-size: 16px; margin-top: 10px; }
        .student-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 25px; border-top: 5px solid #27ae60; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .student-header { background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f0f7f2; color: #27ae60; }
        input[type="number"], input[type="text"] { width: 60px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; text-align: center; outline: none; }
        .st-input { width: 110px !important; text-align: right !important; }
        .fail-bg { background-color: #ffcdd2 !important; } 
        .res-section { padding: 10px; border-radius: 8px; border: 1px solid #ccc; background: #fff; margin-top: 10px; }
        .mid-style { border-right: 5px solid #ffd600; }
        .final-style { border-right: 5px solid #27ae60; }
        .title-sm { font-size: 13px; font-weight: bold; color: #27ae60; display: block; margin-bottom: 8px; border-bottom: 1px solid #eee; }
        .att-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 5px; }
        .att-item label { font-size: 10px; display: block; text-align: center; margin-bottom: 2px; }
        .att-item input { width: 100%; font-size: 12px; box-sizing: border-box; }
        .present-box { background-color: #e8f5e9; font-weight: bold; }
        .debarred-input { width: 100% !important; background: #fffde7; color: red; font-weight: bold; }
        .btn-save { background-color: #27ae60; color: white; border: none; padding: 18px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>

<div class="selector-box">
    <label>Ø¯ Ø®Ù¾Ù„ ØµÙ†Ù Ø´Ø§Ú«Ø±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ú“Ø¦:</label><br>
    <select id="studentSelector" onchange="fillStudentData()">
        <option value="">Ù„ÙˆÚ‰ÛÚ–ÙŠ...</option>
    </select>
</div>

<div class="student-card">
    <div class="student-header">
        <div class="info-grid">
            <div>Ù†ÙˆÙ…: <input type="text" id="st-name" class="st-input"></div>
            <div>Ù¾Ù„Ø§Ø± Ù†ÙˆÙ…: <input type="text" id="st-father" class="st-input"></div>
            <div>Ø§Ø³Ø§Ø³ Ù†Ù…Ø¨Ø±: <input type="number" id="st-id" class="st-input" style="color:red; font-weight:bold;"></div>
            <div>Ù†ÛŒÚ©Ù‡ Ù†ÙˆÙ…: <input type="text" id="st-grand" class="st-input"></div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ù…Ø¶Ù…ÙˆÙ†</th>
                <th style="background:#fff9c4">Ú…Ù„ÙˆØ±Ù†ÛŒÙ… (40)</th>
                <th style="background:#c8e6c9">Ú©Ù„Ù†Û (60)</th>
                <th>Ù¼ÙˆÙ„Û Ù†Ù…Ø±Û</th>
            </tr>
        </thead>
        <tbody id="marks-body">
            <script>
                const subjects = ["Ù‚Ø±Ø§Ù†Ú©Ø±ÛŒÙ…", "Ø¯ÛŒÙ†ÙŠ ÚšÙˆÙˆÙ†Ù‡", "ØªØ¬ÙˆÛŒØ¯", "Ù¾ÚšØªÙˆ", "Ø¯Ø±ÙŠ", "Ø¹Ø±Ø¨ÙŠ", "Ø§Ù†Ú«Ù„ÛŒØ³ÙŠ", "Ø±ÛŒØ§Ø¶ÙŠ", "ÙØ²ÛŒÚ©", "Ú©ÛŒÙ…ÛŒØ§", "Ø¨ÛŒÙˆÙ„ÙˆÚ˜ÙŠ", "ØªØ§Ø±ÛŒØ®", "Ø¬ØºØ±Ø§ÙÛŒÙ‡", "Ù…Ø¯Ù†ÙŠ", "Ú©Ù…Ù¾ÛŒÙˆÙ¼Ø±", "Ø­Ø±ÙÙ‡", "Ø³Ù¾ÙˆØ±Øª", "ØªÙ‡Ø°ÛŒØ¨"];
                subjects.forEach(sub => {
                    document.write(`
                        <tr data-subject="${sub}">
                            <td style="text-align:right; font-weight:bold;">${sub}</td>
                            <td><input type="number" class="m45" max="40" oninput="validateAndCalc(this, 40)"></td>
                            <td><input type="number" class="mAn" max="60" oninput="validateAndCalc(this, 60)"></td>
                            <td class="total-cell" style="font-weight:bold; color:#1565c0;"></td>
                        </tr>
                    `);
                });
            </script>
            <tr style="background: #f9f9f9;">
                <td style="text-align:right; font-weight:bold; color:red;">Ø­Ø§Ù„Øª (Ù…Ø­Ø±ÙˆÙ…ØŸ)</td>
                <td><input type="text" id="deb-mid" placeholder="Ù…" class="debarred-input" oninput="calculate()"></td>
                <td><input type="text" id="deb-fin" placeholder="Ù…" class="debarred-input" oninput="calculate()"></td>
                <td>---</td>
            </tr>
        </tbody>
    </table>

    <div class="res-section mid-style">
        <span class="title-sm">Ú…Ù„ÙˆØ±Ù†ÛŒÙ… Ù…ÛŒØ§Ø´ØªÙ†Û Ù¾Ø§ÛŒÙ„Û:</span>
        <div style="font-size:13px; margin-bottom:5px;">
            Ù¼ÙˆÙ„Û Ù†Ù…Ø±Û: <span id="mid-sum" style="font-weight:bold;">0</span> | 
            Ø§ÙˆØ³Ø·: <span id="mid-avg" style="font-weight:bold;">0</span> | 
            Ù¾Ø§ÛŒÙ„Ù‡: <span id="mid-status" style="font-weight:bold;">---</span> | 
            Ø¯Ø±Ø¬Ù‡: <span id="mid-grade" style="font-weight:bold;">---</span>
        </div>
        <div class="att-grid">
            <div class="att-item"><label>ÙˆØ±ÚÛ</label><input type="number" id="days45" oninput="updateAtt()"></div>
            <div class="att-item"><label>Ù†Ø§Ø³ÙˆØ¨</label><input type="number" id="a45" oninput="updateAtt()"></div>
            <div class="att-item"><label>Ù†Ø§Ø±ÙˆØº</label><input type="number" id="s45" oninput="updateAtt()"></div>
            <div class="att-item"><label>Ø±Ø®ØµØª</label><input type="number" id="l45" oninput="updateAtt()"></div>
            <div class="att-item"><label>Ø³ÙˆØ¨</label><input type="number" id="p45" class="present-box" readonly></div>
        </div>
    </div>

    <div class="res-section final-style">
        <span class="title-sm">ÙˆØ±ÙˆØ³ØªÛ Ù¾Ø§ÛŒÙ„Û:</span>
        <div style="font-size:13px; margin-bottom:5px;">
            Ù¼ÙˆÙ„Û Ù†Ù…Ø±Û: <span id="fin-sum" style="font-weight:bold;">0</span> | 
            Ø§ÙˆØ³Ø·: <span id="fin-avg" style="font-weight:bold;">0</span> | 
            Ù¾Ø§ÛŒÙ„Ù‡: <span id="fin-status" style="font-weight:bold;">---</span> | 
            Ø¯Ø±Ø¬Ù‡: <span id="fin-grade" style="font-weight:bold;">---</span>
        </div>
        <div class="att-grid">
            <div class="att-item"><label>Ú©Ù„Ù†Û ÙˆØ±ÚÛ</label><input type="number" id="daysAn" oninput="updateAtt()"></div>
            <div class="att-item"><label>Ù†Ø§Ø³ÙˆØ¨</label><input type="number" id="aAn" oninput="updateAtt()"></div>
            <div class="att-item"><label>Ù†Ø§Ø±ÙˆØº</label><input type="number" id="sAn" oninput="updateAtt()"></div>
            <div class="att-item"><label>Ø±Ø®ØµØª</label><input type="number" id="lAn" oninput="updateAtt()"></div>
            <div class="att-item"><label>Ù…Ø¬Ù…ÙˆØ¹ÙŠ Ø³ÙˆØ¨</label><input type="number" id="pFin" class="present-box" readonly></div>
        </div>
    </div>

    <button class="btn-save" id="btnSave" onclick="saveData()">ğŸ’¾ Ú‰ÛŒÙ¼Ø§ Ù¾Ù‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ú©Û Ø°Ø®ÛŒØ±Ù‡ Ú©Ú“Ù‡</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
        projectId: "babahotakschool",
        appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
    };
    
    firebase.initializeApp(firebaseConfig);
    const fs = firebase.firestore();

    let studentList = {};

    async function loadStudents() {
        const teacherId = localStorage.getItem('userId');
        if (!teacherId) return;
        try {
            const tDoc = await fs.collection("babaTeachers").doc(teacherId).get();
            if (tDoc.exists) {
                const { grade, section } = tDoc.data();
                const snap = await fs.collection("babaStudents")
                    .where("grade", "==", grade)
                    .where("section", "==", section.split(' ')[0])
                    .get();
                
                const sel = document.getElementById('studentSelector');
                sel.innerHTML = '<option value="">Ø´Ø§Ú«Ø±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ú“Ø¦</option>';
                snap.forEach(doc => {
                    studentList[doc.id] = doc.data();
                    sel.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
                });
            }
        } catch (e) { console.error("Error loading students:", e); }
    }

    function fillStudentData() {
        resetForm(); // Ù…Ø®Ú©Û Ù„Ù‡ Ú‰Ú©ÙˆÙ„Ùˆ Ù¼ÙˆÙ„ Ù¾Ø®ÙˆØ§Ù†ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù¾Ø§Ú© Ú©Ú“Ø¦
        const id = document.getElementById('studentSelector').value;
        if (!id) return;
        const s = studentList[id];
        document.getElementById('st-name').value = s.name;
        document.getElementById('st-father').value = s.fname || s.father || '';
        document.getElementById('st-id').value = s.id || id;
        document.getElementById('st-grand').value = s.gname || '';
    }

    function validateAndCalc(el, limit) {
        if (parseFloat(el.value) > limit) el.value = limit;
        calculate();
    }

    function calculate() {
        let rows = document.querySelectorAll('#marks-body tr[data-subject]');
        let mSum = 0, mCount = 0, mFail = false;
        let fSum = 0, fCount = 0, fFailCount = 0;

        let debMid = document.getElementById('deb-mid').value.trim();
        let debFin = document.getElementById('deb-fin').value.trim();

        rows.forEach(row => {
            let v45 = parseFloat(row.querySelector('.m45').value) || 0;
            let vAn = parseFloat(row.querySelector('.mAn').value) || 0;
            
            if(row.querySelector('.m45').value !== "") {
                mSum += v45; mCount++;
                if(v45 < 16) mFail = true;
            }

            let tCell = row.querySelector('.total-cell');
            if(row.querySelector('.mAn').value !== "") {
                let total = v45 + vAn;
                tCell.innerText = total;
                fSum += total; fCount++;
                if(total < 40) { fFailCount++; tCell.classList.add('fail-bg'); }
                else tCell.classList.remove('fail-bg');
            } else tCell.innerText = "";
        });

        // Ú…Ù„ÙˆØ±Ù†ÛŒÙ… Ù…ÛŒØ§Ø´ØªÙ†Û Ù…Ù†Ø·Ù‚
        let midS = document.getElementById('mid-status'), midG = document.getElementById('mid-grade');
        if(debMid === "Ù…" || debMid === "Ù…Ø­Ø±ÙˆÙ…") {
            midS.innerText = "Ù…Ø­Ø±ÙˆÙ…"; midS.style.color="red"; midG.innerText = "";
            document.getElementById('mid-sum').innerText = "0"; document.getElementById('mid-avg').innerText = "0";
        } else if(mCount > 0) {
            let avg = mSum / mCount;
            document.getElementById('mid-sum').innerText = mSum;
            document.getElementById('mid-avg').innerText = avg.toFixed(2);
            if(avg >= 20 && !mFail) {
                midS.innerText = "Ø¨Ø±ÛŒØ§Ù„ÛŒ"; midS.style.color="green";
                midG.innerText = avg >= 36 ? "Ø§Ù„Ù" : (avg >= 30 ? "Ø¨" : (avg >= 24 ? "Ø¬" : "Ø¯"));
            } else { midS.innerText = "Ù„Ø§Ø²ÛŒØ§ØªÙ‡ Ù‡Ú…Ù‡"; midS.style.color="red"; midG.innerText = "Ù‡Ù€"; }
        }

        // Ú©Ù„Ù†Û Ù…Ù†Ø·Ù‚
        let finS = document.getElementById('fin-status'), finG = document.getElementById('fin-grade');
        if(debFin === "Ù…" || debFin === "Ù…Ø­Ø±ÙˆÙ…") {
            finS.innerText = "Ù…Ø­Ø±ÙˆÙ…"; finS.style.color="red"; finG.innerText = "";
            document.getElementById('fin-sum').innerText = "0"; document.getElementById('fin-avg').innerText = "0";
        } else if(fCount > 0) {
            let avg = fSum / fCount;
            document.getElementById('fin-sum').innerText = fSum;
            document.getElementById('fin-avg').innerText = avg.toFixed(2);
            if(avg >= 50 && fFailCount === 0) {
                finS.innerText = "Ø¯ Ù¼ÙˆÙ„Ú«ÙŠ Ù„ÙˆØ±ØªÛŒØ§"; finS.style.color="green";
                finG.innerText = avg >= 90 ? "Ø§Ù„Ù" : (avg >= 75 ? "Ø¨" : (avg >= 60 ? "Ø¬" : "Ø¯"));
            } else if(avg >= 50 && fFailCount <= 3) { finS.innerText = "Ù…Ø´Ø±ÙˆØ·"; finS.style.color="orange"; finG.innerText = "Ù‡Ù€"; }
            else { finS.innerText = "Ø¯ Ù¼ÙˆÙ„Ú«ÙŠ ØªÚ©Ø±Ø§Ø±"; finS.style.color="red"; finG.innerText = "Ù‡Ù€"; }
        }
    }

    function updateAtt() {
        let d45 = parseFloat(document.getElementById('days45').value) || 0;
        let a45 = parseFloat(document.getElementById('a45').value) || 0;
        let s45 = parseFloat(document.getElementById('s45').value) || 0;
        let l45 = parseFloat(document.getElementById('l45').value) || 0;
        document.getElementById('p45').value = d45 - (a45 + s45 + l45);

        let dAn = parseFloat(document.getElementById('daysAn').value) || 0;
        let aAn = parseFloat(document.getElementById('aAn').value) || 0;
        let sAn = parseFloat(document.getElementById('sAn').value) || 0;
        let lAn = parseFloat(document.getElementById('lAn').value) || 0;
        document.getElementById('pFin').value = (d45 + dAn) - (a45 + aAn + s45 + sAn + l45 + lAn);
    }

    function resetForm() {
        // Ù†Ù…Ø±Û Ù¾Ø§Ú©ÙˆÙ„
        document.querySelectorAll('.m45, .mAn').forEach(i => i.value = "");
        document.querySelectorAll('.total-cell').forEach(c => { c.innerText = ""; c.classList.remove('fail-bg'); });
        // Ø­Ø§Ø¶Ø±ÙŠ Ù¾Ø§Ú©ÙˆÙ„
        document.querySelectorAll('.att-grid input').forEach(i => i.value = "");
        // Ù…Ø­Ø±ÙˆÙ…ÛŒØª Ù¾Ø§Ú©ÙˆÙ„
        document.getElementById('deb-mid').value = "";
        document.getElementById('deb-fin').value = "";
        // Ù¾Ø§ÛŒÙ„Û Ù¾Ø§Ú©ÙˆÙ„
        document.getElementById('mid-sum').innerText = "0"; document.getElementById('mid-avg').innerText = "0";
        document.getElementById('fin-sum').innerText = "0"; document.getElementById('fin-avg').innerText = "0";
        document.getElementById('mid-status').innerText = "---"; document.getElementById('mid-grade').innerText = "---";
        document.getElementById('fin-status').innerText = "---"; document.getElementById('fin-grade').innerText = "---";
    }

    async function saveData() {
        const id = document.getElementById('st-id').value;
        const name = document.getElementById('st-name').value;
        const btn = document.getElementById('btnSave');
        
        if(!id || !name) { alert("Ù„Ø·ÙØ§Ù‹ Ù„ÙˆÙ…Ú“ÛŒ ÛŒÙˆ Ø´Ø§Ú«Ø±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ú“Ø¦!"); return; }

        btn.disabled = true; btn.innerText = "Ø«Ø¨Øª Ú©ÛÚ–ÙŠ...";

        const marks = {};
        document.querySelectorAll('#marks-body tr[data-subject]').forEach(row => {
            const subject = row.dataset.subject;
            marks[subject] = {
                m45: row.querySelector('.m45').value || "0",
                mAn: row.querySelector('.mAn').value || "0",
                total: row.querySelector('.total-cell').innerText || "0"
            };
        });

        const finalData = {
            info: { name, father: document.getElementById('st-father').value, id },
            marks: marks,
            summary: {
                mid_sum: document.getElementById('mid-sum').innerText,
                mid_avg: document.getElementById('mid-avg').innerText,
                mid_result: document.getElementById('mid-status').innerText,
                mid_grade: document.getElementById('mid-grade').innerText,
                fin_sum: document.getElementById('fin-sum').innerText,
                fin_avg: document.getElementById('fin-avg').innerText,
                fin_grade: document.getElementById('fin-grade').innerText,
                final_status: document.getElementById('fin-status').innerText
            },
            attendance: {
                p45: document.getElementById('p45').value || "0",
                pTotal: document.getElementById('pFin').value || "0"
            },
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await fs.collection("studentMarks").doc(id).set(finalData);
            alert("âœ… Ø¯ " + name + " Ù†Ù…Ø±Û Ù¾Ù‡ Ø¨Ø±ÛŒØ§Ù„ÛŒØªÙˆØ¨ Ø³Ø±Ù‡ Ø«Ø¨Øª Ø´ÙˆÛ!");
            resetForm(); // Ù„Ù‡ Ø«Ø¨Øª ÙˆØ±ÙˆØ³ØªÙ‡ ØµÙØ­Ù‡ Ù¾Ø§Ú©Ù‡ Ú©Ú“Ù‡
            document.getElementById('studentSelector').value = ""; // Ø³Ù„Ú©Ù¼ÙˆØ± Ø®Ø§Ù„ÙŠ Ú©Ú“Ù‡
        } catch (error) {
            alert("âŒ Ø®Ø·Ø§: " + error.message);
        } finally {
            btn.disabled = false; btn.innerText = "ğŸ’¾ Ú‰ÛŒÙ¼Ø§ Ù¾Ù‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ú©Û Ø°Ø®ÛŒØ±Ù‡ Ú©Ú“Ù‡";
        }
    }

    window.onload = loadStudents;
</script>
</body>
</html>
