<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ ÚšÙˆÙˆÙ†Ú©ÙŠ Ù‡ÙˆÚšÛŒØ§Ø± Ú‰Ø´Ø¨ÙˆØ±Ú‰ - Ø¨Ø§Ø¨Ø§ Ù‡ÙˆØªÚ©</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        :root { 
            --main-blue: #004d99; 
            --present: #27ae60; 
            --absent: #e74c3c; 
            --leave: #f1c40f; 
            --sick: #e67e22; 
            --whatsapp: #25D366; 
            --sms-btn: #f39c12;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 10px; direction: rtl; }
        .container { max-width: 800px; margin: auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 2px solid var(--main-blue); margin-bottom: 15px; padding-bottom: 10px; }
        
        .bulk-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-bulk { padding: 12px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; font-size: 14px; }

        .student-card { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .student-name { font-weight: bold; font-size: 17px; margin-bottom: 10px; display: block; color: #333; }
        
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .btn-status { width: 100%; height: 45px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: bold; background: white; }
        
        .active-p { background: var(--present) !important; color: white; border: none; }
        .active-a { background: var(--absent) !important; color: white; border: none; }
        .active-l { background: var(--leave) !important; color: white; border: none; }
        .active-s { background: var(--sick) !important; color: white; border: none; }

        .action-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .btn-comm { border: none; padding: 10px; border-radius: 8px; color: white; font-size: 12px; cursor: pointer; text-decoration: none; text-align: center; font-weight: bold; }

        .save-btn { width: 100%; padding: 18px; background: var(--main-blue); color: white; border: none; border-radius: 15px; font-size: 18px; cursor: pointer; margin-top: 20px; font-weight: bold; }
        
        /* Modal Style */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; padding:10px; box-sizing: border-box; }
        .modal-content { background:white; width:100%; max-width:1150px; margin:auto; border-radius:15px; padding:15px; height: 90vh; overflow-y: auto; position: relative; }
        
        .report-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        
        /* Table Style */
        .table-wrapper { overflow-x: auto; border: 1px solid #ddd; }
        table { width:100%; border-collapse: collapse; font-size: 12px; min-width: 800px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: var(--main-blue); color: white; position: sticky; top: 0; }
        .p-cell { background: #d4edda; color: #155724; font-weight: bold; }
        .a-cell { background: #f8d7da; color: #721c24; font-weight: bold; }
        .l-cell { background: #fff3cd; color: #856404; }
        .s-cell { background: #ffeeba; color: #856404; }
        .name-col { text-align: right; font-weight: bold; position: sticky; right: 0; background: white; z-index: 10; border-left: 2px solid var(--main-blue); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 id="displayTitle" style="margin:0;">ğŸ“ Ø¯ ØµÙ†Ù Ú‰Ø´Ø¨ÙˆØ±Ú‰</h2>
        <p id="todayDate" style="color:var(--main-blue); font-weight:bold; margin: 5px 0;"></p>
        <button onclick="openReportModal()" style="background:#8e24aa; color:white; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:bold;">ğŸ“Š Ù…ÛŒØ§Ø´ØªÙ†ÛŒ Ø±Ø§Ù¾ÙˆØ±</button>
    </div>

    <div class="bulk-actions">
        <button class="btn-bulk" style="background:var(--present);" onclick="setAllStatus('present')">âœ… Ù¼ÙˆÙ„ Ø­Ø§Ø¶Ø± Ú©Ú“Ø¦</button>
        <button class="btn-bulk" style="background:var(--absent);" onclick="setAllStatus('absent')">âŒ Ù¼ÙˆÙ„ ØºÛŒØ±Ø­Ø§Ø¶Ø± Ú©Ú“Ø¦</button>
    </div>

    <div id="studentList">
        <p style="text-align:center; padding:20px;">Ø¯ Ø´Ø§Ú«Ø±Ø¯Ø§Ù†Ùˆ Ù„ÛŒØ³Øª Ù„ÙˆÚ‰ Ú©ÛÚ–ÙŠ...</p>
    </div>

    <button class="save-btn" onclick="saveAttendance()">âœ… Ù†Ù†Ù†Û Ø­Ø§Ø¶Ø±ÙŠ Ø«Ø¨Øª Ú©Ú“Ø¦</button>
</div>

<div id="reportModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 id="reportModalTitle" style="margin:0;">ğŸ“… Ù…ÛŒØ§Ø´ØªÙ†ÛŒ Ø±Ø§Ù¾ÙˆØ±</h3>
            <button onclick="closeReport()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">ØªÚ“Ù„ âœ•</button>
        </div>

        <div class="report-controls">
            <span>Ù…ÛŒØ§Ø´Øª:</span>
            <select id="monthSelect">
                <option value="01">Ø­Ù…Ù„</option><option value="02">Ø«ÙˆØ±</option><option value="03">Ø¬ÙˆØ²Ø§</option>
                <option value="04">Ø³Ø±Ø·Ø§Ù†</option><option value="05">Ø§Ø³Ø¯</option><option value="06">Ø³Ù†Ø¨Ù„Ù‡</option>
                <option value="07">Ù…ÛŒØ²Ø§Ù†</option><option value="08">Ø¹Ù‚Ø±Ø¨</option><option value="09">Ù‚ÙˆØ³</option>
                <option value="10" selected>Ø¬Ø¯ÙŠ</option><option value="11">Ø¯Ù„Ùˆ</option><option value="12">Ø­ÙˆØª</option>
            </select>
            <span>Ú©Ø§Ù„:</span>
            <select id="yearSelect">
                <option value="1403">Û±Û´Û°Û³</option><option value="1404" selected>Û±Û´Û°Û´</option><option value="1405">Û±Û´Û°Ûµ</option>
            </select>
            <button onclick="fetchMonthlyReport()" style="background:var(--main-blue); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Ø±Ø§Ù¾ÙˆØ± Ø±Ø§ÙˆÚ“Ø¦</button>
        </div>

        <div class="table-wrapper">
            <table id="reportTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
    projectId: "babahotakschool",
    appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentClass = ""; 
let currentSection = "";
let attendanceData = {};
let studentsInfo = {}; 
let studentIDs = [];

// Load Students Data
async function loadStudents() {
    const listDiv = document.getElementById('studentList');
    const teacherId = localStorage.getItem('userId');
    if (!teacherId) { alert("Ù„Ø·ÙØ§Ù‹ Ù„ÙˆÙ…Ú“ÛŒ Ù†Ù†ÙˆÚØ¦!"); return; }

    const options = { year: 'numeric', month: 'long', day: 'numeric', calendar: 'persian' };
    document.getElementById('todayDate').innerText = new Intl.DateTimeFormat('ps-AF-u-ca-persian', options).format(new Date());

    try {
        const tDoc = await db.collection("babaTeachers").doc(teacherId).get();
        if (!tDoc.exists) return;

        const tData = tDoc.data();
        currentClass = tData.grade;
        currentSection = (tData.section || "").split(' ')[0];

        document.getElementById('displayTitle').innerText = `ğŸ“ Ø¯ ${currentClass} (${tData.section}) Ú‰Ø´Ø¨ÙˆØ±Ú‰`;
        document.getElementById('reportModalTitle').innerText = `ğŸ“… Ù…ÛŒØ§Ø´ØªÙ†ÛŒ Ø±Ø§Ù¾ÙˆØ± (${currentClass} ${currentSection})`;

        const snap = await db.collection("babaStudents")
            .where("grade", "==", currentClass)
            .where("section", "==", currentSection)
            .get();

        if (snap.empty) {
            listDiv.innerHTML = "<p style='text-align:center;color:red;'>Ù‡ÛŒÚ… Ø´Ø§Ú«Ø±Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ùˆ!</p>";
            return;
        }

        listDiv.innerHTML = ""; studentIDs = [];
        snap.forEach(doc => {
            let s = doc.data();
            studentIDs.push(doc.id);
            attendanceData[doc.id] = 'present';
            studentsInfo[doc.id] = { name: s.name, father: s.fname || s.father || '---', phone: s.phone };

            listDiv.innerHTML += `
                <div class="student-card">
                    <span class="student-name">${s.name} <small>(Ø¯ ${studentsInfo[doc.id].father} Ø²ÙˆÛŒ)</small></span>
                    <div class="status-grid" id="btns-${doc.id}">
                        <button class="btn-status active-p" data-status="present" onclick="setStatus('${doc.id}', 'present', this)">Ø­Ø§Ø¶Ø±</button>
                        <button class="btn-status" data-status="absent" onclick="setStatus('${doc.id}', 'absent', this)">ØºÛŒØ±Ø­Ø§Ø¶Ø±</button>
                        <button class="btn-status" data-status="leave" onclick="setStatus('${doc.id}', 'leave', this)">Ø±Ø®ØµØª</button>
                        <button class="btn-status" data-status="sick" onclick="setStatus('${doc.id}', 'sick', this)">Ù†Ø§Ø±ÙˆØº</button>
                    </div>
                    <div class="action-btns">
                        <button class="btn-comm" style="background:var(--whatsapp);" onclick="window.open('https://wa.me/${s.phone}')">WA</button>
                        <button class="btn-comm" style="background:var(--sms-btn);" onclick="sendSMS('${doc.id}')">SMS</button>
                        <a href="tel:${s.phone}" class="btn-comm" style="background:#546e7a;">Ø§Ú“ÛŒÚ©Ù‡</a>
                    </div>
                </div>`;
        });
    } catch (e) { listDiv.innerHTML = "ØªÛØ±ÙˆØªÙ†Ù‡: " + e.message; }
}

function setStatus(id, status, btn) {
    attendanceData[id] = status;
    const parent = document.getElementById(`btns-${id}`);
    Array.from(parent.children).forEach(b => b.className = 'btn-status');
    btn.className = `btn-status active-${status.charAt(0)}`;
}

function setAllStatus(status) {
    studentIDs.forEach(id => {
        const parent = document.getElementById(`btns-${id}`);
        const btn = parent.querySelector(`button[data-status="${status}"]`);
        setStatus(id, status, btn);
    });
}

function sendSMS(id) {
    const s = studentsInfo[id];
    const status = attendanceData[id];
    if (status === 'present') { alert("Ø­Ø§Ø¶Ø± Ø´Ø§Ú«Ø±Ø¯ ØªÙ‡ Ø§Ú“ØªÛŒØ§ Ù†Ø´ØªÙ‡."); return; }
    let text = (status === 'absent') ? "ØºÛŒØ±Ø­Ø§Ø¶Ø±" : "Ø±Ø®ØµØª/Ù†Ø§Ø±ÙˆØº";
    let message = `Ù…Ø­ØªØ±Ù… Ø³ØªØ§Ø³Ùˆ Ø¯ (${s.name}) Ø²ÙˆÛŒ Ù†Ù† ÚšÙˆÙˆÙ†ÚÙŠ Ú©Û ${text} Ø¯ÛŒ.`;
    window.location.href = `sms:${s.phone}?body=${encodeURIComponent(message)}`;
}

async function saveAttendance() {
    const iso = new Date().toISOString().split('T')[0];
    const shamsiDate = new Intl.DateTimeFormat('en-u-ca-persian', {year:'numeric', month:'2-digit', day:'2-digit'}).format(new Date());
    const cleanShamsi = shamsiDate.replace(/[\u200E\u200F]/g, ''); 

    try {
        for (const [id, status] of Object.entries(attendanceData)) {
            await db.collection("babaAttendance").doc(`${id}_${iso}`).set({
                studentId: id, status: status, date: iso, shamsiDate: cleanShamsi, class: currentClass, section: currentSection
            });
        }
        alert("âœ… Ø­Ø§Ø¶Ø±ÙŠ Ù¾Ù‡ Ø¨Ø±ÛŒØ§Ù„ÛŒØªÙˆØ¨ Ø³Ø±Ù‡ Ø«Ø¨Øª Ø´ÙˆÙ‡!");
    } catch (e) { alert("ØªÛØ±ÙˆØªÙ†Ù‡: " + e.message); }
}

// Report Logic
function openReportModal() { 
    document.getElementById('reportModal').style.display = 'block'; 
    fetchMonthlyReport(); 
}

function closeReport() { 
    document.getElementById('reportModal').style.display = 'none'; 
}

async function fetchMonthlyReport() {
    const body = document.getElementById('tableBody');
    const head = document.getElementById('tableHead');
    const m = document.getElementById('monthSelect').value;
    const y = document.getElementById('yearSelect').value;
    
    body.innerHTML = "<tr><td colspan='35'>Ú‰Ø§Ù¼Ø§ Ù„ÙˆÚ‰ÛÚ–ÙŠ...</td></tr>";

    try {
        // Û±. Ø¯ Ø´Ø§Ú«Ø±Ø¯Ø§Ù†Ùˆ Ù„ÛŒØ³Øª Ø±Ø§ÙˆÚ“Ù„
        const sSnap = await db.collection("babaStudents")
            .where("grade", "==", currentClass)
            .where("section", "==", currentSection)
            .get();
        
        let sMap = {}; 
        sSnap.forEach(d => sMap[d.id] = d.data().name);

        // Û². Ø¯ Ø­Ø§Ø¶Ø±Û Ú‰Ø§Ù¼Ø§ Ø±Ø§ÙˆÚ“Ù„
        const aSnap = await db.collection("babaAttendance")
            .where("class", "==", currentClass)
            .where("section", "==", currentSection)
            .get();

        let report = {};
        aSnap.forEach(d => {
            const data = d.data();
            if(data.shamsiDate) {
                let cleanDate = data.shamsiDate.replace(/[\u200E\u200F]/g, '').trim();
                let parts = cleanDate.split('/'); 
                
                let dbY = parts[0].length === 4 ? parts[0] : parts[2];
                let dbM = parts[0].length === 4 ? parts[1] : parts[0];
                let dbD = parts[0].length === 4 ? parts[2] : parts[1];

                if(parseInt(dbY) == parseInt(y) && parseInt(dbM) == parseInt(m)) {
                    if(!report[data.studentId]) report[data.studentId] = {};
                    report[data.studentId][parseInt(dbD)] = data.status;
                }
            }
        });

        // Û³. Ø¯ Ø¬Ø¯ÙˆÙ„ Ø³Ø± (Days 1 to 31)
        let headHTML = "<tr><th class='name-col'>Ø¯ Ø´Ø§Ú«Ø±Ø¯ Ù†ÙˆÙ…</th>";
        for(let i=1; i<=31; i++) headHTML += `<th>${i}</th>`;
        head.innerHTML = headHTML + "</tr>";

        // Û´. Ø¯ Ø¬Ø¯ÙˆÙ„ Ú‰Ø§Ù¼Ø§
        let bodyHTML = "";
        Object.keys(sMap).forEach(id => {
            bodyHTML += `<tr><td class="name-col">${sMap[id]}</td>`;
            for(let i=1; i<=31; i++) {
                const stat = report[id] ? report[id][i] : '';
                let sym = '', cls = '';
                if(stat === 'present') { sym = 'Ø­'; cls = 'p-cell'; }
                else if(stat === 'absent') { sym = 'Øº'; cls = 'a-cell'; }
                else if(stat === 'leave') { sym = 'Ø±'; cls = 'l-cell'; }
                else if(stat === 'sick') { sym = 'Ù†'; cls = 's-cell'; }
                bodyHTML += `<td class="${cls}">${sym}</td>`;
            }
            bodyHTML += "</tr>";
        });
        
        body.innerHTML = bodyHTML || "<tr><td colspan='35'>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´ÙˆÙ„.</td></tr>";
    } catch (e) { body.innerHTML = "ØªÛØ±ÙˆØªÙ†Ù‡: " + e.message; }
}

window.onload = loadStudents;
</script>
</body>
</html>
