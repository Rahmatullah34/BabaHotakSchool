<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ Ù†ØªØ§ÛŒØ¬Ùˆ Ø¹Ù…ÙˆÙ…ÙŠ Ù†Ø¸Ø§Ø±Øª - Ù…Ø¯ÛŒØ±</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 10px; direction: rtl; }
        .admin-card { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); max-width: 800px; margin: auto; }
        
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { padding: 20px 10px; border-radius: 15px; text-align: center; color: white; font-weight: bold; }
        .passed { background: #2ecc71; }
        .failed { background: #e74c3c; }
        .finished { background: #f39c12; }
        .stat-box h2 { margin: 0; font-size: 24px; }
        .stat-box p { margin: 5px 0 0; font-size: 12px; }

        .filter-group { display: flex; gap: 10px; margin-bottom: 15px; }
        select { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; font-size: 14px; outline: none; background: #f9f9f9; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 10px; overflow: hidden; }
        th { background: #34495e; color: white; padding: 12px; text-align: center; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-size: 13px; }
        
        .btn-view { background: #3498db; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 18px; }
        .no-data { text-align: center; padding: 30px; color: #7f8c8d; font-size: 14px; }

        #transcriptModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y:auto; }
        .modal-content { background:white; width:95%; max-width:500px; margin:30px auto; padding:20px; border-radius:20px; position:relative; }
        .close-btn { position:absolute; left:20px; top:15px; font-size:30px; cursor:pointer; color: #e74c3c; font-weight: bold; }
        
        .transcript-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .transcript-table th, .transcript-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .transcript-table th { background: #f8f9fa; }

        @media print {
            body * { visibility: hidden; }
            #transcriptModal, #transcriptModal * { visibility: visible; }
            #transcriptModal { position: absolute; left: 0; top: 0; width: 100%; background: white; }
            .close-btn, .btn-print-modal { display: none; }
        }
    </style>
</head>
<body>

<div class="admin-card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0;">ğŸ“Š Ø¯ Ù†ØªØ§ÛŒØ¬Ùˆ Ø¯ Ú…Ø§Ø±Ù†Û Ù…Ø±Ú©Ø²</h3>
        <button onclick="window.history.back()" style="border:none; background:#eee; padding:8px 15px; border-radius:10px; cursor:pointer; font-weight:bold;">Ø´Ø§ØªÙ‡ â¬…ï¸</button>
    </div>

    <div class="stats-row">
        <div class="stat-box passed"><h2 id="totalPassed">0</h2><p>Ú©Ø§Ù…ÛŒØ§Ø¨ Ø´Ø§Ú«Ø±Ø¯Ø§Ù†</p></div>
        <div class="stat-box failed"><h2 id="totalFailed">0</h2><p>Ù†Ø§Ú©Ø§Ù… Ø´Ø§Ú«Ø±Ø¯Ø§Ù†</p></div>
        <div class="stat-box finished"><h2 id="totalFinished">0</h2><p>Ø¨Ø´Ù¾Ú“ Ø´ÙˆÙŠ ØµÙ†ÙÙˆÙ†Ù‡</p></div>
    </div>

    <div class="filter-group">
        <select id="classFilter" onchange="loadAdminResults()">
            <option value="">Ù¼ÙˆÙ„Ú«ÛŒ ÙˆÙ¼Ø§Ú©Ø¦</option>
            <option value="Ù„ÙˆÙ…Ú“ÛŒ">Ù„ÙˆÙ…Ú“ÛŒ</option>
            <option value="Ø¯ÙˆÙ‡Ù…">Ø¯ÙˆÙ‡Ù…</option>
            <option value="Ø¯Ø±ÛŒÙ…">Ø¯Ø±ÛŒÙ…</option>
            <option value="Ú…Ù„ÙˆØ±Ù…">Ú…Ù„ÙˆØ±Ù…</option>
            <option value="Ù¾Ù†ÚÙ…">Ù¾Ù†ÚÙ…</option>
            <option value="Ø´Ù¾Ú–Ù…">Ø´Ù¾Ú–Ù…</option>
            <option value="Ø§ÙˆÙˆÙ…">Ø§ÙˆÙˆÙ…</option>
            <option value="Ø§ØªÙ…">Ø§ØªÙ…</option>
            <option value="Ù†Ù‡Ù…">Ù†Ù‡Ù…</option>
            <option value="Ù„Ø³Ù…">Ù„Ø³Ù…</option>
            <option value="ÛŒÙˆÙˆÙ„Ø³Ù…">ÛŒÙˆÙˆÙ„Ø³Ù…</option>
            <option value="Ø¯ÙˆÙ„Ø³Ù…">Ø¯ÙˆÙ„Ø³Ù…</option>
        </select>
        <select id="sectionFilter" onchange="loadAdminResults()">
            <option value="Ø§Ù„Ù">Ø§Ù„Ù (A)</option>
            <option value="Ø¨">Ø¨ (B)</option>
            <option value="Ø¬">Ø¬ (C)</option>
        </select>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø´Ø§Ú«Ø±Ø¯</th>
                <th>Ù¼ÙˆÙ„Û Ù†Ù…Ø±Û</th>
                <th>Ø³Ù„Ù†Ù‡</th>
                <th>Ù†ØªÛŒØ¬Ù‡</th>
                <th>Ù¾Ø§Ø±Ú†Ù‡</th>
            </tr>
        </thead>
        <tbody id="adminResTableBody">
            <tr><td colspan="5" class="no-data">Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙˆ Ù„ÛŒØ¯Ù„Ùˆ Ù„Ù¾Ø§Ø±Ù‡ Ù¼ÙˆÙ„Ú«ÛŒ Ø§Ùˆ Ø´Ø¹Ø¨Ù‡ ÙˆÙ¼Ø§Ú©Ø¦.</td></tr>
        </tbody>
    </table>
</div>

<div id="transcriptModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 style="text-align:center; border-bottom:2px solid #27ae60; padding-bottom:10px; color: #27ae60;">ğŸ“‹ Ø¯ Ø´Ø§Ú«Ø±Ø¯ Ø±Ø³Ù…ÙŠ Ù¾Ø§Ø±Ú†Ù‡</h3>
        <div id="transcriptContent"></div>
        <button class="btn-print-modal" onclick="window.print()" style="width:100%; padding:15px; background:#27ae60; color:white; border:none; border-radius:10px; margin-top:20px; cursor:pointer; font-weight:bold; font-size: 16px;">ğŸ–¨ï¸ Ø¯ Ù¾Ø§Ø±Ú†Û Ú†Ø§Ù¾ÙˆÙ„</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB1SSjuFWV0Fjnpm6bjbK-6r-5qNdZPQsM",
        projectId: "babahotakschool",
        appId: "1:12958892996:web:477e44b4453a0fbd9b9a91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadAdminResults() {
        const grade = document.getElementById('classFilter').value;
        const section = document.getElementById('sectionFilter').value;
        const tbody = document.getElementById('adminResTableBody');

        if(!grade || !section) return;

        tbody.innerHTML = "<tr><td colspan='5' class='no-data'>Ú‰ÛŒÙ¼Ø§ Ø±Ø§ÙˆØ³ØªÙ„ Ú©ÛÚ–ÙŠ... â³</td></tr>";

        try {
            const studentSnap = await db.collection("babaStudents")
                .where("grade", "==", grade)
                .where("section", "==", section)
                .get();

            let passed = 0, failed = 0, html = "", found = false;

            for (const studentDoc of studentSnap.docs) {
                const studentId = studentDoc.id;
                const studentData = studentDoc.data();
                const marksDoc = await db.collection("studentMarks").doc(studentId).get();

                if (marksDoc.exists) {
                    found = true;
                    const marksData = marksDoc.data();
                    const summary = marksData.summary || {};
                    
                    const name = studentData.name || "Ø¨Û Ù†ÙˆÙ…Ù‡";
                    const total = summary.fin_sum || summary.mid_sum || 0;
                    const avg = parseFloat(summary.fin_avg || summary.mid_avg || 0).toFixed(1);
                    const status = summary.final_status || (avg >= 50 ? "Ú©Ø§Ù…ÛŒØ§Ø¨" : "Ù†Ø§Ú©Ø§Ù…");

                    if(avg >= 50 && status !== "Ù…Ø­Ø±ÙˆÙ…") passed++; else failed++;

                    html += `
                        <tr>
                            <td><b>${name}</b></td>
                            <td>${total}</td>
                            <td style="font-weight:bold;">${avg}%</td>
                            <td><span style="color:${(avg >= 50 && status !== 'Ù…Ø­Ø±ÙˆÙ…') ? '#2ecc71' : '#e74c3c'}; font-weight:bold;">${status}</span></td>
                            <td><button class="btn-view" onclick="viewTranscript('${studentId}')">ğŸ‘ï¸</button></td>
                        </tr>`;
                }
            }

            tbody.innerHTML = found ? html : "<tr><td colspan='5' class='no-data'>Ù¾Ø§ÛŒÙ„Û Ù¾ÛŒØ¯Ø§ Ù†Ù‡ Ø´ÙˆÛ.</td></tr>";
            updateStats(passed, failed);

        } catch (e) {
            console.error(e);
            tbody.innerHTML = "<tr><td colspan='5' class='no-data' style='color:red;'>Ú‰ÛŒÙ¼Ø§ Ù„ÙˆÚ‰ Ù†Ù‡ Ø´ÙˆÙ‡!</td></tr>";
        }
    }

    async function viewTranscript(id) {
        const modal = document.getElementById('transcriptModal');
        const content = document.getElementById('transcriptContent');
        modal.style.display = "block";
        content.innerHTML = "<p style='text-align:center;'>Ù„ÙˆÚ‰ Ú©ÛÚ–ÙŠ... â³</p>";

        try {
            const doc = await db.collection("studentMarks").doc(id).get();
            const studentDoc = await db.collection("babaStudents").doc(id).get();
            
            const data = doc.data();
            const sData = studentDoc.data();
            const marks = data.marks || {};
            const summary = data.summary || {};

            let tableHtml = `
                <div style="background:#f1f8f5; padding:15px; border-radius:10px; margin-bottom:15px; font-size:14px; border: 1px solid #27ae60;">
                    <p style="margin:5px 0;"><b>Ù†ÙˆÙ…:</b> ${sData.name} | <b>Ù¾Ù„Ø§Ø±:</b> ${sData.fname || sData.father || '---'}</p>
                    <p style="margin:5px 0;"><b>Ø§Ø³Ø§Ø³ Ù†Ù…Ø¨Ø±:</b> ${sData.id || id} | <b>Ù¼ÙˆÙ„Ú«ÛŒ:</b> ${sData.grade} (${sData.section})</p>
                </div>
                <table class="transcript-table">
                    <thead>
                        <tr>
                            <th>Ù…Ø¶Ù…ÙˆÙ†</th>
                            <th>Û´.Ûµ Ù†Ù…Ø±Û</th>
                            <th>Ú©Ù„Ù†Û Ù†Ù…Ø±Û</th>
                            <th>Ù…Ø¬Ù…ÙˆØ¹Ù‡</th>
                        </tr>
                    </thead>
                    <tbody>`;

            for (let sub in marks) {
                tableHtml += `
                    <tr>
                        <td style="text-align:right; font-weight:bold;">${sub}</td>
                        <td>${marks[sub].m45 || '0'}</td>
                        <td>${marks[sub].mAn || '0'}</td>
                        <td style="color:#1565c0; font-weight:bold;">${marks[sub].total || '0'}</td>
                    </tr>`;
            }

            tableHtml += `</tbody></table>
                <div style="margin-top:20px; padding:15px; background:#27ae60; color:white; border-radius:10px; text-align:center;">
                    <span style="font-size:16px;"><b>Ù¼ÙˆÙ„Û Ù†Ù…Ø±Û: ${summary.fin_sum || 0}</b></span><br>
                    <span style="font-size:14px;">Ø§ÙˆØ³Ø·: ${summary.fin_avg || 0}% | Ù¾Ø§ÛŒÙ„Ù‡: ${summary.final_status || '---'}</span>
                </div>`;

            content.innerHTML = tableHtml;
        } catch (e) {
            content.innerHTML = "<p style='color:red;'>Ø¯ Ù¾Ø§Ø±Ú†Û Ù„ÙˆÚ‰ÙˆÙ„Ùˆ Ú©Û Ø®Ø·Ø§ ÙˆØ´ÙˆÙ‡!</p>";
        }
    }

    function closeModal() { document.getElementById('transcriptModal').style.display = "none"; }
    
    function updateStats(p, f) {
        document.getElementById('totalPassed').innerText = p;
        document.getElementById('totalFailed').innerText = f;
        document.getElementById('totalFinished').innerText = (p + f > 0) ? "1" : "0";
    }

    window.onclick = function(event) {
        let modal = document.getElementById('transcriptModal');
        if (event.target == modal) closeModal();
    }
</script>

</body>
</html>
